<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Super Bowl LX Squares</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #060614;
            --bg-secondary: #0e0e24;
            --bg-tertiary: #161636;
            --bg-card: #121230;
            --text-primary: #e8e6e3;
            --text-secondary: #9090b0;
            --text-muted: #5a5a7a;
            --pats-blue: #002244;
            --pats-red: #C60C30;
            --pats-silver: #B0B7BC;
            --hawks-blue: #002244;
            --hawks-green: #69BE28;
            --hawks-grey: #A5ACAF;
            --gold: #FFB612;
            --gold-dim: #b8860b;
            --success: #22c55e;
            --danger: #ef4444;
            --accent: #667eea;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ Stadium Atmosphere Background (static) ‚îÄ‚îÄ */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                /* Upper stadium lights - static warm glow */
                radial-gradient(ellipse at 15% 0%, rgba(255,200,60,0.12) 0%, transparent 40%),
                radial-gradient(ellipse at 85% 0%, rgba(255,200,60,0.10) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 0%, rgba(255,220,120,0.08) 0%, transparent 35%),
                /* Team color zones */
                radial-gradient(ellipse at 5% 50%, rgba(0, 34, 68, 0.55) 0%, transparent 50%),
                radial-gradient(ellipse at 95% 50%, rgba(0, 34, 68, 0.35) 0%, transparent 50%),
                radial-gradient(ellipse at 95% 55%, rgba(105, 190, 40, 0.18) 0%, transparent 45%),
                /* Field green undertone at bottom */
                radial-gradient(ellipse at 50% 100%, rgba(30, 80, 30, 0.15) 0%, transparent 50%),
                /* Center vignette */
                radial-gradient(ellipse at 50% 50%, transparent 30%, rgba(0,0,0,0.4) 100%);
            pointer-events: none;
            z-index: 0;
        }
        /* Subtle field yard lines */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background:
                repeating-linear-gradient(90deg, transparent, transparent 9.7%, rgba(255,255,255,0.025) 9.7%, rgba(255,255,255,0.025) 10.3%);
            pointer-events: none;
            z-index: 0;
        }
        .app-container {
            position: relative; z-index: 1;
            max-width: 820px; margin: 0 auto; padding: 12px 12px 40px;
        }

        /* ‚îÄ‚îÄ Header with Logos ‚îÄ‚îÄ */
        .header { text-align: center; padding: 16px 0 12px; position: relative; }
        .sb-logo {
            width: 64px; height: 64px; margin: 0 auto 6px;
            background: linear-gradient(135deg, var(--gold), #fff8dc, var(--gold));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(255,182,18,0.3), 0 0 60px rgba(255,182,18,0.1);
            animation: logoPulse 3s ease-in-out infinite;
        }
        @keyframes logoPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(255,182,18,0.3), 0 0 60px rgba(255,182,18,0.1); }
            50% { box-shadow: 0 0 40px rgba(255,182,18,0.5), 0 0 80px rgba(255,182,18,0.2); }
        }
        .sb-logo svg { width: 38px; height: 38px; }
        .header h1 {
            font-family: 'Bebas Neue', sans-serif; font-size: 2.4rem; letter-spacing: 4px;
            background: linear-gradient(135deg, var(--gold), #fff8dc, var(--gold), #fff8dc);
            background-size: 200% 100%;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1;
            animation: shimmer 3s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .header .subtitle {
            font-size: 0.78rem; color: var(--text-secondary); margin-top: 2px;
            letter-spacing: 2px; text-transform: uppercase;
        }
        .header .matchup {
            display: flex; align-items: center; justify-content: center; gap: 16px;
            margin-top: 14px; font-family: 'Bebas Neue', sans-serif;
        }
        .team-logo-wrap {
            display: flex; align-items: center; gap: 10px;
        }
        .team-logo {
            width: 44px; height: 44px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.4);
            flex-shrink: 0;
        }
        .team-logo.pats-logo {
            background: linear-gradient(145deg, #002244, #003366);
            border: 2px solid rgba(176,183,188,0.3);
        }
        .team-logo.hawks-logo {
            background: linear-gradient(145deg, #002244, #003060);
            border: 2px solid rgba(105,190,40,0.3);
        }
        .team-logo svg { width: 28px; height: 28px; }
        .team-name {
            font-size: 1.5rem; letter-spacing: 3px;
        }
        .team-pats { color: var(--pats-silver); }
        .team-hawks { color: var(--hawks-green); }
        .vs-badge {
            background: linear-gradient(135deg, rgba(255,182,18,0.2), rgba(255,182,18,0.05));
            border: 1px solid rgba(255,182,18,0.3);
            border-radius: 50%; width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Bebas Neue', sans-serif; font-size: 0.85rem;
            color: var(--gold); letter-spacing: 1px; flex-shrink: 0;
        }
        .user-bar { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 12px; font-size: 0.82rem; color: var(--text-secondary); }
        .user-bar img { width: 24px; height: 24px; border-radius: 50%; }
        .user-bar .badge { background: var(--bg-tertiary); border-radius: 4px; padding: 2px 8px; font-weight: 700; font-size: 0.75rem; letter-spacing: 1px; color: var(--accent); }
        .sign-out-btn { background: none; border: 1px solid rgba(255,255,255,0.15); color: var(--text-secondary); padding: 4px 10px; border-radius: 6px; font-size: 0.72rem; cursor: pointer; font-family: 'Outfit', sans-serif; }

        /* ‚îÄ‚îÄ Auth ‚îÄ‚îÄ */
        .auth-section { text-align: center; padding: 60px 20px; }
        .auth-section h2 { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 2px; margin-bottom: 8px; }
        .auth-section p { color: var(--text-secondary); margin-bottom: 28px; font-size: 0.9rem; }
        .google-btn { display: inline-flex; align-items: center; gap: 12px; background: white; color: #333; border: none; border-radius: 8px; padding: 14px 32px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; font-family: 'Outfit', sans-serif; }
        .google-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,255,255,0.12); }
        .google-btn svg { width: 20px; height: 20px; }

        /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
        .tab-nav {
            display: flex; background: var(--bg-secondary); border-radius: 10px; padding: 3px; margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .tab-btn { flex: 1; padding: 10px 6px; border: none; background: transparent; color: var(--text-secondary); font-family: 'Outfit', sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.2s; }
        .tab-btn.active { background: linear-gradient(135deg, rgba(255,182,18,0.15), rgba(255,182,18,0.05)); color: var(--gold); border: 1px solid rgba(255,182,18,0.2); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ Overlay ‚îÄ‚îÄ */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 9999; animation: fadeIn 0.2s; backdrop-filter: blur(4px); }
        .overlay-card {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
            border: 1px solid rgba(255,182,18,0.15); border-radius: 16px; padding: 28px;
            width: 92%; max-width: 380px; animation: slideUp 0.3s ease-out;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .overlay-card h2 { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 2px; margin-bottom: 4px; color: var(--gold); }
        .overlay-card .sub { color: var(--text-secondary); font-size: 0.82rem; margin-bottom: 18px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 11px 12px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text-primary); font-family: 'Outfit', sans-serif; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 2px rgba(255,182,18,0.1); }
        .form-group .helper { font-size: 0.72rem; color: var(--text-muted); margin-top: 3px; }
        .form-group .error-text { font-size: 0.72rem; color: var(--danger); margin-top: 3px; display: none; }
        .btn-gold { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #1a1a1a; border: none; border-radius: 8px; padding: 13px 24px; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 0.95rem; cursor: pointer; width: 100%; transition: transform 0.1s, box-shadow 0.1s; margin-top: 4px; }
        .btn-gold:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(255,182,18,0.3); }
        .btn-gold:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
        .grid-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.82rem; color: var(--text-secondary); }
        .grid-info .boxes-left { color: var(--gold); font-weight: 600; }
        .grid-container { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 6px; }
        .team-label-top {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 3px;
            color: var(--pats-silver); margin-bottom: 6px; padding-left: 56px;
        }
        .team-label-top .mini-logo { width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .team-label-top .mini-logo.pats { background: var(--pats-blue); }
        .team-label-top .mini-logo svg { width: 13px; height: 13px; }
        .grid-outer { display: inline-flex; align-items: stretch; min-width: 100%; }
        .team-label-side {
            writing-mode: vertical-lr; transform: rotate(180deg);
            font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 3px;
            color: var(--hawks-green); display: flex; align-items: center; justify-content: center;
            padding-right: 6px; min-width: 24px; gap: 6px;
        }
        .squares-grid { border-collapse: separate; border-spacing: 2px; flex: 1; }
        .squares-grid th { font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; letter-spacing: 1px; }
        .squares-grid th, .squares-grid td { width: 48px; height: 42px; text-align: center; vertical-align: middle; }
        .squares-grid .corner-cell {
            background: linear-gradient(135deg, rgba(255,182,18,0.1), transparent);
            border-radius: 4px; position: relative;
        }
        .squares-grid .corner-cell::after {
            content: 'üèà'; font-size: 1rem; position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .squares-grid .col-header {
            background: linear-gradient(180deg, #002244, #001a33); color: var(--pats-silver);
            border-radius: 4px; min-width: 42px;
            border-bottom: 2px solid rgba(198,12,48,0.4);
        }
        .squares-grid .col-header.has-number { background: linear-gradient(180deg, #003366, #002244); color: white; border-bottom-color: rgba(198,12,48,0.6); }
        .squares-grid .row-header {
            background: linear-gradient(90deg, #0d2d1a, #0a2214); color: var(--hawks-green);
            border-radius: 4px; padding: 0 6px; min-width: 42px;
            border-right: 2px solid rgba(105,190,40,0.3);
        }
        .squares-grid .row-header.has-number { background: linear-gradient(90deg, #1a4c2a, #0d3d1a); color: white; border-right-color: rgba(105,190,40,0.5); }

        /* ‚îÄ‚îÄ Cells ‚îÄ‚îÄ */
        .squares-grid td.cell { border-radius: 3px; cursor: default; transition: all 0.15s; font-weight: 700; font-size: 0.72rem; position: relative; }
        .squares-grid td.cell.empty {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.07);
        }
        .squares-grid td.cell.taken {
            background: linear-gradient(135deg, rgba(30,30,60,0.8), rgba(20,20,50,0.8));
            color: var(--text-secondary); border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .squares-grid td.cell.mine {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.35), rgba(102, 126, 234, 0.2));
            color: #a0baff; border: 1px solid rgba(102, 126, 234, 0.4);
            box-shadow: inset 0 0 6px rgba(102,126,234,0.15);
        }
        .squares-grid td.cell.winner-cell {
            background: linear-gradient(135deg, rgba(255, 182, 18, 0.4), rgba(255, 182, 18, 0.2)) !important;
            color: var(--gold) !important;
            border: 1px solid rgba(255, 182, 18, 0.5) !important;
            animation: winPulse 2s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(255,182,18,0.2);
        }
        @keyframes winPulse { 0%, 100% { box-shadow: 0 0 4px rgba(255,182,18,0.1); } 50% { box-shadow: 0 0 12px rgba(255,182,18,0.35); } }

        /* ‚îÄ‚îÄ Manual Selection Mode ‚îÄ‚îÄ */
        .select-banner {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.15));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
            animation: fadeIn 0.3s;
        }
        .select-banner .select-info { font-size: 0.85rem; color: var(--text-primary); }
        .select-banner .select-info strong { color: var(--gold); font-size: 1.1rem; }
        .select-banner .select-actions { display: flex; gap: 8px; }
        .btn-sm { padding: 8px 14px; border-radius: 8px; font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 0.78rem; cursor: pointer; border: none; transition: transform 0.1s; }
        .btn-sm:hover { transform: translateY(-1px); }
        .btn-confirm { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #1a1a1a; }
        .btn-confirm:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .btn-cancel-select { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.15); }
        .squares-grid td.cell.selectable {
            cursor: pointer;
            border: 1px dashed rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.06);
            transition: all 0.1s;
        }
        .squares-grid td.cell.selectable:hover {
            background: rgba(102, 126, 234, 0.18);
            border-color: rgba(102, 126, 234, 0.7);
        }
        .squares-grid td.cell.selectable:active {
            background: rgba(102, 126, 234, 0.3);
            transform: scale(0.92);
        }
        .squares-grid td.cell.just-selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.45), rgba(102, 126, 234, 0.25));
            color: #c0d0ff;
            border: 1px solid rgba(102, 126, 234, 0.6);
            animation: selectPop 0.3s ease-out;
            box-shadow: 0 0 8px rgba(102,126,234,0.25);
        }
        @keyframes selectPop { 0% { transform: scale(0.7); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

        .grid-legend { display: flex; gap: 16px; justify-content: center; margin-top: 10px; font-size: 0.72rem; color: var(--text-muted); }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-swatch { width: 14px; height: 14px; border-radius: 3px; }
        .sw-empty { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07); }
        .sw-taken { background: rgba(30,30,60,0.8); border: 1px solid rgba(255,255,255,0.1); }
        .sw-mine { background: rgba(102,126,234,0.3); border: 1px solid rgba(102,126,234,0.4); }
        .sw-winner { background: rgba(255,182,18,0.35); border: 1px solid rgba(255,182,18,0.5); }

        /* ‚îÄ‚îÄ Players ‚îÄ‚îÄ */
        .scores-card {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
            border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; margin-bottom: 16px;
        }
        .scores-card h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; color: var(--gold); margin-bottom: 10px; }
        .quarter-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        @media (min-width: 560px) { .quarter-grid { grid-template-columns: repeat(4, 1fr); } }
        .q-card { background: var(--bg-tertiary); border-radius: 8px; padding: 10px 8px; text-align: center; border: 1px solid rgba(255,255,255,0.04); }
        .q-card .q-label { font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; letter-spacing: 1px; color: var(--text-secondary); }
        .q-card .q-score { font-size: 0.8rem; color: var(--text-primary); margin: 3px 0; font-weight: 600; }
        .q-card .q-box { font-size: 0.7rem; color: var(--text-muted); }
        .q-card .q-winner { font-size: 0.75rem; color: var(--gold); font-weight: 600; margin-top: 2px; }
        .q-card .q-winner.none { color: var(--text-muted); font-weight: 400; }
        .q-card .q-prize { font-size: 0.68rem; color: var(--success); }

        .player-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .player-table th { text-align: left; padding: 8px 10px; color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .player-table td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text-primary); }
        .player-table tr.is-me td { color: #8ea8ff; }
        .player-table .initials-badge { display: inline-block; background: var(--bg-tertiary); border-radius: 4px; padding: 2px 8px; font-weight: 700; font-size: 0.78rem; letter-spacing: 1px; }
        .player-table .winnings { color: var(--success); font-weight: 600; }
        .player-table .winnings.zero { color: var(--text-muted); font-weight: 400; }
        .empty-players { text-align: center; padding: 24px; color: var(--text-muted); font-size: 0.85rem; }

        /* ‚îÄ‚îÄ Admin ‚îÄ‚îÄ */
        .admin-card {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
            border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; margin-bottom: 12px;
        }
        .admin-card h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; color: var(--gold); margin-bottom: 10px; }
        .admin-card p { color: var(--text-secondary); font-size: 0.82rem; margin-bottom: 12px; }
        .btn-admin { background: linear-gradient(135deg, var(--accent), #764ba2); color: white; border: none; border-radius: 8px; padding: 11px 20px; font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 0.88rem; cursor: pointer; transition: transform 0.1s; }
        .btn-admin:hover { transform: translateY(-1px); }
        .btn-admin:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-danger { background: var(--danger); color: white; border: none; border-radius: 8px; padding: 11px 20px; font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 0.88rem; cursor: pointer; }
        .score-inputs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px; }
        @media (min-width: 560px) { .score-inputs { grid-template-columns: repeat(4, 1fr); } }
        .score-input-group label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .score-input-group .score-pair { display: flex; gap: 4px; }
        .score-input-group input, .score-input-group select { width: 100%; padding: 8px 6px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text-primary); font-family: 'Outfit', sans-serif; font-size: 0.85rem; text-align: center; }
        .score-input-group input:focus, .score-input-group select:focus { outline: none; border-color: var(--gold); }
        .score-input-group .team-label { font-size: 0.6rem; color: var(--text-muted); text-align: center; margin-top: 2px; }
        .numbers-preview { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
        .num-chip { background: var(--bg-tertiary); padding: 4px 10px; border-radius: 4px; font-size: 0.78rem; color: var(--text-secondary); font-weight: 600; }
        .admin-btn-row { display: flex; gap: 8px; flex-wrap: wrap; }

        /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
        .toast {
            position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, var(--bg-secondary), #1a1a3a);
            color: var(--text-primary); padding: 12px 24px; border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.08);
            z-index: 10000; animation: toastIn 0.3s ease-out; font-size: 0.88rem;
            white-space: nowrap;
        }
        .toast.toast-success {
            border-left: 3px solid var(--success);
        }
        .toast.toast-complete {
            background: linear-gradient(135deg, rgba(34,197,94,0.2), var(--bg-secondary));
            border: 1px solid rgba(34,197,94,0.3);
            font-weight: 600;
        }
        @keyframes toastIn { from { transform: translateX(-50%) translateY(20px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
        @keyframes inputShake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-6px); } 40%, 80% { transform: translateX(6px); } }
        .shake { animation: inputShake 0.4s ease-out; }
        .spinner { width: 20px; height: 20px; border: 2px solid var(--bg-tertiary); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; margin-right: 6px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }

        @media (max-width: 600px) {
            .squares-grid th, .squares-grid td { width: 34px; height: 32px; font-size: 0.62rem; }
            .squares-grid .col-header, .squares-grid .row-header { font-size: 0.82rem; }
            .team-label-top { padding-left: 46px; }
            .team-logo { width: 36px; height: 36px; }
            .team-logo svg { width: 22px; height: 22px; }
            .team-name { font-size: 1.2rem; }
            .sb-logo { width: 52px; height: 52px; }
            .sb-logo svg { width: 30px; height: 30px; }
        }
        @media (min-width: 601px) {
            .squares-grid th, .squares-grid td { width: 52px; height: 44px; }
        }

        /* ‚îÄ‚îÄ Celebration ‚îÄ‚îÄ */
        #confettiCanvas { position: fixed; inset: 0; z-index: 10001; pointer-events: none; }
        .winner-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.88);
            display: flex; align-items: center; justify-content: center;
            z-index: 10002; animation: fadeIn 0.3s; backdrop-filter: blur(6px);
        }
        .winner-card {
            background: linear-gradient(145deg, #1a1a3a, #0e0e24);
            border: 2px solid var(--gold); border-radius: 20px;
            padding: 36px 32px; text-align: center;
            max-width: 380px; width: 90%;
            animation: winnerPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 60px rgba(255, 182, 18, 0.3), 0 0 120px rgba(255, 182, 18, 0.1);
        }
        @keyframes winnerPop { 0% { transform: scale(0.3) rotate(-5deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        .winner-card .trophy { font-size: 3.5rem; margin-bottom: 8px; animation: trophyBounce 1s ease-in-out infinite; }
        @keyframes trophyBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .winner-card .quarter-label { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; letter-spacing: 3px; color: var(--text-secondary); margin-bottom: 4px; }
        .winner-card .winner-name {
            font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; letter-spacing: 2px;
            background: linear-gradient(135deg, var(--gold), #fff8dc, var(--gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.2; margin-bottom: 4px;
        }
        .winner-card .winner-initials { display: inline-block; background: rgba(255,182,18,0.2); border: 1px solid rgba(255,182,18,0.4); border-radius: 6px; padding: 4px 14px; font-weight: 800; font-size: 1.1rem; letter-spacing: 3px; color: var(--gold); margin-bottom: 12px; }
        .winner-card .winner-score { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; }
        .winner-card .winner-prize { font-size: 1.4rem; font-weight: 700; color: var(--success); margin-bottom: 16px; }
        .winner-card .dismiss-btn { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #1a1a1a; border: none; border-radius: 10px; padding: 12px 36px; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 1rem; cursor: pointer; transition: transform 0.1s; }
        .winner-card .dismiss-btn:hover { transform: scale(1.05); }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <!-- Super Bowl Trophy Logo -->
            <div class="sb-logo">
                <svg viewBox="0 0 64 64" fill="none">
                    <path d="M32 8L36 20H48L38 28L42 40L32 32L22 40L26 28L16 20H28L32 8Z" fill="#1a1a1a" stroke="#b8860b" stroke-width="1"/>
                    <path d="M24 44H40V48H24V44Z" fill="#1a1a1a"/>
                    <path d="M20 48H44V50C44 51.1 43.1 52 42 52H22C20.9 52 20 51.1 20 50V48Z" fill="#1a1a1a"/>
                    <text x="32" y="27" text-anchor="middle" font-size="8" font-weight="bold" fill="#b8860b" font-family="serif">LX</text>
                </svg>
            </div>
            <h1>Super Bowl LX Squares</h1>
            <div class="subtitle">February 8, 2026 &bull; Levi's Stadium</div>

            <div class="matchup">
                <div class="team-logo-wrap">
                    <div class="team-logo pats-logo">
                        <img src="https://a.espncdn.com/i/teamlogos/nfl/500/ne.png" alt="Patriots" style="width:32px;height:32px;object-fit:contain;">
                    </div>
                    <span class="team-name team-pats">PATRIOTS</span>
                </div>
                <div class="vs-badge">VS</div>
                <div class="team-logo-wrap">
                    <span class="team-name team-hawks">SEAHAWKS</span>
                    <div class="team-logo hawks-logo">
                        <img src="https://a.espncdn.com/i/teamlogos/nfl/500/sea.png" alt="Seahawks" style="width:32px;height:32px;object-fit:contain;">
                    </div>
                </div>
            </div>

            <div class="user-bar hidden" id="userBar">
                <img id="userPhoto" src="" alt="">
                <span id="userName"></span>
                <span class="badge hidden" id="userBadge"></span>
                <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
            </div>
        </div>

        <div id="authScreen" class="auth-section">
            <h2>Join the Grid</h2>
            <p>Sign in with Google to claim your squares.<br>$1 per box &bull; $25 per quarter</p>
            <button class="google-btn" onclick="signIn()">
                <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
            </button>
        </div>

        <div id="mainApp" class="hidden">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('grid')">üèà Grid</button>
                <button class="tab-btn" onclick="switchTab('players')">üèÜ Players</button>
                <button class="tab-btn hidden" onclick="switchTab('admin')" id="adminTabBtn">‚öôÔ∏è Admin</button>
            </div>

            <div id="tab-grid" class="tab-content active">
                <div id="selectBanner" class="select-banner hidden">
                    <div class="select-info">
                        Tap <strong id="selectRemaining">0</strong> more box<span id="selectPlural">es</span> to place your <strong id="selectInitialsLabel"></strong>
                    </div>
                    <div class="select-actions">
                        <button class="btn-sm btn-confirm" id="confirmSelectBtn" onclick="confirmManualSelection()" disabled>Done</button>
                        <button class="btn-sm btn-cancel-select" onclick="cancelManualSelection()">Cancel</button>
                    </div>
                </div>
                <div class="grid-info">
                    <span>Boxes claimed: <strong id="claimedCount">0</strong>/100</span>
                    <span class="boxes-left" id="boxesLeftText">100 remaining</span>
                </div>
                <div class="grid-container">
                    <div class="team-label-top">
                        <span class="mini-logo pats"><img src="https://a.espncdn.com/i/teamlogos/nfl/500/ne.png" alt="" style="width:16px;height:16px;object-fit:contain;"></span>
                        &larr; PATRIOTS &rarr;
                    </div>
                    <div class="grid-outer">
                        <div class="team-label-side">&larr; SEAHAWKS &rarr;</div>
                        <table class="squares-grid" id="squaresGrid"></table>
                    </div>
                </div>
                <div class="grid-legend">
                    <div class="legend-item"><div class="legend-swatch sw-empty"></div> Open</div>
                    <div class="legend-item"><div class="legend-swatch sw-taken"></div> Taken</div>
                    <div class="legend-item"><div class="legend-swatch sw-mine"></div> Yours</div>
                    <div class="legend-item"><div class="legend-swatch sw-winner"></div> Winner</div>
                </div>
            </div>

            <div id="tab-players" class="tab-content">
                <div class="scores-card">
                    <h3>Quarter Results</h3>
                    <div class="quarter-grid" id="quarterResults"></div>
                </div>
                <div class="scores-card">
                    <h3>Players</h3>
                    <div id="playerTableWrap">
                        <table class="player-table">
                            <thead><tr><th>Player</th><th>Initials</th><th>Boxes</th><th>Cost</th><th>Won</th></tr></thead>
                            <tbody id="playerTableBody"></tbody>
                        </table>
                    </div>
                    <div id="noPlayersMsg" class="empty-players">No players yet</div>
                </div>
            </div>

            <div id="tab-admin" class="tab-content">
                <div class="admin-card">
                    <h3>Grid Numbers</h3>
                    <p id="numbersStatus">Numbers have not been assigned yet.</p>
                    <div id="numbersPreview" class="hidden">
                        <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:4px;">Patriots (columns):</div>
                        <div class="numbers-preview" id="colNumbersPreview"></div>
                        <div style="font-size:0.78rem;color:var(--text-secondary);margin:8px 0 4px;">Seahawks (rows):</div>
                        <div class="numbers-preview" id="rowNumbersPreview"></div>
                    </div>
                    <div class="admin-btn-row" style="margin-top:12px;">
                        <button class="btn-admin" id="assignNumbersBtn" onclick="assignNumbers()">Assign Random Numbers</button>
                        <button class="btn-danger hidden" id="clearNumbersBtn" onclick="clearNumbers()">Clear Numbers</button>
                    </div>
                </div>
                <div class="admin-card">
                    <h3>Enter Scores</h3>
                    <p>Enter the last digit of each team's score at end of each quarter (0-9). This maps directly to the grid.</p>
                    <div class="score-inputs" id="scoreInputs"></div>
                    <button class="btn-admin" onclick="saveScores()">Save Scores</button>
                </div>
                <div class="admin-card">
                    <h3>üß™ Test Mode</h3>
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                        <label style="font-size:0.82rem;color:var(--text-secondary);cursor:pointer;display:flex;align-items:center;gap:8px;">
                            <input type="checkbox" id="testModeToggle" onchange="toggleTestMode()" style="width:18px;height:18px;accent-color:var(--gold);">
                            Enable Test Mode
                        </label>
                        <span id="testModeStatus" style="font-size:0.72rem;color:var(--text-muted);"></span>
                    </div>
                    <div id="testModeControls" class="hidden">
                        <p>Add simulated users. They'll get random boxes on the grid. All test users are removed when you disable test mode.</p>
                        <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
                            <input type="text" id="testUserName" placeholder="Name (e.g. John)" maxlength="20" style="flex:1;min-width:120px;padding:9px 12px;background:var(--bg-tertiary);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--text-primary);font-family:'Outfit',sans-serif;font-size:0.85rem;">
                            <input type="text" id="testUserInitials" placeholder="Initials" maxlength="3" style="width:80px;padding:9px 12px;background:var(--bg-tertiary);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--text-primary);font-family:'Outfit',sans-serif;font-size:0.85rem;text-transform:uppercase;letter-spacing:2px;font-weight:700;">
                            <select id="testUserBoxes" style="width:70px;padding:9px 6px;background:var(--bg-tertiary);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--text-primary);font-family:'Outfit',sans-serif;font-size:0.85rem;"></select>
                            <button class="btn-admin" onclick="addTestUser()" style="white-space:nowrap;">Add User</button>
                        </div>
                        <div id="testUserError" style="font-size:0.72rem;color:var(--danger);margin-bottom:8px;display:none;"></div>
                        <div id="testUsersList" style="font-size:0.8rem;color:var(--text-secondary);"></div>
                        <div style="margin-top:10px;">
                            <button class="btn-admin" onclick="fillGridWithTestUsers()" style="font-size:0.8rem;padding:8px 14px;">Auto-Fill Remaining</button>
                        </div>
                    </div>
                </div>
                <div class="admin-card">
                    <h3>Danger Zone</h3>
                    <div class="admin-btn-row">
                        <button class="btn-danger" onclick="resetGrid()">Reset Entire Grid</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="confettiCanvas" class="hidden"></canvas>

    <div id="winnerOverlay" class="winner-overlay hidden" onclick="dismissCelebration()">
        <div class="winner-card" onclick="event.stopPropagation()">
            <div class="trophy">üèÜ</div>
            <div class="quarter-label" id="winQuarter"></div>
            <div class="winner-name" id="winName"></div>
            <div class="winner-initials" id="winInitials"></div>
            <div class="winner-score" id="winScore"></div>
            <div class="winner-prize">$25</div>
            <button class="dismiss-btn" onclick="dismissCelebration()">LET'S GO!</button>
        </div>
    </div>

    <div id="setupOverlay" class="overlay hidden">
        <div class="overlay-card">
            <h2>Claim Your Squares</h2>
            <div class="sub">Pick your initials and how many boxes you want. $1 per box.</div>
            <div class="form-group">
                <label>Your Initials (2-3 letters)</label>
                <input type="text" id="initialsInput" maxlength="3" placeholder="e.g. DS" autocomplete="off" style="text-transform:uppercase; letter-spacing:2px; font-weight:700;">
                <div class="error-text" id="initialsError"></div>
            </div>
            <div class="form-group">
                <label>Number of Boxes (max 10)</label>
                <select id="boxCountSelect"></select>
                <div class="helper">$1 per box &bull; Total: <strong id="costPreview">$0</strong></div>
            </div>
            <div class="form-group">
                <label>How do you want to pick?</label>
                <div style="display:flex;gap:8px;margin-top:4px;">
                    <button type="button" id="pickAuto" class="btn-gold" style="flex:1;padding:11px 10px;font-size:0.85rem;" onclick="setPickMethod('auto')">
                        üé≤ Auto Select
                    </button>
                    <button type="button" id="pickManual" class="btn-gold" style="flex:1;padding:11px 10px;font-size:0.85rem;background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid rgba(255,255,255,0.15);" onclick="setPickMethod('manual')">
                        üëÜ Pick My Own
                    </button>
                </div>
            </div>
            <button class="btn-gold" id="claimBtn" onclick="claimBoxes()">Claim Boxes</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CONFIG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const ADMIN_EMAIL = 'stewartdavidp@gmail.com';
    const GAME_REF   = 'sb-squares-lx';

    firebase.initializeApp({
        apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
        authDomain: "word-boxing.firebaseapp.com",
        databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
        projectId: "word-boxing",
        storageBucket: "word-boxing.appspot.com",
        messagingSenderId: "932356027174",
        appId: "1:932356027174:web:0c1c9eeeca785cb49a0d8f"
    });
    const auth = firebase.auth();
    const db   = firebase.database();

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let currentUser = null, isAdmin = false, listenersAttached = false;
    let gridData = {}, playersData = {};
    let colNumbers = null, rowNumbers = null, numbersAssigned = false;
    let scores = { q1: null, q2: null, q3: null, q4: null };
    let celebrationQueue = [], confettiAnimId = null, confettiPieces = [], audioCtx = null;
    let pickMethod = 'auto';
    let manualSelectMode = false, manualInitials = '', manualBoxTarget = 0, manualPicks = [];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SOUND EFFECTS SYSTEM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function getAudioCtx() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return audioCtx;
    }

    // Standard tap sound ‚Äî short crisp pop
    function playTapSound() {
        try {
            const ctx = getAudioCtx();
            const now = ctx.currentTime;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, now);
            osc.frequency.exponentialRampToValueAtTime(440, now + 0.08);
            gain.gain.setValueAtTime(0.15, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.12);
        } catch(e) {}
    }

    // Undo/remove tap sound ‚Äî lower tone
    function playUndoSound() {
        try {
            const ctx = getAudioCtx();
            const now = ctx.currentTime;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, now);
            osc.frequency.exponentialRampToValueAtTime(220, now + 0.1);
            gain.gain.setValueAtTime(0.12, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.12);
            osc.connect(gain); gain.connect(ctx.destination);
            osc.start(now); osc.stop(now + 0.14);
        } catch(e) {}
    }

    // All boxes filled sound ‚Äî ascending triumphant ding-ding-ding
    function playCompletionSound() {
        try {
            const ctx = getAudioCtx();
            const now = ctx.currentTime;
            const notes = [
                { freq: 659.25, start: 0,    dur: 0.12 },   // E5
                { freq: 783.99, start: 0.1,  dur: 0.12 },   // G5
                { freq: 987.77, start: 0.2,  dur: 0.12 },   // B5
                { freq: 1318.5, start: 0.32, dur: 0.35 },   // E6 (held)
                { freq: 987.77, start: 0.32, dur: 0.35 },   // B5 harmony
            ];
            notes.forEach(n => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = n.freq;
                gain.gain.setValueAtTime(0, now + n.start);
                gain.gain.linearRampToValueAtTime(0.18, now + n.start + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, now + n.start + n.dur);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(now + n.start); osc.stop(now + n.start + n.dur + 0.05);
            });
            // Sparkle noise
            const bufSize = ctx.sampleRate * 0.3;
            const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
            const d = buf.getChannelData(0);
            for (let i = 0; i < bufSize; i++) d[i] = (Math.random() * 2 - 1);
            const noise = ctx.createBufferSource(); noise.buffer = buf;
            const nGain = ctx.createGain();
            const nFilter = ctx.createBiquadFilter();
            nFilter.type = 'highpass'; nFilter.frequency.value = 8000;
            nGain.gain.setValueAtTime(0, now + 0.3);
            nGain.gain.linearRampToValueAtTime(0.06, now + 0.35);
            nGain.gain.exponentialRampToValueAtTime(0.001, now + 0.7);
            noise.connect(nFilter); nFilter.connect(nGain); nGain.connect(ctx.destination);
            noise.start(now + 0.3); noise.stop(now + 0.8);
        } catch(e) {}
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUTH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function signIn() {
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
            .catch(e => showToast('Sign-in failed: ' + e.message));
    }
    function signOut() { auth.signOut(); }

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            isAdmin = (user.email === ADMIN_EMAIL);
            console.log('UID:', user.uid, '| Email:', user.email, '| Admin:', isAdmin);
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userBar').classList.remove('hidden');
            document.getElementById('userName').textContent = user.displayName || user.email;
            document.getElementById('userPhoto').src = user.photoURL || '';
            document.getElementById('adminTabBtn').classList.toggle('hidden', !isAdmin);
            renderGrid();
            buildScoreInputs();
            if (!listenersAttached) { listenToData(); listenersAttached = true; }
        } else {
            currentUser = null; isAdmin = false;
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('userBar').classList.add('hidden');
            document.getElementById('setupOverlay').classList.add('hidden');
        }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  LISTENERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function listenToData() {
        db.ref(`${GAME_REF}/grid`).on('value', s => {
            gridData = s.val() || {};
            renderGrid(); updateGridInfo();
        });
        db.ref(`${GAME_REF}/players`).on('value', s => {
            playersData = s.val() || {};
            checkSetup(); renderPlayers(); updateBadge();
            if (testMode) { renderTestUsersList(); buildTestBoxSelect(); }
        });
        db.ref(`${GAME_REF}/numbers`).on('value', s => {
            const v = s.val();
            if (v && v.cols && v.rows) { colNumbers = v.cols; rowNumbers = v.rows; numbersAssigned = true; }
            else { colNumbers = null; rowNumbers = null; numbersAssigned = false; }
            renderGrid(); updateNumbersUI(); renderQuarters();
        });
        db.ref(`${GAME_REF}/scores`).on('value', s => {
            const oldScores = { ...scores };
            scores = s.val() || { q1:null, q2:null, q3:null, q4:null };
            if (numbersAssigned && !isAdmin) {
                const newWinners = [];
                ['q1','q2','q3','q4'].forEach((q, i) => {
                    const oldS = oldScores[q]; const newS = scores[q];
                    const hadScore = oldS && oldS.pats !== undefined && oldS.hawks !== undefined;
                    const hasScore = newS && newS.pats !== undefined && newS.hawks !== undefined;
                    if (hasScore && !hadScore) {
                        const ci = colNumbers.indexOf(newS.pats); const ri = rowNumbers.indexOf(newS.hawks);
                        if (ci !== -1 && ri !== -1) {
                            const cellData = gridData[`${ri}_${ci}`];
                            if (cellData) newWinners.push({ quarter: ['Q1','Q2','Q3','Q4'][i], name: cellData.name, initials: cellData.initials, pats: newS.pats, hawks: newS.hawks });
                        }
                    }
                });
                if (newWinners.length > 0) { celebrationQueue = [...newWinners]; showNextCelebration(); }
            }
            renderQuarters(); renderPlayers(); renderGrid(); populateScoreInputs();
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SETUP
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function checkSetup() {
        if (!currentUser) return;
        if (manualSelectMode) return;
        if (!playersData[currentUser.uid]) {
            buildBoxSelect();
            document.getElementById('setupOverlay').classList.remove('hidden');
        } else {
            document.getElementById('setupOverlay').classList.add('hidden');
        }
    }

    function updateBadge() {
        if (!currentUser) return;
        const my = playersData[currentUser.uid];
        const el = document.getElementById('userBadge');
        if (my) { el.textContent = my.initials; el.classList.remove('hidden'); }
        else { el.classList.add('hidden'); }
    }

    function buildBoxSelect() {
        const avail = Math.min(10, 100 - Object.keys(gridData).length);
        const sel = document.getElementById('boxCountSelect');
        sel.innerHTML = '';
        for (let i = 1; i <= Math.max(avail, 1); i++) {
            const o = document.createElement('option');
            o.value = i; o.textContent = `${i} box${i>1?'es':''} ‚Äî $${i}`;
            sel.appendChild(o);
        }
        sel.value = Math.min(5, avail);
        updateCost(); sel.onchange = updateCost;
    }

    function updateCost() {
        document.getElementById('costPreview').textContent = '$' + (parseInt(document.getElementById('boxCountSelect').value) || 0);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CLAIM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function setPickMethod(method) {
        pickMethod = method;
        const autoBtn = document.getElementById('pickAuto');
        const manualBtn = document.getElementById('pickManual');
        if (method === 'auto') {
            autoBtn.style.background = 'linear-gradient(135deg, var(--gold), var(--gold-dim))';
            autoBtn.style.color = '#1a1a1a'; autoBtn.style.border = 'none';
            manualBtn.style.background = 'var(--bg-tertiary)';
            manualBtn.style.color = 'var(--text-secondary)'; manualBtn.style.border = '1px solid rgba(255,255,255,0.15)';
            document.getElementById('claimBtn').textContent = 'Claim Boxes';
        } else {
            manualBtn.style.background = 'linear-gradient(135deg, var(--gold), var(--gold-dim))';
            manualBtn.style.color = '#1a1a1a'; manualBtn.style.border = 'none';
            autoBtn.style.background = 'var(--bg-tertiary)';
            autoBtn.style.color = 'var(--text-secondary)'; autoBtn.style.border = '1px solid rgba(255,255,255,0.15)';
            document.getElementById('claimBtn').textContent = 'Pick on Grid ‚Üí';
        }
    }

    async function claimBoxes() {
        const init = document.getElementById('initialsInput').value.trim().toUpperCase();
        const count = parseInt(document.getElementById('boxCountSelect').value);
        const err = document.getElementById('initialsError');
        err.style.display = 'none';

        if (init.length < 2 || init.length > 3) { showValidationError('Enter 2-3 letter initials first!'); return; }
        if (!/^[A-Z]+$/.test(init)) { showValidationError('Letters only for initials'); return; }
        for (const uid in playersData) {
            if (playersData[uid].initials === init) { showValidationError(`"${init}" is taken ‚Äî try different initials`); return; }
        }

        const avail = [];
        for (let r = 0; r < 10; r++) for (let c = 0; c < 10; c++) { const k = `${r}_${c}`; if (!gridData[k]) avail.push(k); }
        if (avail.length < count) { showToast('Not enough boxes!'); return; }

        if (pickMethod === 'manual') {
            manualSelectMode = true; manualInitials = init; manualBoxTarget = count; manualPicks = [];
            document.getElementById('setupOverlay').classList.add('hidden');
            // Switch to Grid tab if not already there
            switchTab('grid');
            updateSelectBanner();
            document.getElementById('selectBanner').classList.remove('hidden');
            renderGrid();
            // Scroll grid into view
            document.getElementById('selectBanner').scrollIntoView({ behavior: 'smooth', block: 'start' });
            showToast(`Tap ${count} box${count > 1 ? 'es' : ''} on the grid`);
            return;
        }

        const picks = [...avail].sort(() => Math.random() - 0.5).slice(0, count);
        const btn = document.getElementById('claimBtn');
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Claiming...';
        try {
            const up = {};
            up[`${GAME_REF}/players/${currentUser.uid}`] = { name: currentUser.displayName || currentUser.email, initials: init, boxCount: count, email: currentUser.email };
            picks.forEach(k => { up[`${GAME_REF}/grid/${k}`] = { uid: currentUser.uid, initials: init, name: currentUser.displayName || currentUser.email }; });
            await db.ref().update(up);
            document.getElementById('setupOverlay').classList.add('hidden');
            showToast(`Claimed ${count} box${count>1?'es':''}! üèà`);
        } catch (e) { showToast('Error: ' + e.message); }
        finally { btn.disabled = false; btn.textContent = 'Claim Boxes'; }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MANUAL SELECTION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateSelectBanner() {
        const remaining = manualBoxTarget - manualPicks.length;
        document.getElementById('selectRemaining').textContent = remaining;
        document.getElementById('selectPlural').textContent = remaining !== 1 ? 'es' : '';
        document.getElementById('selectInitialsLabel').textContent = manualInitials;
        document.getElementById('confirmSelectBtn').disabled = manualPicks.length !== manualBoxTarget;
    }

    function handleCellTap(row, col) {
        if (!manualSelectMode) return;
        const k = `${row}_${col}`;

        // Un-pick
        const idx = manualPicks.indexOf(k);
        if (idx !== -1) {
            manualPicks.splice(idx, 1);
            playUndoSound();
            updateSelectBanner();
            renderGrid();
            return;
        }

        if (gridData[k]) { showToast('That box is already taken!'); return; }
        if (manualPicks.length >= manualBoxTarget) {
            showToast('All boxes selected! Tap Done or tap a selected box to change it.');
            return;
        }

        manualPicks.push(k);
        updateSelectBanner();
        renderGrid();

        if (navigator.vibrate) navigator.vibrate(30);

        // Check if this was the LAST box
        if (manualPicks.length === manualBoxTarget) {
            playCompletionSound();
            showToast('‚úÖ All boxes filled! Tap Done to confirm.', 4000, 'toast-complete');
        } else {
            playTapSound();
        }
    }

    async function confirmManualSelection() {
        if (manualPicks.length !== manualBoxTarget) return;
        const btn = document.getElementById('confirmSelectBtn');
        btn.disabled = true; btn.textContent = '...';
        try {
            const up = {};
            up[`${GAME_REF}/players/${currentUser.uid}`] = { name: currentUser.displayName || currentUser.email, initials: manualInitials, boxCount: manualBoxTarget, email: currentUser.email };
            manualPicks.forEach(k => { up[`${GAME_REF}/grid/${k}`] = { uid: currentUser.uid, initials: manualInitials, name: currentUser.displayName || currentUser.email }; });
            await db.ref().update(up);
            showToast(`Claimed ${manualBoxTarget} box${manualBoxTarget > 1 ? 'es' : ''}! üèà`);
        } catch (e) { showToast('Error: ' + e.message); }
        finally {
            manualSelectMode = false; manualPicks = [];
            document.getElementById('selectBanner').classList.add('hidden');
            btn.disabled = false; btn.textContent = 'Done';
            renderGrid();
        }
    }

    function cancelManualSelection() {
        manualSelectMode = false; manualPicks = [];
        document.getElementById('selectBanner').classList.add('hidden');
        renderGrid();
        if (!playersData[currentUser.uid]) document.getElementById('setupOverlay').classList.remove('hidden');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  GRID
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderGrid() {
        const tbl = document.getElementById('squaresGrid');
        const winners = getWinnerCells();
        let h = '<tr><th class="corner-cell"></th>';
        for (let c = 0; c < 10; c++) {
            h += `<th class="col-header${numbersAssigned?' has-number':''}">${numbersAssigned ? colNumbers[c] : '?'}</th>`;
        }
        h += '</tr>';
        for (let r = 0; r < 10; r++) {
            h += `<tr><th class="row-header${numbersAssigned?' has-number':''}">${numbersAssigned ? rowNumbers[r] : '?'}</th>`;
            for (let c = 0; c < 10; c++) {
                const k = `${r}_${c}`, d = gridData[k], w = winners.includes(k);
                const isPendingPick = manualSelectMode && manualPicks.includes(k);
                if (isPendingPick) {
                    h += `<td class="cell just-selected" onclick="handleCellTap(${r},${c})" title="Tap to remove">${esc(manualInitials)}</td>`;
                } else if (d) {
                    const mine = currentUser && d.uid === currentUser.uid;
                    let cls = mine ? 'cell mine' : 'cell taken';
                    if (w) cls += ' winner-cell';
                    h += `<td class="${cls}" title="${esc(d.name)}">${esc(d.initials)}</td>`;
                } else if (manualSelectMode) {
                    h += `<td class="cell selectable" onclick="handleCellTap(${r},${c})"></td>`;
                } else {
                    h += '<td class="cell empty"></td>';
                }
            }
            h += '</tr>';
        }
        tbl.innerHTML = h;
    }

    function getWinnerCells() {
        if (!numbersAssigned) return [];
        const cells = [];
        ['q1','q2','q3','q4'].forEach(q => {
            const s = scores[q];
            if (s && s.pats !== undefined && s.hawks !== undefined) {
                const ci = colNumbers.indexOf(parseInt(s.pats));
                const ri = rowNumbers.indexOf(parseInt(s.hawks));
                if (ci !== -1 && ri !== -1) cells.push(`${ri}_${ci}`);
            }
        });
        return cells;
    }

    function updateGridInfo() {
        const n = Object.keys(gridData).length;
        document.getElementById('claimedCount').textContent = n;
        document.getElementById('boxesLeftText').textContent = n < 100 ? `${100 - n} remaining` : '‚úì GRID FULL';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  NUMBERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateNumbersUI() {
        const st = document.getElementById('numbersStatus'), pr = document.getElementById('numbersPreview');
        const ab = document.getElementById('assignNumbersBtn'), cb = document.getElementById('clearNumbersBtn');
        if (numbersAssigned) {
            st.textContent = 'Numbers have been assigned!';
            pr.classList.remove('hidden');
            document.getElementById('colNumbersPreview').innerHTML = colNumbers.map(n => `<span class="num-chip">${n}</span>`).join('');
            document.getElementById('rowNumbersPreview').innerHTML = rowNumbers.map(n => `<span class="num-chip">${n}</span>`).join('');
            ab.classList.add('hidden'); cb.classList.remove('hidden');
        } else {
            const cnt = Object.keys(gridData).length;
            st.textContent = cnt < 100 ? `Waiting for grid to fill (${cnt}/100)` : 'Grid full ‚Äî ready to assign!';
            ab.disabled = cnt < 100;
            pr.classList.add('hidden'); ab.classList.remove('hidden'); cb.classList.add('hidden');
        }
    }

    async function assignNumbers() {
        if (!await showConfirm('Assign random numbers? This determines winners.')) return;
        await db.ref(`${GAME_REF}/numbers`).set({ cols: shuffle([0,1,2,3,4,5,6,7,8,9]), rows: shuffle([0,1,2,3,4,5,6,7,8,9]) });
        showToast('Numbers assigned!');
    }
    async function clearNumbers() {
        if (!await showConfirm('Clear numbers?')) return;
        await db.ref(`${GAME_REF}/numbers`).remove();
        showToast('Numbers cleared');
    }
    function shuffle(a) { const b=[...a]; for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];} return b; }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SCORES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function buildScoreInputs() {
        const c = document.getElementById('scoreInputs'); if (!c) return;
        const opts = '<option value="">-</option>' + [0,1,2,3,4,5,6,7,8,9].map(n => `<option value="${n}">${n}</option>`).join('');
        c.innerHTML = ['Q1','Q2','Q3','Q4'].map((q,i) => `
            <div class="score-input-group"><label>${q}</label>
                <div class="score-pair">
                    <div style="flex:1"><select id="sp${i}">${opts}</select><div class="team-label">PAT</div></div>
                    <div style="flex:1"><select id="sh${i}">${opts}</select><div class="team-label">SEA</div></div>
                </div>
            </div>`).join('');
    }
    function populateScoreInputs() {
        ['q1','q2','q3','q4'].forEach((q,i) => {
            const s = scores[q], p = document.getElementById(`sp${i}`), h = document.getElementById(`sh${i}`);
            if (p && h) { p.value = s?.pats !== undefined ? s.pats : ''; h.value = s?.hawks !== undefined ? s.hawks : ''; }
        });
    }
    async function saveScores() {
        const ns = {};
        ['q1','q2','q3','q4'].forEach((q,i) => {
            const p = document.getElementById(`sp${i}`).value, h = document.getElementById(`sh${i}`).value;
            ns[q] = (p !== '' && h !== '') ? { pats: +p, hawks: +h } : null;
        });
        const newWinners = [];
        if (numbersAssigned) {
            ['q1','q2','q3','q4'].forEach((q, i) => {
                const oldS = scores[q]; const newS = ns[q];
                const hadScore = oldS && oldS.pats !== undefined && oldS.hawks !== undefined;
                const hasScore = newS && newS.pats !== undefined && newS.hawks !== undefined;
                if (hasScore && !hadScore) {
                    const ci = colNumbers.indexOf(newS.pats); const ri = rowNumbers.indexOf(newS.hawks);
                    if (ci !== -1 && ri !== -1) {
                        const cellData = gridData[`${ri}_${ci}`];
                        if (cellData) newWinners.push({ quarter: ['Q1','Q2','Q3','Q4'][i], name: cellData.name, initials: cellData.initials, pats: newS.pats, hawks: newS.hawks });
                    }
                }
            });
        }
        await db.ref(`${GAME_REF}/scores`).set(ns);
        if (newWinners.length > 0) { celebrationQueue = [...newWinners]; showNextCelebration(); }
        else showToast('Scores saved!');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CELEBRATION SYSTEM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showNextCelebration() {
        if (celebrationQueue.length === 0) { dismissCelebration(); return; }
        const w = celebrationQueue.shift();
        document.getElementById('winQuarter').textContent = w.quarter + ' WINNER';
        document.getElementById('winName').textContent = w.name.split(' ')[0];
        document.getElementById('winInitials').textContent = w.initials;
        document.getElementById('winScore').textContent = `PAT: ${w.pats}  ‚Ä¢  SEA: ${w.hawks}`;
        document.getElementById('winnerOverlay').classList.remove('hidden');
        startConfetti(); playVictorySound();
    }

    function dismissCelebration() {
        document.getElementById('winnerOverlay').classList.add('hidden');
        stopConfetti();
        if (celebrationQueue.length > 0) setTimeout(showNextCelebration, 400);
    }

    function playVictorySound() {
        try {
            const ctx = getAudioCtx();
            const notes = [
                { freq: 523.25, start: 0,    dur: 0.15 },
                { freq: 659.25, start: 0.12, dur: 0.15 },
                { freq: 783.99, start: 0.24, dur: 0.15 },
                { freq: 1046.5, start: 0.38, dur: 0.4  },
                { freq: 783.99, start: 0.38, dur: 0.4  },
                { freq: 659.25, start: 0.38, dur: 0.4  },
            ];
            const now = ctx.currentTime;
            notes.forEach(n => {
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.type = 'square'; osc.frequency.value = n.freq;
                gain.gain.setValueAtTime(0, now + n.start);
                gain.gain.linearRampToValueAtTime(0.12, now + n.start + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, now + n.start + n.dur);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(now + n.start); osc.stop(now + n.start + n.dur + 0.05);
                const osc2 = ctx.createOscillator(); const gain2 = ctx.createGain();
                osc2.type = 'sawtooth'; osc2.frequency.value = n.freq;
                gain2.gain.setValueAtTime(0, now + n.start);
                gain2.gain.linearRampToValueAtTime(0.04, now + n.start + 0.02);
                gain2.gain.exponentialRampToValueAtTime(0.001, now + n.start + n.dur);
                osc2.connect(gain2); gain2.connect(ctx.destination);
                osc2.start(now + n.start); osc2.stop(now + n.start + n.dur + 0.05);
            });
            const bufferSize = ctx.sampleRate * 0.6;
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1);
            const noise = ctx.createBufferSource(); noise.buffer = buffer;
            const noiseGain = ctx.createGain(); const noiseFilter = ctx.createBiquadFilter();
            noiseFilter.type = 'highpass'; noiseFilter.frequency.value = 7000;
            noiseGain.gain.setValueAtTime(0, now + 0.36);
            noiseGain.gain.linearRampToValueAtTime(0.08, now + 0.4);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
            noise.connect(noiseFilter); noiseFilter.connect(noiseGain); noiseGain.connect(ctx.destination);
            noise.start(now + 0.36); noise.stop(now + 1.2);
        } catch (e) { console.log('Audio not available:', e); }
    }

    // ‚îÄ‚îÄ Confetti ‚îÄ‚îÄ
    function startConfetti() {
        const canvas = document.getElementById('confettiCanvas');
        canvas.classList.remove('hidden');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const ctx = canvas.getContext('2d');
        confettiPieces = [];
        const colors = ['#FFB612', '#C60C30', '#002244', '#69BE28', '#B0B7BC', '#ffffff', '#ff6b6b', '#4ecdc4', '#f39c12', '#9b59b6'];
        for (let i = 0; i < 200; i++) {
            confettiPieces.push({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                w: Math.random() * 10 + 5, h: Math.random() * 6 + 3,
                color: colors[Math.floor(Math.random() * colors.length)],
                vx: (Math.random() - 0.5) * 4, vy: Math.random() * 3 + 2,
                rot: Math.random() * 360, rotSpeed: (Math.random() - 0.5) * 12,
                wobble: Math.random() * Math.PI * 2, wobbleSpeed: Math.random() * 0.1 + 0.02,
            });
        }
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let alive = false;
            confettiPieces.forEach(p => {
                p.x += p.vx + Math.sin(p.wobble) * 0.8; p.y += p.vy;
                p.rot += p.rotSpeed; p.wobble += p.wobbleSpeed; p.vy += 0.02;
                if (p.y < canvas.height + 20) alive = true;
                ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = Math.min(1, Math.max(0, (canvas.height - p.y + 100) / 200));
                ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h); ctx.restore();
            });
            if (alive) confettiAnimId = requestAnimationFrame(animate);
            else stopConfetti();
        }
        confettiAnimId = requestAnimationFrame(animate);
        setTimeout(stopConfetti, 5000);
    }

    function stopConfetti() {
        if (confettiAnimId) { cancelAnimationFrame(confettiAnimId); confettiAnimId = null; }
        const canvas = document.getElementById('confettiCanvas');
        canvas.classList.add('hidden');
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        confettiPieces = [];
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  QUARTER RESULTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderQuarters() {
        document.getElementById('quarterResults').innerHTML = [{k:'q1',l:'Q1'},{k:'q2',l:'Q2'},{k:'q3',l:'Q3'},{k:'q4',l:'Q4'}].map(q => {
            const s = scores[q.k]; let st='‚Äî',bt='',wt='TBD',wc='none';
            if (s && s.pats !== undefined) {
                st = `PAT: ${s.pats}  SEA: ${s.hawks}`;
                if (numbersAssigned) {
                    const pd=+s.pats, hd=+s.hawks; bt = `(${pd}, ${hd})`;
                    const d = gridData[`${rowNumbers.indexOf(hd)}_${colNumbers.indexOf(pd)}`];
                    if (d) { wt = `üèÜ ${esc(d.initials)} ‚Äî ${esc(d.name.split(' ')[0])}`; wc = ''; }
                    else wt = 'Empty box';
                }
            } else if (!numbersAssigned) wt = 'Numbers not set';
            return `<div class="q-card"><div class="q-label">${q.l}</div><div class="q-score">${st}</div><div class="q-box">${bt}</div><div class="q-winner ${wc}">${wt}</div><div class="q-prize">$25</div></div>`;
        }).join('');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PLAYERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderPlayers() {
        const entries = Object.entries(playersData);
        document.getElementById('noPlayersMsg').classList.toggle('hidden', entries.length > 0);
        document.getElementById('playerTableWrap').classList.toggle('hidden', entries.length === 0);
        if (!entries.length) return;
        document.getElementById('playerTableBody').innerHTML = entries
            .map(([uid, d]) => ({ uid, name: d.name||'?', initials: d.initials, cnt: d.boxCount||0, win: calcWin(uid) }))
            .sort((a,b) => b.cnt - a.cnt)
            .map(p => {
                const me = currentUser && p.uid === currentUser.uid;
                return `<tr class="${me?'is-me':''}"><td>${esc(p.name.split(' ')[0])}${me?' (you)':''}</td><td><span class="initials-badge">${esc(p.initials)}</span></td><td>${p.cnt}</td><td>$${p.cnt}</td><td class="winnings ${p.win?'':'zero'}">$${p.win}</td></tr>`;
            }).join('');
    }
    function calcWin(uid) {
        if (!numbersAssigned) return 0; let t = 0;
        ['q1','q2','q3','q4'].forEach(q => {
            const s = scores[q];
            if (s?.pats !== undefined) {
                const d = gridData[`${rowNumbers.indexOf(+s.hawks)}_${colNumbers.indexOf(+s.pats)}`];
                if (d?.uid === uid) t += 25;
            }
        }); return t;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ADMIN RESET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function resetGrid() {
        if (!await showConfirm('Delete ALL data? Squares, players, numbers, scores?')) return;
        if (!await showConfirm('REALLY sure? Cannot be undone.')) return;
        await db.ref(GAME_REF).remove();
        showToast('Grid reset');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TABS & UTILS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`[onclick="switchTab('${t}')"]`).classList.add('active');
        document.getElementById(`tab-${t}`).classList.add('active');
    }

    function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    function showValidationError(msg) {
        const err = document.getElementById('initialsError');
        const input = document.getElementById('initialsInput');
        err.textContent = msg; err.style.display = 'block';
        input.classList.remove('shake');
        void input.offsetWidth; // force reflow
        input.classList.add('shake');
        input.focus();
        showToast('‚ö†Ô∏è ' + msg);
    }

    function showToast(msg, dur = 3000, extraClass = '') {
        document.querySelectorAll('.toast').forEach(t => t.remove());
        const t = document.createElement('div');
        t.className = 'toast' + (extraClass ? ' ' + extraClass : '');
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, dur);
    }

    function showConfirm(msg) {
        return new Promise(res => {
            const o = document.createElement('div'); o.className = 'overlay';
            o.innerHTML = `<div class="overlay-card" onclick="event.stopPropagation()" style="max-width:360px">
                <h2 style="color:var(--danger)">Confirm</h2>
                <p style="color:var(--text-secondary);margin:12px 0 20px;font-size:0.9rem">${msg}</p>
                <div style="display:flex;gap:10px">
                    <button class="btn-gold" style="background:var(--bg-tertiary);color:var(--text-secondary);flex:1" id="_cn">Cancel</button>
                    <button class="btn-gold" style="flex:1" id="_cy">Confirm</button>
                </div></div>`;
            document.body.appendChild(o);
            o.querySelector('#_cn').onclick = () => { o.remove(); res(false); };
            o.querySelector('#_cy').onclick = () => { o.remove(); res(true); };
            o.onclick = () => { o.remove(); res(false); };
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TEST MODE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let testMode = false;
    let testUserIds = [];

    function toggleTestMode() {
        testMode = document.getElementById('testModeToggle').checked;
        document.getElementById('testModeControls').classList.toggle('hidden', !testMode);
        if (testMode) {
            document.getElementById('testModeStatus').textContent = 'üü¢ Active';
            buildTestBoxSelect(); renderTestUsersList();
        } else {
            if (testUserIds.length > 0) removeAllTestUsers();
            document.getElementById('testModeStatus').textContent = '';
        }
    }

    function buildTestBoxSelect() {
        const claimed = Object.keys(gridData).length;
        const avail = Math.min(10, 100 - claimed);
        const sel = document.getElementById('testUserBoxes');
        sel.innerHTML = '';
        for (let i = 1; i <= Math.max(avail, 1); i++) {
            const o = document.createElement('option'); o.value = i; o.textContent = i; sel.appendChild(o);
        }
        sel.value = Math.min(3, avail);
    }

    async function addTestUser() {
        const name = document.getElementById('testUserName').value.trim();
        const initials = document.getElementById('testUserInitials').value.trim().toUpperCase();
        const boxCount = parseInt(document.getElementById('testUserBoxes').value);
        const errEl = document.getElementById('testUserError');
        errEl.style.display = 'none';
        if (!name) { errEl.textContent = 'Enter a name'; errEl.style.display = 'block'; return; }
        if (initials.length < 2 || initials.length > 3 || !/^[A-Z]+$/.test(initials)) { errEl.textContent = 'Initials: 2-3 letters'; errEl.style.display = 'block'; return; }
        for (const uid in playersData) { if (playersData[uid].initials === initials) { errEl.textContent = `"${initials}" is already taken`; errEl.style.display = 'block'; return; } }
        const avail = [];
        for (let r = 0; r < 10; r++) for (let c = 0; c < 10; c++) { const k = `${r}_${c}`; if (!gridData[k]) avail.push(k); }
        if (avail.length < boxCount) { errEl.textContent = 'Not enough boxes available'; errEl.style.display = 'block'; return; }
        const fakeUid = 'test_' + Math.random().toString(36).substr(2, 12);
        const picks = [...avail].sort(() => Math.random() - 0.5).slice(0, boxCount);
        const up = {};
        up[`${GAME_REF}/players/${fakeUid}`] = { name, initials, boxCount, email: `${name.toLowerCase()}@test.com`, isTest: true };
        picks.forEach(k => { up[`${GAME_REF}/grid/${k}`] = { uid: fakeUid, initials, name }; });
        await db.ref().update(up);
        testUserIds.push(fakeUid);
        showToast(`Test user "${name}" (${initials}) added with ${boxCount} boxes`);
        document.getElementById('testUserName').value = '';
        document.getElementById('testUserInitials').value = '';
        buildTestBoxSelect(); renderTestUsersList();
    }

    async function fillGridWithTestUsers() {
        const avail = [];
        for (let r = 0; r < 10; r++) for (let c = 0; c < 10; c++) { const k = `${r}_${c}`; if (!gridData[k]) avail.push(k); }
        if (avail.length === 0) { showToast('Grid is already full!'); return; }
        const names = ['Alice','Bob','Carol','Dan','Eve','Frank','Grace','Hank','Iris','Jake','Kate','Leo','Mia','Nate','Olive','Pete','Quinn','Rosa','Sam','Tina'];
        const shuffledAvail = [...avail].sort(() => Math.random() - 0.5);
        const up = {}; let nameIdx = 0; let remaining = shuffledAvail.length;
        while (remaining > 0) {
            const firstName = names[nameIdx % names.length];
            const suffix = nameIdx >= names.length ? (Math.floor(nameIdx / names.length) + 1) : '';
            const fullName = firstName + suffix;
            let init = firstName.substring(0, 2).toUpperCase();
            if (suffix) init = firstName[0].toUpperCase() + suffix;
            let attempt = 0;
            while (isInitialsTaken(init, up) && attempt < 20) { init = String.fromCharCode(65 + Math.floor(Math.random()*26)) + String.fromCharCode(65 + Math.floor(Math.random()*26)); attempt++; }
            const boxCount = Math.min(Math.floor(Math.random() * 5) + 1, remaining);
            const fakeUid = 'test_' + Math.random().toString(36).substr(2, 12);
            const picks = shuffledAvail.splice(0, boxCount);
            up[`${GAME_REF}/players/${fakeUid}`] = { name: fullName, initials: init, boxCount, email: `${fullName.toLowerCase()}@test.com`, isTest: true };
            picks.forEach(k => { up[`${GAME_REF}/grid/${k}`] = { uid: fakeUid, initials: init, name: fullName }; });
            testUserIds.push(fakeUid); remaining = shuffledAvail.length; nameIdx++;
        }
        await db.ref().update(up);
        showToast(`Filled grid with test users!`);
        buildTestBoxSelect(); renderTestUsersList();
    }

    function isInitialsTaken(init, pendingUpdates) {
        for (const uid in playersData) { if (playersData[uid].initials === init) return true; }
        for (const key in pendingUpdates) { if (key.includes('/players/') && pendingUpdates[key].initials === init) return true; }
        return false;
    }

    async function removeAllTestUsers() {
        if (testUserIds.length === 0) { showToast('No test users to remove'); return; }
        const up = {};
        for (const uid of testUserIds) up[`${GAME_REF}/players/${uid}`] = null;
        for (const key in gridData) { if (gridData[key]?.uid?.startsWith('test_')) up[`${GAME_REF}/grid/${key}`] = null; }
        for (const uid in playersData) { if (uid.startsWith('test_') || playersData[uid].isTest) up[`${GAME_REF}/players/${uid}`] = null; }
        await db.ref().update(up);
        const count = testUserIds.length; testUserIds = [];
        showToast(`Removed ${count} test user${count > 1 ? 's' : ''}`);
        renderTestUsersList();
    }

    async function removeTestUser(uid) {
        const up = {}; up[`${GAME_REF}/players/${uid}`] = null;
        for (const key in gridData) { if (gridData[key]?.uid === uid) up[`${GAME_REF}/grid/${key}`] = null; }
        await db.ref().update(up);
        testUserIds = testUserIds.filter(id => id !== uid);
        showToast('Test user removed');
        buildTestBoxSelect(); renderTestUsersList();
    }

    function renderTestUsersList() {
        const el = document.getElementById('testUsersList');
        const testPlayers = Object.entries(playersData).filter(([uid, d]) => uid.startsWith('test_') || d.isTest);
        if (testPlayers.length === 0) { el.innerHTML = '<span style="color:var(--text-muted);font-size:0.75rem;">No test users yet</span>'; return; }
        el.innerHTML = '<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">Test Users (' + testPlayers.length + ')</div>' +
            testPlayers.map(([uid, d]) =>
                `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
                    <span class="initials-badge" style="background:var(--bg-tertiary);border-radius:4px;padding:2px 8px;font-weight:700;font-size:0.72rem;letter-spacing:1px;">${esc(d.initials)}</span>
                    <span style="flex:1;">${esc(d.name)}</span>
                    <span style="color:var(--text-muted);font-size:0.72rem;">${d.boxCount} boxes</span>
                    <button onclick="removeTestUser('${uid}')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:0.82rem;padding:2px 6px;">‚úï</button>
                </div>`
            ).join('');
    }

    </script>
</body>
</html>
