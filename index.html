<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Super Bowl LX Squares</title>
    <meta name="version" content="6.3.5">
    <meta name="gs-app-id" content="sb-squares">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #060614;
            --bg-secondary: #0e0e24;
            --bg-tertiary: #161636;
            --bg-card: #121230;
            --text-primary: #e8e6e3;
            --text-secondary: #9090b0;
            --text-muted: #5a5a7a;
            --pats-blue: #002244;
            --pats-red: #C60C30;
            --pats-silver: #B0B7BC;
            --hawks-blue: #002244;
            --hawks-green: #69BE28;
            --hawks-grey: #A5ACAF;
            --gold: #FFB612;
            --gold-dim: #b8860b;
            --success: #22c55e;
            --danger: #ef4444;
            --accent: #667eea;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ Stadium Atmosphere Background (static) ‚îÄ‚îÄ */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                /* Upper stadium lights - static warm glow */
                radial-gradient(ellipse at 15% 0%, rgba(255,200,60,0.12) 0%, transparent 40%),
                radial-gradient(ellipse at 85% 0%, rgba(255,200,60,0.10) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 0%, rgba(255,220,120,0.08) 0%, transparent 35%),
                /* Team color zones */
                radial-gradient(ellipse at 5% 50%, rgba(0, 34, 68, 0.55) 0%, transparent 50%),
                radial-gradient(ellipse at 95% 50%, rgba(0, 34, 68, 0.35) 0%, transparent 50%),
                radial-gradient(ellipse at 95% 55%, rgba(105, 190, 40, 0.18) 0%, transparent 45%),
                /* Field green undertone at bottom */
                radial-gradient(ellipse at 50% 100%, rgba(30, 80, 30, 0.15) 0%, transparent 50%),
                /* Center vignette */
                radial-gradient(ellipse at 50% 50%, transparent 30%, rgba(0,0,0,0.4) 100%);
            pointer-events: none;
            z-index: 0;
        }
        /* Subtle field yard lines */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background:
                repeating-linear-gradient(90deg, transparent, transparent 9.7%, rgba(255,255,255,0.025) 9.7%, rgba(255,255,255,0.025) 10.3%);
            pointer-events: none;
            z-index: 0;
        }
        .app-container {
            position: relative; z-index: 1;
            max-width: 820px; margin: 0 auto; padding: 12px 12px 40px;
        }

        /* ‚îÄ‚îÄ Header with Logos ‚îÄ‚îÄ */
        .header { text-align: center; padding: 16px 0 12px; position: relative; }
        .sb-logo {
            width: 64px; height: 64px; margin: 0 auto 6px;
            background: linear-gradient(135deg, var(--gold), #fff8dc, var(--gold));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(255,182,18,0.3), 0 0 60px rgba(255,182,18,0.1);
            animation: logoPulse 3s ease-in-out infinite;
        }
        @keyframes logoPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(255,182,18,0.3), 0 0 60px rgba(255,182,18,0.1); }
            50% { box-shadow: 0 0 40px rgba(255,182,18,0.5), 0 0 80px rgba(255,182,18,0.2); }
        }
        .sb-logo svg { width: 38px; height: 38px; }
        .header h1 {
            font-family: 'Bebas Neue', sans-serif; font-size: 2.4rem; letter-spacing: 4px;
            background: linear-gradient(135deg, var(--gold), #fff8dc, var(--gold), #fff8dc);
            background-size: 200% 100%;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1;
            animation: shimmer 3s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .header .subtitle {
            font-size: 0.78rem; color: var(--text-secondary); margin-top: 2px;
            letter-spacing: 2px; text-transform: uppercase;
        }
        .header .matchup {
            display: flex; align-items: center; justify-content: center; gap: 16px;
            margin-top: 14px; font-family: 'Bebas Neue', sans-serif;
        }
        .team-logo-wrap {
            display: flex; align-items: center; gap: 10px;
        }
        .team-logo {
            width: 44px; height: 44px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.4);
            flex-shrink: 0;
        }
        .team-logo.pats-logo {
            background: linear-gradient(145deg, #002244, #003366);
            border: 2px solid rgba(176,183,188,0.3);
        }
        .team-logo.hawks-logo {
            background: linear-gradient(145deg, #002244, #003060);
            border: 2px solid rgba(105,190,40,0.3);
        }
        .team-logo svg { width: 28px; height: 28px; }
        .team-name {
            font-size: 1.5rem; letter-spacing: 3px;
        }
        .team-pats { color: var(--pats-silver); }
        .team-hawks { color: var(--hawks-green); }
        .vs-badge {
            background: linear-gradient(135deg, rgba(255,182,18,0.2), rgba(255,182,18,0.05));
            border: 1px solid rgba(255,182,18,0.3);
            border-radius: 50%; width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Bebas Neue', sans-serif; font-size: 0.85rem;
            color: var(--gold); letter-spacing: 1px; flex-shrink: 0;
        }
        .user-bar { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 12px; font-size: 0.82rem; color: var(--text-secondary); }
        .user-bar img { width: 24px; height: 24px; border-radius: 50%; }
        .user-bar .badge { background: var(--bg-tertiary); border-radius: 4px; padding: 2px 8px; font-weight: 700; font-size: 0.75rem; letter-spacing: 1px; color: var(--accent); }
        .sign-out-btn { background: none; border: 1px solid rgba(255,255,255,0.15); color: var(--text-secondary); padding: 4px 10px; border-radius: 6px; font-size: 0.72rem; cursor: pointer; font-family: 'Outfit', sans-serif; }

        /* ‚îÄ‚îÄ Auth ‚îÄ‚îÄ */
        .auth-section { text-align: center; padding: 60px 20px; }
        .auth-section h2 { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 2px; margin-bottom: 8px; }
        .auth-section p { color: var(--text-secondary); margin-bottom: 28px; font-size: 0.9rem; }
        .google-btn { display: inline-flex; align-items: center; gap: 12px; background: white; color: #333; border: none; border-radius: 8px; padding: 14px 32px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; font-family: 'Outfit', sans-serif; }
        .google-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,255,255,0.12); }
        .google-btn svg { width: 20px; height: 20px; }

        /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
        .tab-nav {
            display: flex; background: var(--bg-secondary); border-radius: 10px; padding: 3px; margin-bottom: 16px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .tab-btn { flex: 1; padding: 10px 6px; border: none; background: transparent; color: var(--text-secondary); font-family: 'Outfit', sans-serif; font-size: 0.82rem; font-weight: 600; cursor: pointer; border-radius: 8px; transition: all 0.2s; }
        .tab-btn.active { background: linear-gradient(135deg, rgba(255,182,18,0.15), rgba(255,182,18,0.05)); color: var(--gold); border: 1px solid rgba(255,182,18,0.2); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ‚îÄ‚îÄ Overlay ‚îÄ‚îÄ */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 9999; animation: fadeIn 0.2s; backdrop-filter: blur(4px); }
        .overlay-card {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
            border: 1px solid rgba(255,182,18,0.15); border-radius: 16px; padding: 28px;
            width: 92%; max-width: 380px; animation: slideUp 0.3s ease-out;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .overlay-card h2 { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; letter-spacing: 2px; margin-bottom: 4px; color: var(--gold); }
        .overlay-card .sub { color: var(--text-secondary); font-size: 0.82rem; margin-bottom: 18px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 11px 12px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text-primary); font-family: 'Outfit', sans-serif; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 2px rgba(255,182,18,0.1); }
        .form-group .helper { font-size: 0.72rem; color: var(--text-muted); margin-top: 3px; }
        .form-group .error-text { font-size: 0.72rem; color: var(--danger); margin-top: 3px; display: none; }
        .btn-gold { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #1a1a1a; border: none; border-radius: 8px; padding: 13px 24px; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 0.95rem; cursor: pointer; width: 100%; transition: transform 0.1s, box-shadow 0.1s; margin-top: 4px; }
        .btn-gold:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(255,182,18,0.3); }
        .btn-gold:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
        .grid-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.82rem; color: var(--text-secondary); }
        .grid-info .boxes-left { color: var(--gold); font-weight: 600; }
        .grid-container { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 6px; }
        .team-label-top {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 3px;
            color: var(--pats-silver); margin-bottom: 6px; padding-left: 56px;
        }
        .team-label-top .mini-logo { width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .team-label-top .mini-logo.pats { background: var(--pats-blue); }
        .team-label-top .mini-logo svg { width: 13px; height: 13px; }
        .grid-outer { display: inline-flex; align-items: stretch; min-width: 100%; }
        .team-label-side {
            writing-mode: vertical-lr; transform: rotate(180deg);
            font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 3px;
            color: var(--hawks-green); display: flex; align-items: center; justify-content: center;
            padding-right: 6px; min-width: 24px; gap: 6px;
        }
        .squares-grid { border-collapse: separate; border-spacing: 2px; flex: 1; }
        .squares-grid th { font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; letter-spacing: 1px; }
        .squares-grid th, .squares-grid td { width: 48px; height: 42px; text-align: center; vertical-align: middle; }
        .squares-grid .corner-cell {
            background: linear-gradient(135deg, rgba(255,182,18,0.1), transparent);
            border-radius: 4px; position: relative;
        }
        .squares-grid .corner-cell::after {
            content: 'üèà'; font-size: 1rem; position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
        }
        .squares-grid .col-header {
            background: linear-gradient(180deg, #002244, #001a33); color: var(--pats-silver);
            border-radius: 4px; min-width: 42px;
            border-bottom: 2px solid rgba(198,12,48,0.4);
        }
        .squares-grid .col-header.has-number { background: linear-gradient(180deg, #003366, #002244); color: white; border-bottom-color: rgba(198,12,48,0.6); }
        .squares-grid .row-header {
            background: linear-gradient(90deg, #0d2d1a, #0a2214); color: var(--hawks-green);
            border-radius: 4px; padding: 0 6px; min-width: 42px;
            border-right: 2px solid rgba(105,190,40,0.3);
        }
        .squares-grid .row-header.has-number { background: linear-gradient(90deg, #1a4c2a, #0d3d1a); color: white; border-right-color: rgba(105,190,40,0.5); }

        /* ‚îÄ‚îÄ Cells ‚îÄ‚îÄ */
        .squares-grid td.cell { border-radius: 3px; cursor: default; transition: all 0.15s; font-weight: 700; font-size: 0.72rem; position: relative; }
        .squares-grid td.cell.empty {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.07);
        }
        .squares-grid td.cell.taken {
            background: linear-gradient(135deg, rgba(30,30,60,0.8), rgba(20,20,50,0.8));
            color: var(--text-secondary); border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .squares-grid td.cell.mine {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.35), rgba(102, 126, 234, 0.2));
            color: #a0baff; border: 1px solid rgba(102, 126, 234, 0.4);
            box-shadow: inset 0 0 6px rgba(102,126,234,0.15);
        }
        .squares-grid td.cell.winner-cell {
            background: linear-gradient(135deg, rgba(255, 182, 18, 0.4), rgba(255, 182, 18, 0.2)) !important;
            color: var(--gold) !important;
            border: 1px solid rgba(255, 182, 18, 0.5) !important;
            animation: winPulse 2s ease-in-out infinite;
            box-shadow: 0 0 8px rgba(255,182,18,0.2);
        }
        @keyframes winPulse { 0%, 100% { box-shadow: 0 0 4px rgba(255,182,18,0.1); } 50% { box-shadow: 0 0 12px rgba(255,182,18,0.35); } }

        /* ‚îÄ‚îÄ Manual Selection Mode ‚îÄ‚îÄ */
        .select-banner {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.15));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
            animation: fadeIn 0.3s;
        }
        .select-banner .select-info { font-size: 0.85rem; color: var(--text-primary); }
        .select-banner .select-info strong { color: var(--gold); font-size: 1.1rem; }
        .select-banner .select-actions { display: flex; gap: 8px; }
        .btn-sm { padding: 8px 14px; border-radius: 8px; font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 0.78rem; cursor: pointer; border: none; transition: transform 0.1s; }
        .btn-sm:hover { transform: translateY(-1px); }
        .btn-confirm { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #1a1a1a; }
        .btn-confirm:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .btn-cancel-select { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.15); }
        .squares-grid td.cell.selectable {
            cursor: pointer;
            border: 1px dashed rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.06);
            transition: all 0.1s;
        }
        .squares-grid td.cell.selectable:hover {
            background: rgba(102, 126, 234, 0.18);
            border-color: rgba(102, 126, 234, 0.7);
        }
        .squares-grid td.cell.selectable:active {
            background: rgba(102, 126, 234, 0.3);
            transform: scale(0.92);
        }
        .squares-grid td.cell.just-selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.45), rgba(102, 126, 234, 0.25));
            color: #c0d0ff;
            border: 1px solid rgba(102, 126, 234, 0.6);
            animation: selectPop 0.3s ease-out;
            box-shadow: 0 0 8px rgba(102,126,234,0.25);
        }
        @keyframes selectPop { 0% { transform: scale(0.7); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

        .grid-legend { display: flex; gap: 16px; justify-content: center; margin-top: 10px; font-size: 0.72rem; color: var(--text-muted); }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-swatch { width: 14px; height: 14px; border-radius: 3px; }
        .sw-empty { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07); }
        .sw-taken { background: rgba(30,30,60,0.8); border: 1px solid rgba(255,255,255,0.1); }
        .sw-mine { background: rgba(102,126,234,0.3); border: 1px solid rgba(102,126,234,0.4); }
        .sw-winner { background: rgba(255,182,18,0.35); border: 1px solid rgba(255,182,18,0.5); }

        /* ‚îÄ‚îÄ Players ‚îÄ‚îÄ */
        .scores-card {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
            border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; margin-bottom: 16px;
        }
        .scores-card h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; color: var(--gold); margin-bottom: 10px; }
        .quarter-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        @media (min-width: 560px) { .quarter-grid { grid-template-columns: repeat(4, 1fr); } }
        .q-card { background: var(--bg-tertiary); border-radius: 8px; padding: 10px 8px; text-align: center; border: 1px solid rgba(255,255,255,0.04); }
        .q-card .q-label { font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; letter-spacing: 1px; color: var(--text-secondary); }
        .q-card .q-score { font-size: 0.8rem; color: var(--text-primary); margin: 3px 0; font-weight: 600; }
        .q-card .q-box { font-size: 0.7rem; color: var(--text-muted); }
        .q-card .q-winner { font-size: 0.75rem; color: var(--gold); font-weight: 600; margin-top: 2px; }
        .q-card .q-winner.none { color: var(--text-muted); font-weight: 400; }
        .q-card .q-prize { font-size: 0.68rem; color: var(--success); }

        .player-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .player-table th { text-align: left; padding: 8px 10px; color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .player-table td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text-primary); }
        .player-table tr.is-me td { color: #8ea8ff; }
        .player-table .initials-badge { display: inline-block; background: var(--bg-tertiary); border-radius: 4px; padding: 2px 8px; font-weight: 700; font-size: 0.78rem; letter-spacing: 1px; }
        .player-table .winnings { color: var(--success); font-weight: 600; }
        .player-table .winnings.zero { color: var(--text-muted); font-weight: 400; }
        .empty-players { text-align: center; padding: 24px; color: var(--text-muted); font-size: 0.85rem; }

        /* ‚îÄ‚îÄ Admin ‚îÄ‚îÄ */
        .admin-card {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
            border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; margin-bottom: 12px;
        }
        .admin-card h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 2px; color: var(--gold); margin-bottom: 10px; }
        .admin-card p { color: var(--text-secondary); font-size: 0.82rem; margin-bottom: 12px; }
        .btn-admin { background: linear-gradient(135deg, var(--accent), #764ba2); color: white; border: none; border-radius: 8px; padding: 11px 20px; font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 0.88rem; cursor: pointer; transition: transform 0.1s; }
        .btn-admin:hover { transform: translateY(-1px); }
        .btn-admin:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-danger { background: var(--danger); color: white; border: none; border-radius: 8px; padding: 11px 20px; font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 0.88rem; cursor: pointer; }
        .score-inputs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 12px; }
        @media (min-width: 560px) { .score-inputs { grid-template-columns: repeat(4, 1fr); } }
        .score-input-group label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .score-input-group .score-pair { display: flex; gap: 4px; }
        .score-input-group input, .score-input-group select { width: 100%; padding: 8px 6px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text-primary); font-family: 'Outfit', sans-serif; font-size: 0.85rem; text-align: center; }
        .score-input-group input:focus, .score-input-group select:focus { outline: none; border-color: var(--gold); }
        .score-input-group .team-label { font-size: 0.65rem; text-align: center; margin-top: 3px; font-weight: 700; letter-spacing: 1px; }
        .score-input-group .team-label.pats-label { color: #4a90d9; }
        .score-input-group .team-label.hawks-label { color: #69be28; }
        .numbers-preview { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
        .num-chip { background: var(--bg-tertiary); padding: 4px 10px; border-radius: 4px; font-size: 0.78rem; color: var(--text-secondary); font-weight: 600; }
        .admin-btn-row { display: flex; gap: 8px; flex-wrap: wrap; }

        /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
        .toast {
            position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, var(--bg-secondary), #1a1a3a);
            color: var(--text-primary); padding: 12px 24px; border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.08);
            z-index: 10000; animation: toastIn 0.3s ease-out; font-size: 0.88rem;
            white-space: nowrap;
        }
        .toast.toast-success {
            border-left: 3px solid var(--success);
        }
        .toast.toast-complete {
            background: linear-gradient(135deg, rgba(34,197,94,0.2), var(--bg-secondary));
            border: 1px solid rgba(34,197,94,0.3);
            font-weight: 600;
        }
        @keyframes toastIn { from { transform: translateX(-50%) translateY(20px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
        @keyframes inputShake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-6px); } 40%, 80% { transform: translateX(6px); } }
        .shake { animation: inputShake 0.4s ease-out; }
        .spinner { width: 20px; height: 20px; border: 2px solid var(--bg-tertiary); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; vertical-align: middle; margin-right: 6px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .hidden { display: none !important; }

        @media (max-width: 600px) {
            .squares-grid th, .squares-grid td { width: 34px; height: 32px; font-size: 0.62rem; }
            .squares-grid .col-header, .squares-grid .row-header { font-size: 0.82rem; }
            .team-label-top { padding-left: 46px; }
            .team-logo { width: 36px; height: 36px; }
            .team-logo svg { width: 22px; height: 22px; }
            .team-name { font-size: 1.2rem; }
            .sb-logo { width: 52px; height: 52px; }
            .sb-logo svg { width: 30px; height: 30px; }
        }
        @media (min-width: 601px) {
            .squares-grid th, .squares-grid td { width: 52px; height: 44px; }
        }

        /* ‚îÄ‚îÄ Celebration ‚îÄ‚îÄ */
        #confettiCanvas { position: fixed; inset: 0; z-index: 10001; pointer-events: none; }
        .winner-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.88);
            display: flex; align-items: center; justify-content: center;
            z-index: 10002; animation: fadeIn 0.3s; backdrop-filter: blur(6px);
        }
        .winner-card {
            background: linear-gradient(145deg, #1a1a3a, #0e0e24);
            border: 2px solid var(--gold); border-radius: 20px;
            padding: 36px 32px; text-align: center;
            max-width: 380px; width: 90%;
            animation: winnerPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 60px rgba(255, 182, 18, 0.3), 0 0 120px rgba(255, 182, 18, 0.1);
        }
        @keyframes winnerPop { 0% { transform: scale(0.3) rotate(-5deg); opacity: 0; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        .winner-card .trophy { font-size: 3.5rem; margin-bottom: 8px; animation: trophyBounce 1s ease-in-out infinite; }
        @keyframes trophyBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .winner-card .quarter-label { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; letter-spacing: 3px; color: var(--text-secondary); margin-bottom: 4px; }
        .winner-card .winner-name {
            font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; letter-spacing: 2px;
            background: linear-gradient(135deg, var(--gold), #fff8dc, var(--gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1.2; margin-bottom: 4px;
        }
        .winner-card .winner-initials { display: inline-block; background: rgba(255,182,18,0.2); border: 1px solid rgba(255,182,18,0.4); border-radius: 6px; padding: 4px 14px; font-weight: 800; font-size: 1.1rem; letter-spacing: 3px; color: var(--gold); margin-bottom: 12px; }
        .winner-card .winner-score { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; }
        .winner-card .winner-prize { font-size: 1.4rem; font-weight: 700; color: var(--success); margin-bottom: 16px; }
        .winner-card .dismiss-btn { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #1a1a1a; border: none; border-radius: 10px; padding: 12px 36px; font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 1rem; cursor: pointer; transition: transform 0.1s; }
        .winner-card .dismiss-btn:hover { transform: scale(1.05); }
    
        /* ‚îÄ‚îÄ Lobby ‚îÄ‚îÄ */
        .lobby-section { padding: 20px 0; }
        .lobby-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .lobby-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 8px; padding: 28px 16px; border-radius: 16px; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.08); transition: all 0.2s;
            font-family: 'Outfit', sans-serif; text-align: center;
        }
        .lobby-btn:hover { transform: translateY(-2px); }
        .lobby-btn .lobby-icon { font-size: 2.2rem; }
        .lobby-btn .lobby-label { font-family: 'Bebas Neue', sans-serif; font-size: 1.2rem; letter-spacing: 2px; }
        .lobby-btn .lobby-sub { font-size: 0.72rem; color: var(--text-muted); }
        .lobby-btn-create {
            background: linear-gradient(145deg, rgba(255,182,18,0.12), rgba(255,182,18,0.04));
            border-color: rgba(255,182,18,0.2); color: var(--gold);
        }
        .lobby-btn-create:hover { background: linear-gradient(145deg, rgba(255,182,18,0.2), rgba(255,182,18,0.08)); border-color: rgba(255,182,18,0.35); }
        .lobby-btn-join {
            background: linear-gradient(145deg, rgba(102,126,234,0.12), rgba(102,126,234,0.04));
            border-color: rgba(102,126,234,0.2); color: var(--accent);
        }
        .lobby-btn-join:hover { background: linear-gradient(145deg, rgba(102,126,234,0.2), rgba(102,126,234,0.08)); border-color: rgba(102,126,234,0.35); }
        .grid-card {
            background: linear-gradient(145deg, var(--bg-secondary), var(--bg-primary));
            border: 1px solid rgba(255,255,255,0.06); border-radius: 12px;
            padding: 14px 16px; margin-bottom: 8px; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 12px;
        }
        .grid-card:hover { border-color: rgba(255,182,18,0.25); transform: translateY(-1px); }
        .grid-card .gc-icon { font-size: 1.8rem; }
        .grid-card .gc-info { flex: 1; min-width: 0; }
        .grid-card .gc-name { font-weight: 600; font-size: 0.95rem; }
        .grid-card .gc-meta { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }
        .grid-card .gc-code { font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 3px; color: var(--gold); background: rgba(255,182,18,0.1); padding: 2px 10px; border-radius: 6px; }
        .grid-card .gc-admin-badge { font-size: 0.65rem; background: rgba(255,182,18,0.15); color: var(--gold); padding: 2px 6px; border-radius: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .sa-test-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); padding: 8px 12px; border-radius: 6px; font-family: 'Outfit', sans-serif; font-size: 0.78rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
        .sa-test-btn:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: var(--text-primary); }
        .sa-test-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .grid-card .gc-arrow { color: var(--text-muted); font-size: 1.2rem; }
        .no-grids-msg { text-align: center; padding: 40px 20px; color: var(--text-muted); font-size: 0.88rem; }
        .no-grids-msg .no-grids-icon { font-size: 2.5rem; margin-bottom: 8px; display: block; }
        .game-switcher {
            display: flex; align-items: center; gap: 8px; margin-bottom: 12px;
            padding: 8px 12px; background: var(--bg-secondary); border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .game-switcher label { font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; }
        .game-switcher select {
            flex: 1; padding: 6px 10px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; color: var(--text-primary); font-family: 'Outfit', sans-serif; font-size: 0.85rem;
        }
        .game-switcher select:focus { outline: none; border-color: var(--gold); }
        .back-lobby-btn { background: none; border: 1px solid rgba(255,255,255,0.12); color: var(--text-secondary); padding: 5px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; font-family: 'Outfit', sans-serif; white-space: nowrap; }
        .back-lobby-btn:hover { border-color: rgba(255,255,255,0.25); color: var(--text-primary); }
        .game-info-bar {
            display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
            padding: 10px 14px; background: linear-gradient(135deg, rgba(255,182,18,0.08), rgba(255,182,18,0.02));
            border: 1px solid rgba(255,182,18,0.12); border-radius: 10px; font-size: 0.78rem; flex-wrap: wrap;
        }
        .game-info-bar .gib-name { font-weight: 600; color: var(--gold); }
        .game-info-bar .gib-sep { color: var(--text-muted); }
        .game-info-bar .gib-detail { color: var(--text-secondary); }
        .game-info-bar .gib-code {
            margin-left: auto; font-family: 'Bebas Neue', sans-serif; letter-spacing: 3px;
            color: var(--gold); background: rgba(255,182,18,0.12); padding: 2px 10px;
            border-radius: 5px; font-size: 0.9rem; cursor: pointer;
        }
        .game-info-bar .gib-code:hover { background: rgba(255,182,18,0.22); }
        .share-code { font-family: 'Bebas Neue', sans-serif; font-size: 3rem; letter-spacing: 8px; color: var(--gold); margin: 12px 0; }
        .share-url { display: flex; align-items: center; gap: 6px; background: var(--bg-tertiary); border-radius: 8px; padding: 10px 12px; margin: 12px 0; font-size: 0.78rem; color: var(--text-secondary); word-break: break-all; }
        .share-url .copy-url-btn { background: var(--accent); color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 0.72rem; font-weight: 600; cursor: pointer; font-family: 'Outfit', sans-serif; white-space: nowrap; }
        .btn-outline { background: transparent; border: 1px solid rgba(255,255,255,0.15); color: var(--text-secondary); border-radius: 8px; padding: 11px 20px; font-family: 'Outfit', sans-serif; font-weight: 600; font-size: 0.88rem; cursor: pointer; width: 100%; transition: all 0.15s; margin-top: 6px; }
        .btn-outline:hover { border-color: rgba(255,255,255,0.3); color: var(--text-primary); }
        .payout-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .payout-item { text-align: center; }
        .payout-item label { display: block; font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 4px; }
        .payout-item input { width: 100%; padding: 8px 4px; background: var(--bg-tertiary); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text-primary); font-family: 'Outfit', sans-serif; font-size: 0.9rem; text-align: center; }
        .payout-item input:focus { outline: none; border-color: var(--gold); }
        .payout-total { text-align: center; font-size: 0.78rem; margin-top: 6px; }
        .payout-total.valid { color: var(--success); }
        .payout-total.invalid { color: var(--danger); }
        #qrCanvas { margin: 16px auto; display: block; border-radius: 12px; }
        @media (max-width: 600px) { .lobby-actions { grid-template-columns: 1fr; } }

    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <!-- Super Bowl Trophy Logo -->
            <div class="sb-logo">
                <svg viewBox="0 0 64 64" fill="none">
                    <path d="M32 8L36 20H48L38 28L42 40L32 32L22 40L26 28L16 20H28L32 8Z" fill="#1a1a1a" stroke="#b8860b" stroke-width="1"/>
                    <path d="M24 44H40V48H24V44Z" fill="#1a1a1a"/>
                    <path d="M20 48H44V50C44 51.1 43.1 52 42 52H22C20.9 52 20 51.1 20 50V48Z" fill="#1a1a1a"/>
                    <text x="32" y="27" text-anchor="middle" font-size="8" font-weight="bold" fill="#b8860b" font-family="serif">LX</text>
                </svg>
            </div>
            <h1>Super Bowl LX Squares</h1>
            <div class="subtitle">February 8, 2026 &bull; Levi's Stadium</div>

            <div class="matchup">
                <div class="team-logo-wrap">
                    <div class="team-logo pats-logo">
                        <img src="https://a.espncdn.com/i/teamlogos/nfl/500/ne.png" alt="Patriots" style="width:32px;height:32px;object-fit:contain;">
                    </div>
                    <span class="team-name team-pats">PATRIOTS</span>
                </div>
                <div class="vs-badge">VS</div>
                <div class="team-logo-wrap">
                    <span class="team-name team-hawks">SEAHAWKS</span>
                    <div class="team-logo hawks-logo">
                        <img src="https://a.espncdn.com/i/teamlogos/nfl/500/sea.png" alt="Seahawks" style="width:32px;height:32px;object-fit:contain;">
                    </div>
                </div>
            </div>

            <div class="user-bar hidden" id="userBar">
                <img id="userPhoto" src="" alt="">
                <span id="userName"></span>
                <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
            </div>
        </div>

        <div id="authScreen" class="auth-section">
            <h2>Join the Grid</h2>
            <p>Sign in with Google to create or join a squares pool.</p>
            <button class="google-btn" onclick="signIn()">
                <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign in with Google
            </button>
        </div>


        <!-- ‚ïê‚ïê‚ïê LOBBY SCREEN ‚ïê‚ïê‚ïê -->
        <div id="lobbyScreen" class="lobby-section hidden">
            <div class="lobby-actions">
                <div class="lobby-btn lobby-btn-create" onclick="showCreateGameModal()">
                    <div class="lobby-icon">üèüÔ∏è</div>
                    <div class="lobby-label">Create a Grid</div>
                    <div class="lobby-sub">Set up your own pool</div>
                </div>
                <div class="lobby-btn lobby-btn-join" onclick="showJoinGameModal()">
                    <div class="lobby-icon">üéüÔ∏è</div>
                    <div class="lobby-label">Join a Grid</div>
                    <div class="lobby-sub">Enter a 5-letter code</div>
                </div>
            </div>
            <div class="my-grids-section">
                <div style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:var(--text-secondary);margin-bottom:10px;display:flex;align-items:center;gap:8px;">üèà Your Grids</div>
                <div id="myGridsList"></div>
            </div>
            <!-- Super Admin (site owner only) -->
            <div id="superAdminBtn" class="hidden" style="margin-top:24px;text-align:center;">
                <button onclick="openSuperAdmin()" style="background:none;border:1px solid rgba(239,68,68,0.25);color:var(--danger);padding:8px 20px;border-radius:8px;font-family:'Outfit',sans-serif;font-size:0.78rem;font-weight:600;cursor:pointer;letter-spacing:1px;opacity:0.7;transition:opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">üîß Super Admin</button>
            </div>
        </div>

        <div id="mainApp" class="hidden">
            <!-- Game navigation -->
            <div id="gameSwitcher" class="game-switcher hidden">
                <button class="back-lobby-btn" onclick="goToLobby()">‚Üê Lobby</button>
                <label>Grid:</label>
                <select id="gameSwitcherSelect" onchange="switchToGame(this.value)"></select>
            </div>
            <div id="singleGameBack" class="hidden" style="margin-bottom:12px;">
                <button class="back-lobby-btn" onclick="goToLobby()">‚Üê Lobby</button>
            </div>
            <div id="gameInfoBar" class="game-info-bar hidden">
                <span class="gib-name" id="gibName"></span>
                <span class="gib-sep">‚Ä¢</span>
                <span class="gib-detail" id="gibDetail"></span>
                <span class="gib-code" id="gibCode" onclick="showShareModal()" title="Tap to share"></span>
            </div>

            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('grid')">üèà Grid</button>
                <button class="tab-btn" onclick="switchTab('players')">üèÜ Players</button>
                <button class="tab-btn hidden" onclick="switchTab('admin')" id="adminTabBtn">‚öôÔ∏è Admin</button>
            </div>

            <div id="tab-grid" class="tab-content active">
                <!-- Prompt to claim boxes if not yet a player -->
                <div id="claimPrompt" class="hidden" style="margin-bottom:14px;padding:16px;background:linear-gradient(135deg,rgba(255,182,18,0.12),rgba(255,182,18,0.04));border:1px solid rgba(255,182,18,0.2);border-radius:12px;text-align:center;">
                    <div style="font-size:1.4rem;margin-bottom:6px;">üèà</div>
                    <div style="font-weight:600;font-size:0.95rem;margin-bottom:4px;">Ready to play?</div>
                    <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:12px;" id="claimPromptSub">Claim your squares to join this grid.</div>
                    <button class="btn-gold" style="max-width:240px;" onclick="showClaimOverlay()">Claim Your Boxes</button>
                </div>
                <div id="selectBanner" class="select-banner hidden">
                    <div class="select-info">
                        Tap <strong id="selectRemaining">0</strong> more box<span id="selectPlural">es</span> to place your <strong id="selectInitialsLabel"></strong>
                    </div>
                    <div class="select-actions">
                        <button class="btn-sm btn-confirm" id="confirmSelectBtn" onclick="confirmManualSelection()" disabled>Done</button>
                        <button class="btn-sm btn-cancel-select" onclick="cancelManualSelection()">Cancel</button>
                    </div>
                </div>
                <div class="grid-info">
                    <span>Boxes claimed: <strong id="claimedCount">0</strong>/100</span>
                    <span class="boxes-left" id="boxesLeftText">100 remaining</span>
                </div>
                <div class="grid-container">
                    <div class="team-label-top">
                        <span class="mini-logo pats"><img src="https://a.espncdn.com/i/teamlogos/nfl/500/ne.png" alt="" style="width:16px;height:16px;object-fit:contain;"></span>
                        &larr; PATRIOTS &rarr;
                    </div>
                    <div class="grid-outer">
                        <div class="team-label-side">&larr; SEAHAWKS &rarr;</div>
                        <table class="squares-grid" id="squaresGrid"></table>
                    </div>
                </div>
                <div class="grid-legend">
                    <div class="legend-item"><div class="legend-swatch sw-empty"></div> Open</div>
                    <div class="legend-item"><div class="legend-swatch sw-taken"></div> Taken</div>
                    <div class="legend-item"><div class="legend-swatch sw-mine"></div> Yours</div>
                    <div class="legend-item"><div class="legend-swatch sw-winner"></div> Winner</div>
                </div>
                <!-- Add More Boxes -->
                <div id="addMoreBar" class="hidden" style="margin-top:14px;padding:12px 14px;background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(102,126,234,0.04));border:1px solid rgba(102,126,234,0.18);border-radius:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <div style="flex:1;min-width:140px;">
                        <div style="font-size:0.82rem;color:var(--text-primary);">You have <strong id="addMoreCurrent" style="color:var(--accent);">0</strong> boxes</div>
                        <div style="font-size:0.7rem;color:var(--text-muted);margin-top:2px;" id="addMoreCostHint"></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <label style="font-size:0.72rem;color:var(--text-muted);">Add:</label>
                        <select id="addMoreCount" style="padding:6px 8px;background:var(--bg-tertiary);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--text-primary);font-family:'Outfit',sans-serif;font-size:0.85rem;width:60px;text-align:center;" onchange="updateAddMoreHint()"></select>
                    </div>
                    <div style="display:flex;gap:6px;">
                        <button class="btn-sm btn-confirm" onclick="startAddMore('auto')" id="addMoreAutoBtn" title="Random placement">üé≤ Auto</button>
                        <button class="btn-sm" onclick="startAddMore('manual')" style="background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid rgba(255,255,255,0.15);" title="Pick your own">üëÜ Pick</button>
                    </div>
                </div>
            </div>

            <div id="tab-players" class="tab-content">
                <div class="scores-card" id="quarterResultsCard">
                    <h3>Quarter Results</h3>
                    <div class="quarter-grid" id="quarterResults"></div>
                </div>
                <div class="scores-card hidden" id="everyScoreResultsCard">
                    <h3>üèà Score Change Winners</h3>
                    <div id="everyScoreResults"></div>
                    <div id="everyScorePayouts" style="margin-top:14px;"></div>
                </div>
                <div class="scores-card">
                    <h3>Players</h3>
                    <div id="playerTableWrap">
                        <table class="player-table">
                            <thead><tr><th>Player</th><th>Initials</th><th>Boxes</th><th>Cost</th><th>Won</th></tr></thead>
                            <tbody id="playerTableBody"></tbody>
                        </table>
                    </div>
                    <div id="noPlayersMsg" class="empty-players">No players yet</div>
                </div>
            </div>

            <div id="tab-admin" class="tab-content">
                <div class="admin-card">
                    <h3>üì§ Share Grid</h3>
                    <p>Share the code or link so others can join.</p>
                    <button class="btn-admin" onclick="showShareModal()">Show Code &amp; Link</button>
                </div>
                <div class="admin-card">
                    <h3>Grid Numbers</h3>
                    <p id="numbersStatus">Numbers have not been assigned yet.</p>
                    <div id="numbersPreview" class="hidden">
                        <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:4px;">Patriots (columns):</div>
                        <div class="numbers-preview" id="colNumbersPreview"></div>
                        <div style="font-size:0.78rem;color:var(--text-secondary);margin:8px 0 4px;">Seahawks (rows):</div>
                        <div class="numbers-preview" id="rowNumbersPreview"></div>
                    </div>
                    <div class="admin-btn-row" style="margin-top:12px;">
                        <button class="btn-admin" id="assignNumbersBtn" onclick="assignNumbers()">Assign Random Numbers</button>
                        <button class="btn-danger hidden" id="clearNumbersBtn" onclick="clearNumbers()">Clear Numbers</button>
                    </div>
                </div>
                <div class="admin-card" id="adminScoreQuarters">
                    <h3>Enter Scores</h3>
                    <p>Enter the last digit of each team's score at end of each quarter (0-9). This maps directly to the grid.</p>
                    <div class="score-inputs" id="scoreInputs"></div>
                    <button class="btn-admin" onclick="saveScores()">Save Scores</button>
                </div>
                <div class="admin-card hidden" id="adminScoreEvery">
                    <h3>üèà Enter Score Change</h3>
                    <p>Enter the current game score after each scoring play. Last digit of each score maps to the grid.</p>
                    <div id="everyScoreInputArea">
                        <div style="display:flex;gap:8px;margin-bottom:10px;align-items:end;">
                            <div style="flex:1;text-align:center;">
                                <label style="display:block;font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">PAT Score</label>
                                <input type="number" id="evPats" min="0" max="99" value="0" style="width:100%;padding:10px;background:var(--bg-tertiary);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--text-primary);font-size:1.2rem;text-align:center;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;">
                            </div>
                            <div style="flex:0;padding-bottom:8px;font-size:1.2rem;color:var(--text-muted);">‚Äî</div>
                            <div style="flex:1;text-align:center;">
                                <label style="display:block;font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">SEA Score</label>
                                <input type="number" id="evHawks" min="0" max="99" value="0" style="width:100%;padding:10px;background:var(--bg-tertiary);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--text-primary);font-size:1.2rem;text-align:center;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;">
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;margin-bottom:8px;">
                            <div style="flex:1;font-size:0.75rem;color:var(--text-muted);text-align:center;" id="evDigitPreview">Grid: (0, 0)</div>
                        </div>
                        <button class="btn-admin" onclick="addScoreEvent()" id="addScoreEventBtn">Add Score</button>
                    </div>
                    <div id="everyScoreGameOver" class="hidden" style="text-align:center;padding:16px 0;">
                        <div style="font-size:1.1rem;color:var(--gold);font-weight:600;">üèÜ Game Over</div>
                        <div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px;">Final payouts calculated below</div>
                    </div>
                    <div style="margin-top:12px;display:flex;gap:8px;">
                        <button class="btn-danger" onclick="undoLastScoreEvent()" id="undoScoreBtn" style="flex:1;" disabled>‚Ü© Undo Last</button>
                        <button class="btn-admin" onclick="endEveryScoreGame()" id="endGameBtn" style="flex:1;background:var(--gold);color:#000;">üèÅ End Game</button>
                    </div>
                    <div id="scoreEventsList" style="margin-top:14px;"></div>
                </div>
                <div class="admin-card">
                    <h3>üë§ Manage Players</h3>
                    <p>Add boxes for any player. Select a player, choose how many to add, then pick them on the grid.</p>
                    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;align-items:end;">
                        <div style="flex:1;min-width:140px;">
                            <label style="display:block;font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Player</label>
                            <select id="managePlayerSelect" style="width:100%;padding:9px 8px;background:var(--bg-tertiary);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--text-primary);font-family:'Outfit',sans-serif;font-size:0.85rem;" onchange="updateManagePlayerInfo()"></select>
                        </div>
                        <div style="width:70px;">
                            <label style="display:block;font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Add</label>
                            <select id="manageAddCount" style="width:100%;padding:9px 6px;background:var(--bg-tertiary);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:var(--text-primary);font-family:'Outfit',sans-serif;font-size:0.85rem;text-align:center;" onchange="updateManagePlayerInfo()"></select>
                        </div>
                        <button class="btn-admin" onclick="adminAddBoxes()" id="adminAddBoxesBtn" style="white-space:nowrap;">Pick on Grid ‚Üí</button>
                    </div>
                    <div id="managePlayerInfo" style="font-size:0.75rem;color:var(--text-muted);"></div>
                    <div id="managePlayerError" style="font-size:0.72rem;color:var(--danger);margin-top:4px;display:none;"></div>
                </div>
                
                <div class="admin-card">
                    <h3>Danger Zone</h3>
                    <div class="admin-btn-row">
                        <button class="btn-danger" onclick="resetGrid()">Reset Entire Grid</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="confettiCanvas" class="hidden"></canvas>

    <div id="winnerOverlay" class="winner-overlay hidden" onclick="dismissCelebration()">
        <div class="winner-card" onclick="event.stopPropagation()">
            <div class="trophy">üèÜ</div>
            <div class="quarter-label" id="winQuarter"></div>
            <div class="winner-name" id="winName"></div>
            <div class="winner-initials" id="winInitials"></div>
            <div class="winner-score" id="winScore"></div>
            <div class="winner-prize" id="winPrize">$25</div>
            <button class="dismiss-btn" onclick="dismissCelebration()">LET'S GO!</button>
        </div>
    </div>

    <div id="setupOverlay" class="overlay hidden">
        <div class="overlay-card">
            <h2>Claim Your Squares</h2>
            <div class="sub" id="setupSub">Pick your initials and how many boxes you want.</div>
            <div class="form-group">
                <label>Your Initials (2-3 letters)</label>
                <input type="text" id="initialsInput" maxlength="3" placeholder="e.g. DS" autocomplete="off" style="text-transform:uppercase; letter-spacing:2px; font-weight:700;">
                <div class="error-text" id="initialsError"></div>
            </div>
            <div class="form-group">
                <label>Number of Boxes (max 10)</label>
                <select id="boxCountSelect"></select>
                <div class="helper" id="costHelper">$1 per box &bull; Total: <strong id="costPreview">$0</strong></div>
            </div>
            <div class="form-group">
                <label>How do you want to pick?</label>
                <div style="display:flex;gap:8px;margin-top:4px;">
                    <button type="button" id="pickAuto" class="btn-gold" style="flex:1;padding:11px 10px;font-size:0.85rem;" onclick="setPickMethod('auto')">
                        üé≤ Auto Select
                    </button>
                    <button type="button" id="pickManual" class="btn-gold" style="flex:1;padding:11px 10px;font-size:0.85rem;background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid rgba(255,255,255,0.15);" onclick="setPickMethod('manual')">
                        üëÜ Pick My Own
                    </button>
                </div>
            </div>
            <button class="btn-gold" id="claimBtn" onclick="claimBoxes()">Claim Boxes</button>
        </div>
    </div>


    <!-- ‚ïê‚ïê‚ïê CREATE GAME MODAL ‚ïê‚ïê‚ïê -->
    <div id="createGameOverlay" class="overlay hidden">
        <div class="overlay-card" onclick="event.stopPropagation()">
            <h2>üèüÔ∏è Create a Grid</h2>
            <div class="sub">Set up your own Super Bowl squares pool.</div>
            <div class="form-group">
                <label>Grid Name</label>
                <input type="text" id="createGameName" maxlength="40" placeholder="e.g. Family Pool 2026">
            </div>
            <div class="form-group">
                <label>Cost Per Square</label>
                <select id="createCostPerSquare">
                    <option value="0">Free (no cost)</option>
                    <option value="1" selected>$1</option>
                    <option value="2">$2</option>
                    <option value="5">$5</option>
                    <option value="10">$10</option>
                    <option value="20">$20</option>
                    <option value="50">$50</option>
                </select>
                <div class="helper">Total pot: <strong id="createPotPreview">$100</strong> (100 squares)</div>
            </div>
            <div class="form-group">
                <label>Scoring Mode</label>
                <select id="createScoringMode" onchange="updateScoringModeUI()">
                    <option value="quarters" selected>Four Quarters ‚Äî payout at end of each quarter</option>
                    <option value="everyScore">Every Score ‚Äî payout on every score change</option>
                </select>
                <div class="helper" id="scoringModeHelper">Winners determined by last digit of each team's score at the end of each quarter.</div>
            </div>
            <div class="form-group" id="payoutSection">
                <label>Payout Per Quarter ($)</label>
                <div class="payout-grid">
                    <div class="payout-item"><label>Q1</label><input type="number" id="payQ1" value="40" min="0" oninput="updatePayoutTotal()"></div>
                    <div class="payout-item"><label>Q2</label><input type="number" id="payQ2" value="40" min="0" oninput="updatePayoutTotal()"></div>
                    <div class="payout-item"><label>Q3</label><input type="number" id="payQ3" value="40" min="0" oninput="updatePayoutTotal()"></div>
                    <div class="payout-item"><label>Q4</label><input type="number" id="payQ4" value="80" min="0" oninput="updatePayoutTotal()"></div>
                </div>
                <div class="payout-total valid" id="payoutTotal">Total: 100% ‚úì</div>
            </div>
            <button class="btn-gold" id="createGameBtn" onclick="createGame()">Create Grid</button>
            <button class="btn-outline" onclick="closeOverlay('createGameOverlay')">Cancel</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê JOIN GAME MODAL ‚ïê‚ïê‚ïê -->
    <div id="joinGameOverlay" class="overlay hidden">
        <div class="overlay-card" onclick="event.stopPropagation()">
            <h2>üéüÔ∏è Join a Grid</h2>
            <div class="sub">Enter the 5-letter code shared by the grid admin.</div>
            <div class="form-group">
                <label>Grid Code</label>
                <input type="text" id="joinCodeInput" maxlength="5" placeholder="ABCDE" autocomplete="off" style="text-transform:uppercase; letter-spacing:4px; font-weight:700; font-size:1.4rem; text-align:center; font-family:'Bebas Neue',sans-serif;">
                <div class="error-text" id="joinCodeError"></div>
            </div>
            <button class="btn-gold" id="joinGameBtn" onclick="joinGame()">Join Grid</button>
            <button class="btn-outline" onclick="closeOverlay('joinGameOverlay')">Cancel</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SHARE MODAL ‚ïê‚ïê‚ïê -->
    <div id="shareOverlay" class="overlay hidden" onclick="closeOverlay('shareOverlay')">
        <div class="overlay-card" onclick="event.stopPropagation()" style="text-align:center;">
            <h2>üì§ Share This Grid</h2>
            <div class="sub">Send the code or link to friends.</div>
            <div class="share-code" id="shareCode"></div>
            <canvas id="qrCanvas" width="200" height="200"></canvas>
            <div class="share-url">
                <span id="shareUrlText" style="flex:1;text-align:left;"></span>
                <button class="copy-url-btn" onclick="copyShareUrl()">Copy</button>
            </div>
            <button class="btn-outline" onclick="closeOverlay('shareOverlay')" style="margin-top:10px;">Close</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SUPER ADMIN PANEL ‚ïê‚ïê‚ïê -->
    <div id="superAdminOverlay" class="overlay hidden" onclick="closeOverlay('superAdminOverlay')">
        <div class="overlay-card" onclick="event.stopPropagation()" style="max-width:520px;">
            <h2 style="color:var(--danger);">üîß Super Admin</h2>
            <div class="sub">Site-wide grid and player management.</div>

            <!-- Grid selector -->
            <div class="form-group">
                <label>Select Grid</label>
                <select id="saGridSelect" onchange="saLoadGrid()" style="width:100%;padding:10px 12px;background:var(--bg-tertiary);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--text-primary);font-family:'Outfit',sans-serif;font-size:0.9rem;">
                    <option value="">‚Äî Loading grids... ‚Äî</option>
                </select>
            </div>

            <!-- Grid info -->
            <div id="saGridInfo" class="hidden" style="margin-bottom:16px;">
                <div style="background:var(--bg-tertiary);border-radius:10px;padding:14px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div>
                            <div style="font-weight:600;font-size:0.95rem;" id="saGridName"></div>
                            <div style="font-size:0.72rem;color:var(--text-muted);margin-top:2px;" id="saGridMeta"></div>
                        </div>
                        <span style="font-family:'Bebas Neue',sans-serif;letter-spacing:3px;color:var(--gold);font-size:1rem;background:rgba(255,182,18,0.1);padding:2px 10px;border-radius:6px;" id="saGridCode"></span>
                    </div>
                    <button onclick="saDeleteGrid()" style="background:var(--danger);color:white;border:none;border-radius:6px;padding:8px 16px;font-family:'Outfit',sans-serif;font-weight:600;font-size:0.78rem;cursor:pointer;width:100%;">üóëÔ∏è Delete This Grid</button>
                </div>

                <!-- Players list -->
                <div style="font-family:'Bebas Neue',sans-serif;font-size:0.95rem;letter-spacing:2px;color:var(--text-secondary);margin-bottom:8px;">Players</div>
                <div id="saPlayersList" style="max-height:300px;overflow-y:auto;"></div>

                <!-- Test Mode -->
                <div style="margin-top:16px;border-top:1px solid rgba(255,255,255,0.08);padding-top:14px;">
                    <div style="font-family:'Bebas Neue',sans-serif;font-size:0.95rem;letter-spacing:2px;color:var(--danger);margin-bottom:8px;">üß™ Test Mode</div>
                    <div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:10px;">Fill grid with test players and simulate scoring. Test data can be cleared.</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button onclick="saFillTestPlayers()" id="saFillBtn" class="sa-test-btn" style="flex:1;">üë• Fill Grid</button>
                        <button onclick="saAssignTestNumbers()" id="saNumBtn" class="sa-test-btn" style="flex:1;">üî¢ Assign Numbers</button>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;">
                        <button onclick="saSimulateScore()" id="saSimScoreBtn" class="sa-test-btn" style="flex:1;">üèà Sim Score</button>
                        <button onclick="saSimulateFullGame()" id="saSimFullBtn" class="sa-test-btn" style="flex:1;">‚ö° Sim Full Game</button>
                    </div>
                    <div id="saTestStatus" style="margin-top:8px;font-size:0.75rem;color:var(--text-muted);text-align:center;"></div>
                    <button onclick="saClearTestData()" class="sa-test-btn" style="width:100%;margin-top:8px;background:rgba(239,68,68,0.15);color:var(--danger);border-color:rgba(239,68,68,0.3);">üóëÔ∏è Clear Test Data</button>
                </div>
            </div>

            <button class="btn-outline" onclick="closeOverlay('superAdminOverlay')">Close</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CONFIG
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const GAME_REF = 'sb-squares-lx';

    firebase.initializeApp({
        apiKey: "AIzaSyBQVwn8vOrFTzLlm2MYIPBwgZV2xR9AuhM",
        authDomain: "word-boxing.firebaseapp.com",
        databaseURL: "https://word-boxing-default-rtdb.firebaseio.com",
        projectId: "word-boxing",
        storageBucket: "word-boxing.appspot.com",
        messagingSenderId: "932356027174",
        appId: "1:932356027174:web:0c1c9eeeca785cb49a0d8f"
    });
    const auth = firebase.auth();
    const db   = firebase.database();

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let currentUser = null;
    let currentGameId = null, currentGameConfig = null, isGameAdmin = false;
    let gridData = {}, playersData = {};
    let colNumbers = null, rowNumbers = null, numbersAssigned = false;
    let scores = { q1: null, q2: null, q3: null, q4: null };
    let scoreEvents = []; // For everyScore mode
    let gameEnded = false; // For everyScore mode
    let myGames = {};
    let gameListeners = [];
    let pickMethod = 'auto';
    let manualSelectMode = false, manualInitials = '', manualBoxTarget = 0, manualPicks = [];
    let isAddMoreMode = false, addMoreOriginalCount = 0;
    let adminActingAsUid = null, adminActingAsData = null;
    let celebrationQueue = [], confettiAnimId = null, confettiPieces = [], audioCtx = null;
    let pendingJoinCode = null;

    // ‚îÄ‚îÄ Deep Link ‚îÄ‚îÄ
    (function checkDeepLink() {
        const params = new URLSearchParams(window.location.search);
        const code = (params.get('code') || '').toUpperCase().trim();
        if (code && /^[A-Z]{5}$/.test(code)) pendingJoinCode = code;
    })();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SOUND EFFECTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function getAudioCtx() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return audioCtx; }
    function playTapSound() { try { const ctx=getAudioCtx(),now=ctx.currentTime,o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(880,now); o.frequency.exponentialRampToValueAtTime(440,now+0.08); g.gain.setValueAtTime(0.15,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.1); o.connect(g); g.connect(ctx.destination); o.start(now); o.stop(now+0.12); } catch(e){} }
    function playUndoSound() { try { const ctx=getAudioCtx(),now=ctx.currentTime,o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(440,now); o.frequency.exponentialRampToValueAtTime(220,now+0.1); g.gain.setValueAtTime(0.12,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.12); o.connect(g); g.connect(ctx.destination); o.start(now); o.stop(now+0.14); } catch(e){} }
    function playCompletionSound() { try { const ctx=getAudioCtx(),now=ctx.currentTime; [{freq:659.25,start:0,dur:0.12},{freq:783.99,start:0.1,dur:0.12},{freq:987.77,start:0.2,dur:0.12},{freq:1318.5,start:0.32,dur:0.35},{freq:987.77,start:0.32,dur:0.35}].forEach(n=>{const o=ctx.createOscillator(),g=ctx.createGain(); o.type='triangle'; o.frequency.value=n.freq; g.gain.setValueAtTime(0,now+n.start); g.gain.linearRampToValueAtTime(0.18,now+n.start+0.02); g.gain.exponentialRampToValueAtTime(0.001,now+n.start+n.dur); o.connect(g); g.connect(ctx.destination); o.start(now+n.start); o.stop(now+n.start+n.dur+0.05);}); } catch(e){} }
    function playVictorySound() { try { const ctx=getAudioCtx(),now=ctx.currentTime; [{freq:523.25,start:0,dur:0.15},{freq:659.25,start:0.12,dur:0.15},{freq:783.99,start:0.24,dur:0.15},{freq:1046.5,start:0.38,dur:0.4},{freq:783.99,start:0.38,dur:0.4},{freq:659.25,start:0.38,dur:0.4}].forEach(n=>{const o=ctx.createOscillator(),g=ctx.createGain(); o.type='square'; o.frequency.value=n.freq; g.gain.setValueAtTime(0,now+n.start); g.gain.linearRampToValueAtTime(0.12,now+n.start+0.02); g.gain.exponentialRampToValueAtTime(0.001,now+n.start+n.dur); o.connect(g); g.connect(ctx.destination); o.start(now+n.start); o.stop(now+n.start+n.dur+0.05);}); } catch(e){} }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUTH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    function signIn() {
        auth.signInWithPopup(googleProvider).catch(e => {
            // Popup blocked or storage-partitioned browser ‚Äî fall back to redirect
            console.log('Popup failed, trying redirect:', e.code);
            auth.signInWithRedirect(googleProvider);
        });
    }
    function signOut() { detachGameListeners(); currentGameId = null; myGames = {}; auth.signOut(); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  LEGACY MIGRATION ‚Äî v5.x flat structure ‚Üí v6.0 games/{id}/
    //  Checks if legacy data exists at sb-squares-lx/grid (flat)
    //  and migrates it into a proper game entry, preserving all data.
    //  Only runs once ‚Äî sets sb-squares-lx/migrated = true when done.
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const LEGACY_ADMIN_EMAIL = 'stewartdavidp@gmail.com';
    const SUPER_ADMIN_EMAIL = 'stewartdavidp@gmail.com';
    const LEGACY_GAME_NAME = 'SB LX Original Grid';

    async function migrateLegacyData() {
        // Check if already migrated
        const migratedSnap = await db.ref(`${GAME_REF}/migrated`).once('value');
        if (migratedSnap.val()) return; // already done

        // Check if legacy data exists (flat grid at root level)
        const legacyGridSnap = await db.ref(`${GAME_REF}/grid`).once('value');
        const legacyGrid = legacyGridSnap.val();
        if (!legacyGrid) {
            // No legacy data ‚Äî mark migrated so we don't check again
            await db.ref(`${GAME_REF}/migrated`).set(true);
            return;
        }

        console.log('[MIGRATION] Found legacy v5.x data ‚Äî migrating to v6.0 multi-game structure...');

        // Read all legacy data
        const [playersSnap, numbersSnap, scoresSnap] = await Promise.all([
            db.ref(`${GAME_REF}/players`).once('value'),
            db.ref(`${GAME_REF}/numbers`).once('value'),
            db.ref(`${GAME_REF}/scores`).once('value'),
        ]);
        const legacyPlayers = playersSnap.val() || {};
        const legacyNumbers = numbersSnap.val() || null;
        const legacyScores = scoresSnap.val() || null;

        // Figure out who the admin is
        let adminUid = null, adminName = 'Admin';
        for (const [uid, p] of Object.entries(legacyPlayers)) {
            if (p.email === LEGACY_ADMIN_EMAIL) { adminUid = uid; adminName = p.name || 'Admin'; break; }
        }
        // If admin not found in players, use current user if they're the admin
        if (!adminUid && currentUser?.email === LEGACY_ADMIN_EMAIL) {
            adminUid = currentUser.uid; adminName = currentUser.displayName || currentUser.email;
        }
        // Fallback: first player
        if (!adminUid) {
            const firstUid = Object.keys(legacyPlayers)[0];
            if (firstUid) { adminUid = firstUid; adminName = legacyPlayers[firstUid].name || 'Admin'; }
            else { adminUid = currentUser.uid; adminName = currentUser.displayName || 'Admin'; }
        }

        // Generate a code for this game
        let code;
        while (true) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            code = ''; for (let i = 0; i < 5; i++) code += chars[Math.floor(Math.random() * chars.length)];
            const existing = await db.ref(`${GAME_REF}/codes/${code}`).once('value');
            if (!existing.val()) break;
        }

        // Create game ID
        const gameId = db.ref(`${GAME_REF}/games`).push().key;

        // Build the migration update
        const update = {};

        // Game config ‚Äî $1/square, $25/quarter (the v5.x defaults)
        update[`${GAME_REF}/games/${gameId}/config`] = {
            gameName: LEGACY_GAME_NAME,
            code: code,
            costPerSquare: 1,
            payouts: { q1: 25, q2: 25, q3: 25, q4: 25 },
            createdBy: adminUid,
            createdByName: adminName,
            createdAt: Date.now(),
            migratedFromLegacy: true
        };

        // Copy grid data (skip test user cells)
        for (const [key, val] of Object.entries(legacyGrid)) {
            if (val.uid && (val.uid.startsWith('test_'))) continue;
            update[`${GAME_REF}/games/${gameId}/grid/${key}`] = val;
        }

        // Copy players
        for (const [uid, val] of Object.entries(legacyPlayers)) {
            // Skip test users
            if (uid.startsWith('test_') || val.isTest) continue;
            update[`${GAME_REF}/games/${gameId}/players/${uid}`] = val;
            // Add to each player's game list
            update[`${GAME_REF}/users/${uid}/games/${gameId}`] = true;
        }

        // Copy numbers
        if (legacyNumbers) {
            update[`${GAME_REF}/games/${gameId}/numbers`] = legacyNumbers;
        }

        // Copy scores
        if (legacyScores) {
            update[`${GAME_REF}/games/${gameId}/scores`] = legacyScores;
        }

        // Register the code
        update[`${GAME_REF}/codes/${code}`] = gameId;

        // Mark migration complete
        update[`${GAME_REF}/migrated`] = true;

        // Execute migration
        await db.ref().update(update);

        console.log(`[MIGRATION] ‚úÖ Legacy data migrated to game ${gameId} (code: ${code})`);
        console.log(`[MIGRATION] ${Object.keys(legacyGrid).length} grid cells, ${Object.keys(legacyPlayers).length} players migrated`);
        showToast(`Grid migrated to multi-game! Code: ${code}`);
    }

    // Handle redirect result (for browsers that can't use popup)
    auth.getRedirectResult().catch(e => {
        if (e.code !== 'auth/no-auth-event') console.error('Redirect sign-in error:', e);
    });

    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            document.getElementById('userBar').classList.remove('hidden');
            document.getElementById('userName').textContent = user.displayName || user.email;
            document.getElementById('userPhoto').src = user.photoURL || '';
            document.getElementById('authScreen').classList.add('hidden');
            // Run legacy migration before anything else
            try { await migrateLegacyData(); } catch(e) { console.error('[MIGRATION] Error:', e); }
            if (pendingJoinCode) {
                const code = pendingJoinCode; pendingJoinCode = null;
                window.history.replaceState({}, '', window.location.pathname);
                await handleDeepLinkJoin(code);
            } else {
                showLobby();
            }
        } else {
            currentUser = null;
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('lobbyScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('userBar').classList.add('hidden');
        }
    });

    async function handleDeepLinkJoin(code) {
        showToast('Looking up grid...');
        const snap = await db.ref(`${GAME_REF}/codes/${code}`).once('value');
        const gameId = snap.val();
        if (!gameId) { showToast('Grid code not found'); showLobby(); return; }
        await db.ref(`${GAME_REF}/users/${currentUser.uid}/games/${gameId}`).set(true);
        openGame(gameId);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SCREEN MANAGEMENT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showLobby() {
        detachGameListeners(); currentGameId = null;
        document.getElementById('lobbyScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('authScreen').classList.add('hidden');
        // Show super admin button only for site owner
        const saBtn = document.getElementById('superAdminBtn');
        if (saBtn) saBtn.classList.toggle('hidden', !currentUser || currentUser.email !== SUPER_ADMIN_EMAIL);
        loadMyGames();
    }
    function goToLobby() { showLobby(); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  LOBBY ‚Äî My Games
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function loadMyGames() {
        const snap = await db.ref(`${GAME_REF}/users/${currentUser.uid}/games`).once('value');
        const gameIds = snap.val() || {};
        const container = document.getElementById('myGridsList');

        if (Object.keys(gameIds).length === 0) {
            container.innerHTML = '<div class="no-grids-msg"><span class="no-grids-icon">üèà</span>You haven\'t joined any grids yet.<br>Create one or join with a code!</div>';
            myGames = {};
            return;
        }

        myGames = {};
        const promises = Object.keys(gameIds).map(async gid => {
            const gSnap = await db.ref(`${GAME_REF}/games/${gid}/config`).once('value');
            const conf = gSnap.val();
            if (conf) {
                const pSnap = await db.ref(`${GAME_REF}/games/${gid}/players`).once('value');
                const playerCount = pSnap.val() ? Object.keys(pSnap.val()).length : 0;
                const grSnap = await db.ref(`${GAME_REF}/games/${gid}/grid`).once('value');
                const gridCount = grSnap.val() ? Object.keys(grSnap.val()).length : 0;
                myGames[gid] = { ...conf, playerCount, gridCount, gameId: gid };
            }
        });
        await Promise.all(promises);
        renderMyGames();
    }

    function renderMyGames() {
        const container = document.getElementById('myGridsList');
        const entries = Object.entries(myGames);
        if (entries.length === 0) {
            container.innerHTML = '<div class="no-grids-msg"><span class="no-grids-icon">üèà</span>No grids yet.</div>';
            return;
        }
        container.innerHTML = entries
            .sort((a, b) => (b[1].createdAt || 0) - (a[1].createdAt || 0))
            .map(([gid, g]) => {
                const isAdmin = g.createdBy === currentUser.uid;
                const cost = g.costPerSquare || 0;
                const pot = cost * 100;
                return `<div class="grid-card" onclick="openGame('${gid}')">
                    <div class="gc-icon">üèà</div>
                    <div class="gc-info">
                        <div class="gc-name">${esc(g.gameName || 'Unnamed Grid')} ${isAdmin ? '<span class="gc-admin-badge">Admin</span>' : ''}</div>
                        <div class="gc-meta">${g.playerCount || 0} players \u2022 ${g.gridCount || 0}/100 filled${pot > 0 ? ' \u2022 $' + pot + ' pot' : ' \u2022 Free'}</div>
                    </div>
                    <div class="gc-code">${esc(g.code)}</div>
                    <div class="gc-arrow">\u203a</div>
                </div>`;
            }).join('');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CREATE GAME
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showCreateGameModal() {
        document.getElementById('createGameOverlay').classList.remove('hidden');
        document.getElementById('createGameName').value = '';
        document.getElementById('createCostPerSquare').value = '1';
        document.getElementById('payQ1').value = 20; document.getElementById('payQ2').value = 20;
        document.getElementById('payQ3').value = 20; document.getElementById('payQ4').value = 40;
        updatePotPreview(); // This recalculates payouts based on cost
        document.getElementById('createCostPerSquare').onchange = updatePotPreview;
        document.getElementById('createGameName').focus();
    }
    function updatePotPreview() {
        const cost = parseInt(document.getElementById('createCostPerSquare').value) || 0;
        const pot = cost * 100;
        document.getElementById('createPotPreview').textContent = cost > 0 ? `$${pot}` : 'Free';
        // Recalc default payouts: 20/20/20/40 split
        if (pot > 0) {
            document.getElementById('payQ1').value = Math.round(pot * 0.20);
            document.getElementById('payQ2').value = Math.round(pot * 0.20);
            document.getElementById('payQ3').value = Math.round(pot * 0.20);
            document.getElementById('payQ4').value = Math.round(pot * 0.40);
        } else {
            document.getElementById('payQ1').value = 0;
            document.getElementById('payQ2').value = 0;
            document.getElementById('payQ3').value = 0;
            document.getElementById('payQ4').value = 0;
        }
        updatePayoutTotal();
    }
    function updatePayoutTotal() {
        const cost = parseInt(document.getElementById('createCostPerSquare').value) || 0;
        const pot = cost * 100;
        const mode = document.getElementById('createScoringMode').value;
        if (mode === 'everyScore') {
            const el = document.getElementById('payoutTotal');
            el.textContent = pot > 0 ? `Pot: $${pot} ‚Äî divided equally per score change` : 'Free pool';
            el.className = 'payout-total valid';
            return;
        }
        const total = ['payQ1','payQ2','payQ3','payQ4'].reduce((s,id) => s + (parseInt(document.getElementById(id).value) || 0), 0);
        const el = document.getElementById('payoutTotal');
        if (pot === 0) {
            el.textContent = 'Free pool \u2014 no payouts';
            el.className = 'payout-total valid';
        } else if (total === pot) {
            el.textContent = `Total: $${total} of $${pot} \u2713`;
            el.className = 'payout-total valid';
        } else {
            el.textContent = `Total: $${total} \u2014 must equal $${pot}`;
            el.className = 'payout-total invalid';
        }
    }
    function updateScoringModeUI() {
        const mode = document.getElementById('createScoringMode').value;
        const payoutSection = document.getElementById('payoutSection');
        const helper = document.getElementById('scoringModeHelper');
        if (mode === 'everyScore') {
            payoutSection.style.display = 'none';
            helper.textContent = 'Every score change wins! Pot divided equally among all scoring events. Starts with 0-0 kickoff.';
        } else {
            payoutSection.style.display = '';
            helper.textContent = 'Winners determined by last digit of each team\'s score at the end of each quarter.';
        }
        updatePayoutTotal();
    }
    function generateCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
        let code = ''; for (let i = 0; i < 5; i++) code += chars[Math.floor(Math.random() * chars.length)]; return code;
    }
    async function createGame() {
        const name = document.getElementById('createGameName').value.trim();
        if (!name) { showToast('Enter a grid name'); return; }
        const cost = parseInt(document.getElementById('createCostPerSquare').value) || 0;
        const pot = cost * 100;
        const scoringMode = document.getElementById('createScoringMode').value;
        let payouts = { q1: 0, q2: 0, q3: 0, q4: 0 };
        if (scoringMode === 'quarters') {
            const q1 = parseInt(document.getElementById('payQ1').value) || 0;
            const q2 = parseInt(document.getElementById('payQ2').value) || 0;
            const q3 = parseInt(document.getElementById('payQ3').value) || 0;
            const q4 = parseInt(document.getElementById('payQ4').value) || 0;
            if (pot > 0 && q1 + q2 + q3 + q4 !== pot) { showToast(`Payouts must total $${pot}`); return; }
            payouts = { q1, q2, q3, q4 };
        }
        const btn = document.getElementById('createGameBtn');
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Creating...';
        try {
            let code, exists = true;
            while (exists) { code = generateCode(); const s = await db.ref(`${GAME_REF}/codes/${code}`).once('value'); exists = s.val() !== null; }
            const gameId = db.ref(`${GAME_REF}/games`).push().key;
            const config = { gameName: name, code, costPerSquare: cost, payouts, scoringMode, createdBy: currentUser.uid, createdByName: currentUser.displayName || currentUser.email, createdAt: Date.now() };
            const updates = {
                [`${GAME_REF}/games/${gameId}/config`]: config,
                [`${GAME_REF}/codes/${code}`]: gameId,
                [`${GAME_REF}/users/${currentUser.uid}/games/${gameId}`]: true
            };
            await db.ref().update(updates);
            closeOverlay('createGameOverlay');
            showToast('Grid created! \ud83c\udfc8');
            openGame(gameId);
        } catch (e) { showToast('Error: ' + e.message); }
        finally { btn.disabled = false; btn.textContent = 'Create Grid'; }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  JOIN GAME
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showJoinGameModal() {
        document.getElementById('joinGameOverlay').classList.remove('hidden');
        document.getElementById('joinCodeInput').value = '';
        document.getElementById('joinCodeError').style.display = 'none';
        document.getElementById('joinCodeInput').focus();
    }
    async function joinGame() {
        const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
        const err = document.getElementById('joinCodeError');
        err.style.display = 'none';
        if (!code || code.length !== 5) { err.textContent = 'Enter a 5-letter code'; err.style.display = 'block'; return; }
        const btn = document.getElementById('joinGameBtn');
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Joining...';
        try {
            const snap = await db.ref(`${GAME_REF}/codes/${code}`).once('value');
            const gameId = snap.val();
            if (!gameId) { err.textContent = 'Code not found'; err.style.display = 'block'; return; }
            await db.ref(`${GAME_REF}/users/${currentUser.uid}/games/${gameId}`).set(true);
            closeOverlay('joinGameOverlay');
            showToast('Joined the grid! \ud83c\udf89');
            openGame(gameId);
        } catch (e) { showToast('Error: ' + e.message); }
        finally { btn.disabled = false; btn.textContent = 'Join Grid'; }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  OPEN GAME
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function openGame(gameId) {
        detachGameListeners(); currentGameId = gameId;
        const confSnap = await db.ref(`${GAME_REF}/games/${gameId}/config`).once('value');
        currentGameConfig = confSnap.val();
        if (!currentGameConfig) { showToast('Game not found'); showLobby(); return; }
        isGameAdmin = currentGameConfig.createdBy === currentUser.uid;
        document.getElementById('lobbyScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('authScreen').classList.add('hidden');
        const cost = currentGameConfig.costPerSquare || 0;
        document.getElementById('gibName').textContent = currentGameConfig.gameName;
        document.getElementById('gibDetail').textContent = cost > 0 ? `$${cost}/sq \u2022 $${cost * 100} pot` : 'Free';
        document.getElementById('gibCode').textContent = currentGameConfig.code;
        document.getElementById('gameInfoBar').classList.remove('hidden');
        document.getElementById('adminTabBtn').classList.toggle('hidden', !isGameAdmin);
        // Show correct scoring UI based on mode
        const mode = currentGameConfig.scoringMode || 'quarters';
        document.getElementById('adminScoreQuarters').classList.toggle('hidden', mode !== 'quarters');
        document.getElementById('adminScoreEvery').classList.toggle('hidden', mode !== 'everyScore');
        document.getElementById('quarterResultsCard').classList.toggle('hidden', mode !== 'quarters');
        document.getElementById('everyScoreResultsCard').classList.toggle('hidden', mode !== 'everyScore');
        await buildGameSwitcher();
        switchTab('grid'); renderGrid(); buildScoreInputs();
        attachGameListeners(gameId);
    }

    async function buildGameSwitcher() {
        const snap = await db.ref(`${GAME_REF}/users/${currentUser.uid}/games`).once('value');
        const gids = Object.keys(snap.val() || {});
        if (gids.length <= 1) {
            document.getElementById('gameSwitcher').classList.add('hidden');
            document.getElementById('singleGameBack').classList.remove('hidden');
        } else {
            document.getElementById('gameSwitcher').classList.remove('hidden');
            document.getElementById('singleGameBack').classList.add('hidden');
            const sel = document.getElementById('gameSwitcherSelect');
            sel.innerHTML = '';
            for (const gid of gids) {
                const cSnap = await db.ref(`${GAME_REF}/games/${gid}/config/gameName`).once('value');
                const opt = document.createElement('option');
                opt.value = gid; opt.textContent = cSnap.val() || 'Unnamed';
                sel.appendChild(opt);
            }
            sel.value = currentGameId;
        }
    }
    function switchToGame(gameId) { if (gameId && gameId !== currentGameId) openGame(gameId); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SHARE & QR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showShareModal() {
        if (!currentGameConfig) return;
        const code = currentGameConfig.code;
        const url = `${window.location.origin}${window.location.pathname}?code=${code}`;
        document.getElementById('shareCode').textContent = code;
        document.getElementById('shareUrlText').textContent = url;
        document.getElementById('shareOverlay').classList.remove('hidden');
        drawQR(url);
    }
    function copyShareUrl() {
        const url = document.getElementById('shareUrlText').textContent;
        navigator.clipboard.writeText(url).then(() => showToast('Link copied!')).catch(() => showToast('Copy failed'));
    }
    function drawQR(text) {
        const canvas = document.getElementById('qrCanvas');
        const ctx = canvas.getContext('2d'); const size = 200;
        canvas.width = size; canvas.height = size;
        // Simple QR-like visual with finder patterns
        const n = 25;
        const grid = Array.from({length: n}, () => Array(n).fill(false));
        const drawFinder = (sr, sc) => { for (let r=0;r<7;r++) for (let c=0;c<7;c++) { grid[sr+r][sc+c] = r===0||r===6||c===0||c===6||(r>=2&&r<=4&&c>=2&&c<=4); } };
        drawFinder(0, 0); drawFinder(0, n-7); drawFinder(n-7, 0);
        for (let i=8;i<n-8;i++) { grid[6][i]=i%2===0; grid[i][6]=i%2===0; }
        let hash = 0;
        for (let i=0;i<text.length;i++) hash = ((hash<<5)-hash+text.charCodeAt(i))|0;
        let seed = Math.abs(hash);
        for (let r=0;r<n;r++) for (let c=0;c<n;c++) { if (grid[r][c]) continue; if ((r<8&&c<8)||(r<8&&c>=n-8)||(r>=n-8&&c<8)) continue; seed=(seed*1103515245+12345)&0x7fffffff; grid[r][c]=(seed%3)===0; }
        const cellSize = Math.floor(size/(n+6));
        const offset = Math.floor((size-cellSize*n)/2);
        ctx.fillStyle = '#ffffff'; ctx.beginPath();
        if (ctx.roundRect) ctx.roundRect(0,0,size,size,12); else ctx.rect(0,0,size,size);
        ctx.fill();
        ctx.fillStyle = '#0e0e24';
        for (let r=0;r<n;r++) for (let c=0;c<n;c++) if (grid[r][c]) ctx.fillRect(offset+c*cellSize, offset+r*cellSize, cellSize, cellSize);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FIREBASE LISTENERS (per-game)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function detachGameListeners() { gameListeners.forEach(({ref,event,cb}) => ref.off(event,cb)); gameListeners = []; gridData={}; playersData={}; colNumbers=null; rowNumbers=null; numbersAssigned=false; scores={q1:null,q2:null,q3:null,q4:null}; scoreEvents=[]; gameEnded=false; }

    function attachGameListeners(gameId) {
        const g = `${GAME_REF}/games/${gameId}`;
        const gcb = db.ref(`${g}/grid`).on('value', s => { gridData = s.val() || {}; renderGrid(); updateGridInfo(); });
        gameListeners.push({ref:db.ref(`${g}/grid`),event:'value',cb:gcb});
        const pcb = db.ref(`${g}/players`).on('value', s => { playersData = s.val() || {}; checkSetup(); renderPlayers(); });
        gameListeners.push({ref:db.ref(`${g}/players`),event:'value',cb:pcb});
        const ncb = db.ref(`${g}/numbers`).on('value', s => { const v=s.val(); if(v&&v.cols&&v.rows){colNumbers=v.cols;rowNumbers=v.rows;numbersAssigned=true;}else{colNumbers=null;rowNumbers=null;numbersAssigned=false;} renderGrid(); updateNumbersUI(); renderQuarters(); checkKickoffEvent(); });
        gameListeners.push({ref:db.ref(`${g}/numbers`),event:'value',cb:ncb});
        const scb = db.ref(`${g}/scores`).on('value', s => {
            const oldScores={...scores}; scores=s.val()||{q1:null,q2:null,q3:null,q4:null};
            if(numbersAssigned&&!isGameAdmin){const w=[];['q1','q2','q3','q4'].forEach((q,i)=>{const os=oldScores[q],ns=scores[q];const had=os&&os.pats!==undefined&&os.hawks!==undefined;const has=ns&&ns.pats!==undefined&&ns.hawks!==undefined;if(has&&!had){const ci=colNumbers.indexOf(ns.pats),ri=rowNumbers.indexOf(ns.hawks);if(ci!==-1&&ri!==-1){const cd=gridData[`${ri}_${ci}`];if(cd)w.push({quarter:['Q1','Q2','Q3','Q4'][i],name:cd.name,initials:cd.initials,pats:ns.pats,hawks:ns.hawks});}}});if(w.length>0){celebrationQueue=[...w];showNextCelebration();}}
            renderQuarters(); renderPlayers(); renderGrid(); populateScoreInputs();
        });
        gameListeners.push({ref:db.ref(`${g}/scores`),event:'value',cb:scb});
        // Every-score mode listeners
        const secb = db.ref(`${g}/scoreEvents`).on('value', s => {
            const oldLen = scoreEvents.length;
            scoreEvents = s.val() || [];
            // Trigger celebration for non-admin when new events appear
            if (numbersAssigned && !isGameAdmin && scoreEvents.length > oldLen) {
                const newEvents = scoreEvents.slice(oldLen);
                const w = newEvents.map(ev => {
                    const ci = colNumbers.indexOf(ev.pats), ri = rowNumbers.indexOf(ev.hawks);
                    if (ci !== -1 && ri !== -1) { const cd = gridData[`${ri}_${ci}`]; if (cd) return { quarter: `#${ev.seq}`, name: cd.name, initials: cd.initials, pats: ev.pats, hawks: ev.hawks }; }
                    return null;
                }).filter(Boolean);
                if (w.length > 0) { celebrationQueue = [...w]; showNextCelebration(); }
            }
            renderScoreEvents(); renderQuarters(); renderPlayers(); renderGrid();
        });
        gameListeners.push({ref:db.ref(`${g}/scoreEvents`),event:'value',cb:secb});
        const gecb = db.ref(`${g}/gameEnded`).on('value', s => { gameEnded = !!s.val(); renderScoreEvents(); renderQuarters(); renderPlayers(); });
        gameListeners.push({ref:db.ref(`${g}/gameEnded`),event:'value',cb:gecb});
    }

    function gRef(path) { return `${GAME_REF}/games/${currentGameId}/${path}`; }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SETUP / CLAIM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function checkSetup() {
        if(!currentUser||!currentGameId||manualSelectMode||!currentGameConfig) return;
        const isPlayer = !!playersData[currentUser.uid];
        const prompt = document.getElementById('claimPrompt');
        if (!isPlayer) {
            // Show inline prompt on grid tab
            if (prompt) {
                prompt.classList.remove('hidden');
                const cost = currentGameConfig.costPerSquare || 0;
                const sub = document.getElementById('claimPromptSub');
                if (sub) sub.textContent = cost > 0 ? `$${cost} per square \u2022 Claim your boxes to join this grid.` : 'Claim your boxes to join this grid.';
            }
            updateAddMoreBar(false);
        } else {
            if (prompt) prompt.classList.add('hidden');
            document.getElementById('setupOverlay').classList.add('hidden');
            updateAddMoreBar(true);
        }
    }

    function showClaimOverlay() {
        if (!currentGameConfig) return;
        buildBoxSelect();
        document.getElementById('setupOverlay').classList.remove('hidden');
    }

    function buildBoxSelect() {
        const avail=Math.min(10,100-Object.keys(gridData).length); const sel=document.getElementById('boxCountSelect'); sel.innerHTML='';
        const cost=currentGameConfig?.costPerSquare||0;
        for(let i=1;i<=Math.max(avail,1);i++){const o=document.createElement('option');o.value=i;o.textContent=cost>0?`${i} box${i>1?'es':''} ‚Äî $${i*cost}`:`${i} box${i>1?'es':''}`;sel.appendChild(o);}
        sel.value=Math.min(5,avail); updateCost(); sel.onchange=updateCost;
        document.getElementById('costHelper').innerHTML=cost>0?`$${cost} per box \u2022 Total: <strong id="costPreview">$${Math.min(5,avail)*cost}</strong>`:'Free pool \u2022 <strong id="costPreview">No cost</strong>';
        const sub=document.getElementById('setupSub');
        if(sub) sub.textContent=cost>0?`Pick your initials and how many boxes you want. $${cost} per box.`:'Pick your initials and how many boxes you want.';
    }
    function updateCost() { const n=parseInt(document.getElementById('boxCountSelect').value)||0; const c=currentGameConfig?.costPerSquare||0; const el=document.getElementById('costPreview'); if(el) el.textContent=c>0?`$${n*c}`:'Free'; }

    function setPickMethod(method) {
        pickMethod=method; const a=document.getElementById('pickAuto'),m=document.getElementById('pickManual');
        if(method==='auto'){a.style.background='linear-gradient(135deg,var(--gold),var(--gold-dim))';a.style.color='#1a1a1a';a.style.border='none';m.style.background='var(--bg-tertiary)';m.style.color='var(--text-secondary)';m.style.border='1px solid rgba(255,255,255,0.15)';document.getElementById('claimBtn').textContent='Claim Boxes';}
        else{m.style.background='linear-gradient(135deg,var(--gold),var(--gold-dim))';m.style.color='#1a1a1a';m.style.border='none';a.style.background='var(--bg-tertiary)';a.style.color='var(--text-secondary)';a.style.border='1px solid rgba(255,255,255,0.15)';document.getElementById('claimBtn').textContent='Pick on Grid \u2192';}
    }

    async function claimBoxes() {
        const init=document.getElementById('initialsInput').value.trim().toUpperCase(); const count=parseInt(document.getElementById('boxCountSelect').value); const err=document.getElementById('initialsError'); err.style.display='none';
        if(init.length<2||init.length>3){showValidationError('Enter 2-3 letter initials first!');return;} if(!/^[A-Z]+$/.test(init)){showValidationError('Letters only');return;}
        for(const uid in playersData){if(playersData[uid].initials===init){showValidationError(`"${init}" is taken`);return;}}
        const avail=[]; for(let r=0;r<10;r++)for(let c=0;c<10;c++){const k=`${r}_${c}`;if(!gridData[k])avail.push(k);} if(avail.length<count){showToast('Not enough boxes!');return;}
        if(pickMethod==='manual'){manualSelectMode=true;manualInitials=init;manualBoxTarget=count;manualPicks=[];document.getElementById('setupOverlay').classList.add('hidden');switchTab('grid');updateSelectBanner();document.getElementById('selectBanner').classList.remove('hidden');renderGrid();showToast(`Tap ${count} box${count>1?'es':''}`);return;}
        const picks=[...avail].sort(()=>Math.random()-0.5).slice(0,count); const btn=document.getElementById('claimBtn'); btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Claiming...';
        try{const up={};up[gRef(`players/${currentUser.uid}`)]={name:currentUser.displayName||currentUser.email,initials:init,boxCount:count,email:currentUser.email};picks.forEach(k=>{up[gRef(`grid/${k}`)]={uid:currentUser.uid,initials:init,name:currentUser.displayName||currentUser.email};});up[`${GAME_REF}/users/${currentUser.uid}/games/${currentGameId}`]=true;await db.ref().update(up);document.getElementById('setupOverlay').classList.add('hidden');document.getElementById('claimPrompt').classList.add('hidden');showToast(`Claimed ${count} box${count>1?'es':''}! \ud83c\udfc8`);}catch(e){showToast('Error: '+e.message);}finally{btn.disabled=false;btn.textContent='Claim Boxes';}
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MANUAL SELECTION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateSelectBanner() {
        const rem=manualBoxTarget-manualPicks.length; const info=document.querySelector('.select-info'); const btn=document.getElementById('confirmSelectBtn'); if(!info||!btn)return;
        btn.disabled=manualPicks.length!==manualBoxTarget;
        if(rem===0) info.innerHTML=`All <strong>${manualBoxTarget}</strong> box${manualBoxTarget!==1?'es':''} selected for <strong>${esc(manualInitials)}</strong> \u2014 tap Done!`;
        else info.innerHTML=`Tap <strong>${rem}</strong> more box${rem!==1?'es':''} to place your <strong>${esc(manualInitials)}</strong>`;
    }
    function handleCellTap(row,col) {
        if(!manualSelectMode)return;const k=`${row}_${col}`;const idx=manualPicks.indexOf(k);
        if(idx!==-1){manualPicks.splice(idx,1);playUndoSound();updateSelectBanner();renderGrid();return;}
        if(gridData[k]){showToast('Already taken!');return;} if(manualPicks.length>=manualBoxTarget){showToast('All selected! Tap Done.');return;}
        manualPicks.push(k);updateSelectBanner();renderGrid();if(navigator.vibrate)navigator.vibrate(30);
        if(manualPicks.length===manualBoxTarget){playCompletionSound();showToast('\u2705 All filled! Tap Done.',4000,'toast-complete');}else playTapSound();
    }
    async function confirmManualSelection() {
        if(manualPicks.length!==manualBoxTarget)return; const btn=document.getElementById('confirmSelectBtn'); btn.disabled=true; btn.textContent='...';
        try{const up={};const tUid=adminActingAsUid||currentUser.uid;const tName=adminActingAsData?adminActingAsData.name:(currentUser.displayName||currentUser.email);const tEmail=adminActingAsData?(adminActingAsData.email||''):currentUser.email;const total=isAddMoreMode?(addMoreOriginalCount+manualBoxTarget):manualBoxTarget;
        up[gRef(`players/${tUid}`)]={name:tName,initials:manualInitials,boxCount:total,email:tEmail};manualPicks.forEach(k=>{up[gRef(`grid/${k}`)]={uid:tUid,initials:manualInitials,name:tName};});up[`${GAME_REF}/users/${tUid}/games/${currentGameId}`]=true;await db.ref().update(up);showToast(`Claimed ${manualBoxTarget} box${manualBoxTarget>1?'es':''}! \ud83c\udfc8`);}catch(e){showToast('Error: '+e.message);}
        finally{manualSelectMode=false;manualPicks=[];isAddMoreMode=false;addMoreOriginalCount=0;adminActingAsUid=null;adminActingAsData=null;document.getElementById('selectBanner').classList.add('hidden');document.getElementById('claimPrompt').classList.add('hidden');btn.disabled=false;btn.textContent='Done';renderGrid();}
    }
    function cancelManualSelection() { manualSelectMode=false;manualPicks=[];isAddMoreMode=false;addMoreOriginalCount=0;adminActingAsUid=null;adminActingAsData=null;document.getElementById('selectBanner').classList.add('hidden');renderGrid();if(!playersData[currentUser.uid])document.getElementById('setupOverlay').classList.remove('hidden'); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ADD MORE BOXES (for existing players)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateAddMoreBar(show) {
        const bar = document.getElementById('addMoreBar');
        if (!bar) return;
        const gridFull = Object.keys(gridData).length >= 100;
        if (!show || gridFull) { bar.classList.add('hidden'); return; }
        bar.classList.remove('hidden');
        const me = playersData[currentUser.uid];
        if (!me) { bar.classList.add('hidden'); return; }
        document.getElementById('addMoreCurrent').textContent = me.boxCount || 0;
        // Build count select
        const avail = Math.min(10, 100 - Object.keys(gridData).length);
        const sel = document.getElementById('addMoreCount');
        const curVal = parseInt(sel.value) || 1;
        sel.innerHTML = '';
        for (let i = 1; i <= Math.max(avail, 1); i++) {
            const o = document.createElement('option');
            o.value = i; o.textContent = i; sel.appendChild(o);
        }
        sel.value = Math.min(curVal, avail || 1);
        sel.disabled = avail <= 0;
        document.getElementById('addMoreAutoBtn').disabled = avail <= 0;
        updateAddMoreHint();
    }

    function updateAddMoreHint() {
        const cost = currentGameConfig?.costPerSquare || 0;
        const count = parseInt(document.getElementById('addMoreCount')?.value) || 1;
        const hint = document.getElementById('addMoreCostHint');
        if (!hint) return;
        if (cost > 0) {
            hint.textContent = `+${count} = $${count * cost} more`;
        } else {
            hint.textContent = `Add ${count} more box${count > 1 ? 'es' : ''}`;
        }
    }

    async function startAddMore(method) {
        const me = playersData[currentUser.uid];
        if (!me) return;
        const addCount = parseInt(document.getElementById('addMoreCount').value) || 1;
        const avail = [];
        for (let r = 0; r < 10; r++) for (let c = 0; c < 10; c++) { const k = `${r}_${c}`; if (!gridData[k]) avail.push(k); }
        if (avail.length < addCount) { showToast('Not enough boxes available!'); return; }

        if (method === 'manual') {
            // Enter manual pick mode
            isAddMoreMode = true;
            addMoreOriginalCount = me.boxCount;
            manualSelectMode = true;
            manualInitials = me.initials;
            manualBoxTarget = addCount;
            manualPicks = [];
            updateSelectBanner();
            document.getElementById('selectBanner').classList.remove('hidden');
            document.getElementById('addMoreBar').classList.add('hidden');
            renderGrid();
            document.getElementById('selectBanner').scrollIntoView({ behavior: 'smooth', block: 'start' });
            showToast(`Tap ${addCount} box${addCount > 1 ? 'es' : ''} on the grid`);
        } else {
            // Auto-assign
            const picks = [...avail].sort(() => Math.random() - 0.5).slice(0, addCount);
            const newTotal = me.boxCount + addCount;
            try {
                const up = {};
                up[gRef(`players/${currentUser.uid}`)] = { ...me, boxCount: newTotal };
                picks.forEach(k => { up[gRef(`grid/${k}`)] = { uid: currentUser.uid, initials: me.initials, name: me.name }; });
                await db.ref().update(up);
                showToast(`Added ${addCount} box${addCount > 1 ? 'es' : ''}! Now at ${newTotal} total üèà`);
            } catch (e) { showToast('Error: ' + e.message); }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  GRID
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderGrid() {
        const tbl=document.getElementById('squaresGrid');if(!tbl)return;const w=getWinnerCells();
        let h='<tr><th class="corner-cell"></th>';for(let c=0;c<10;c++)h+=`<th class="col-header${numbersAssigned?' has-number':''}">${numbersAssigned?colNumbers[c]:'?'}</th>`;h+='</tr>';
        for(let r=0;r<10;r++){h+=`<tr><th class="row-header${numbersAssigned?' has-number':''}">${numbersAssigned?rowNumbers[r]:'?'}</th>`;
        for(let c=0;c<10;c++){const k=`${r}_${c}`,d=gridData[k],wn=w.includes(k),pp=manualSelectMode&&manualPicks.includes(k);
        if(pp)h+=`<td class="cell just-selected" onclick="handleCellTap(${r},${c})">${esc(manualInitials)}</td>`;
        else if(d){const mine=currentUser&&d.uid===currentUser.uid;let cls=mine?'cell mine':'cell taken';if(wn)cls+=' winner-cell';h+=`<td class="${cls}" title="${esc(d.name)}">${esc(d.initials)}</td>`;}
        else if(manualSelectMode)h+=`<td class="cell selectable" onclick="handleCellTap(${r},${c})"></td>`;
        else h+='<td class="cell empty"></td>';}h+='</tr>';}tbl.innerHTML=h;
    }
    function getWinnerCells(){if(!numbersAssigned)return[];const cells=[];['q1','q2','q3','q4'].forEach(q=>{const s=scores[q];if(s&&s.pats!==undefined&&s.hawks!==undefined){const ci=colNumbers.indexOf(parseInt(s.pats)),ri=rowNumbers.indexOf(parseInt(s.hawks));if(ci!==-1&&ri!==-1)cells.push(`${ri}_${ci}`);}});return cells;}
    function updateGridInfo(){const n=Object.keys(gridData).length;const e1=document.getElementById('claimedCount'),e2=document.getElementById('boxesLeftText');if(e1)e1.textContent=n;if(e2)e2.textContent=n<100?`${100-n} remaining`:'\u2713 GRID FULL';}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  NUMBERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateNumbersUI(){const st=document.getElementById('numbersStatus'),pr=document.getElementById('numbersPreview'),ab=document.getElementById('assignNumbersBtn'),cb=document.getElementById('clearNumbersBtn');if(!st)return;if(numbersAssigned){st.textContent='Numbers assigned!';pr.classList.remove('hidden');document.getElementById('colNumbersPreview').innerHTML=colNumbers.map(n=>`<span class="num-chip">${n}</span>`).join('');document.getElementById('rowNumbersPreview').innerHTML=rowNumbers.map(n=>`<span class="num-chip">${n}</span>`).join('');ab.classList.add('hidden');cb.classList.remove('hidden');}else{const cnt=Object.keys(gridData).length;st.textContent=cnt<100?`Waiting for grid to fill (${cnt}/100)`:'Grid full \u2014 ready!';ab.disabled=cnt<100;pr.classList.add('hidden');ab.classList.remove('hidden');cb.classList.add('hidden');}}
    async function assignNumbers(){if(!await showConfirm('Assign random numbers?'))return;await db.ref(gRef('numbers')).set({cols:shuffle([0,1,2,3,4,5,6,7,8,9]),rows:shuffle([0,1,2,3,4,5,6,7,8,9])});showToast('Numbers assigned!');}
    async function clearNumbers(){if(!await showConfirm('Clear numbers?'))return;await db.ref(gRef('numbers')).remove();showToast('Numbers cleared');}
    function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SCORES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function buildScoreInputs(){const c=document.getElementById('scoreInputs');if(!c)return;const opts='<option value="">-</option>'+[0,1,2,3,4,5,6,7,8,9].map(n=>`<option value="${n}">${n}</option>`).join('');c.innerHTML=['Q1','Q2','Q3','Q4'].map((q,i)=>`<div class="score-input-group"><label>${q}</label><div class="score-pair"><div style="flex:1"><select id="sp${i}">${opts}</select><div class="team-label pats-label">PATRIOTS</div></div><div style="flex:1"><select id="sh${i}">${opts}</select><div class="team-label hawks-label">SEAHAWKS</div></div></div></div>`).join('');}
    function populateScoreInputs(){['q1','q2','q3','q4'].forEach((q,i)=>{const s=scores[q],p=document.getElementById(`sp${i}`),h=document.getElementById(`sh${i}`);if(p&&h){p.value=s?.pats!==undefined?s.pats:'';h.value=s?.hawks!==undefined?s.hawks:'';}});}
    async function saveScores() {
        const ns = {};
        ['q1','q2','q3','q4'].forEach((q,i) => {
            const p = document.getElementById(`sp${i}`).value;
            const h = document.getElementById(`sh${i}`).value;
            ns[q] = (p !== '' && h !== '') ? { pats: +p, hawks: +h } : null;
        });

        // Find which quarters are new (being set for the first time)
        const newQuarters = [];
        ['q1','q2','q3','q4'].forEach((q,i) => {
            const os = scores[q];
            const ns2 = ns[q];
            const had = os && os.pats !== undefined;
            const has = ns2 && ns2.pats !== undefined;
            if (has && !had) newQuarters.push({ q, label: ['Q1','Q2','Q3','Q4'][i], pats: ns2.pats, hawks: ns2.hawks });
        });

        // Confirmation dialog
        if (newQuarters.length > 0) {
            const lines = newQuarters.map(nq => `${nq.label}: Patriots ${nq.pats}, Seahawks ${nq.hawks}`).join('\n');
            if (!await showConfirm(`Set scores?\n\n${lines}`)) return;
        }

        // Determine winners for celebration
        const nw = [];
        if (numbersAssigned) {
            newQuarters.forEach(nq => {
                const ci = colNumbers.indexOf(nq.pats), ri = rowNumbers.indexOf(nq.hawks);
                if (ci !== -1 && ri !== -1) {
                    const cd = gridData[`${ri}_${ci}`];
                    if (cd) nw.push({ quarter: nq.label, name: cd.name, initials: cd.initials, pats: nq.pats, hawks: nq.hawks });
                }
            });
        }

        await db.ref(gRef('scores')).set(ns);

        if (nw.length > 0) {
            celebrationQueue = [...nw];
            showNextCelebration();
        } else {
            showToast('Scores saved!');
        }

        // Check if all 4 quarters are now scored ‚Äî game over
        const allScored = ['q1','q2','q3','q4'].every(q => ns[q] && ns[q].pats !== undefined);
        if (allScored && newQuarters.length > 0) {
            const waitForCelebrations = () => {
                if (celebrationQueue.length > 0 || !document.getElementById('winnerOverlay').classList.contains('hidden')) {
                    setTimeout(waitForCelebrations, 500);
                    return;
                }
                showConfirm('üèÜ All quarters scored ‚Äî game over!\n\nView final payouts on the Players tab?').then(ok => {
                    if (ok) switchTab('players');
                });
            };
            setTimeout(waitForCelebrations, nw.length > 0 ? 500 : 100);
        }
    }

    function renderQuarters() {
        const el = document.getElementById('quarterResults');
        if (!el) return;
        const cost = currentGameConfig?.costPerSquare || 0;
        const pot = cost * 100;
        const payouts = currentGameConfig?.payouts || { q1: 0, q2: 0, q3: 0, q4: 0 };

        el.innerHTML = [{k:'q1',l:'Q1'},{k:'q2',l:'Q2'},{k:'q3',l:'Q3'},{k:'q4',l:'Q4'}].map(q => {
            const s = scores[q.k];
            const qPay = payouts[q.k] || 0;
            const prize = pot > 0 ? `$${qPay}` : '‚Äî';
            let st='‚Äî',bt='',wt='TBD',wc='none';
            if (s && s.pats !== undefined) {
                st = `PAT: ${s.pats}  SEA: ${s.hawks}`;
                if (numbersAssigned) {
                    const pd=+s.pats, hd=+s.hawks; bt = `(${pd}, ${hd})`;
                    const d = gridData[`${rowNumbers.indexOf(hd)}_${colNumbers.indexOf(pd)}`];
                    if (d) { wt = `üèÜ ${esc(d.initials)} ‚Äî ${esc(d.name.split(' ')[0])}`; wc = ''; }
                    else wt = 'Empty box';
                }
            } else if (!numbersAssigned) wt = 'Numbers not set';
            return `<div class="q-card"><div class="q-label">${q.l}</div><div class="q-score">${st}</div><div class="q-box">${bt}</div><div class="q-winner ${wc}">${wt}</div><div class="q-prize">${prize}</div></div>`;
        }).join('');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  EVERY SCORE MODE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Update digit preview as admin types
    document.addEventListener('input', function(e) {
        if (e.target.id === 'evPats' || e.target.id === 'evHawks') {
            const p = parseInt(document.getElementById('evPats').value) || 0;
            const h = parseInt(document.getElementById('evHawks').value) || 0;
            const el = document.getElementById('evDigitPreview');
            if (el) el.textContent = `Grid: (${p % 10}, ${h % 10})`;
        }
    });

    async function addScoreEvent() {
        if (!currentGameId || !numbersAssigned || gameEnded) return;
        const pVal = document.getElementById('evPats').value.trim();
        const hVal = document.getElementById('evHawks').value.trim();
        if (pVal === '' || hVal === '') { showToast('Enter both scores'); return; }
        const pFull = Number(pVal);
        const hFull = Number(hVal);
        if (isNaN(pFull) || isNaN(hFull) || pFull < 0 || hFull < 0) { showToast('Enter valid scores'); return; }
        const pats = pFull % 10, hawks = hFull % 10;
        const seq = scoreEvents.length + 1;
        
        // Determine winner for this score
        const ci = colNumbers.indexOf(pats), ri = rowNumbers.indexOf(hawks);
        let winnerName = 'Empty box', winnerInitials = '', winnerUid = null;
        if (ci !== -1 && ri !== -1) {
            const cd = gridData[`${ri}_${ci}`];
            if (cd) { winnerName = cd.name; winnerInitials = cd.initials; winnerUid = cd.uid; }
        }
        
        const event = { seq, pats, hawks, patsFull: pFull, hawksFull: hFull, winnerName, winnerInitials, winnerUid, timestamp: Date.now() };
        const newEvents = [...scoreEvents, event];
        
        const btn = document.getElementById('addScoreEventBtn');
        btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
        try {
            await db.ref(gRef('scoreEvents')).set(newEvents);
            // Don't clear inputs ‚Äî keep last score so admin only changes what changed
            // Trigger celebration for admin
            if (winnerUid) {
                celebrationQueue = [{ quarter: `Score #${seq}`, name: winnerName, initials: winnerInitials, pats, hawks }];
                showNextCelebration();
            } else {
                showToast(`Score #${seq} recorded`);
            }
        } catch (e) { showToast('Error: ' + e.message); }
        finally { btn.disabled = false; btn.textContent = 'Add Score'; }
    }

    async function undoLastScoreEvent() {
        if (!currentGameId || scoreEvents.length === 0 || gameEnded) return;
        if (!await showConfirm(`Remove last score (#${scoreEvents.length})?`)) return;
        const newEvents = scoreEvents.slice(0, -1);
        await db.ref(gRef('scoreEvents')).set(newEvents.length > 0 ? newEvents : null);
        showToast('Last score removed');
    }

    async function endEveryScoreGame() {
        if (!currentGameId || gameEnded) return;
        if (scoreEvents.length === 0) { showToast('No scores recorded yet'); return; }
        if (!await showConfirm(`End game with ${scoreEvents.length} score event${scoreEvents.length > 1 ? 's' : ''}? This will calculate final payouts.`)) return;
        await db.ref(gRef('gameEnded')).set(true);
        showToast('Game over! Payouts calculated.');
    }

    async function reopenEveryScoreGame() {
        if (!currentGameId || !gameEnded) return;
        if (!await showConfirm('Reopen game? This will remove the game-over status.')) return;
        await db.ref(gRef('gameEnded')).set(null);
        showToast('Game reopened');
    }

    function renderScoreEvents() {
        const mode = currentGameConfig?.scoringMode || 'quarters';
        if (mode !== 'everyScore') return;
        
        // Update admin UI state
        const inputArea = document.getElementById('everyScoreInputArea');
        const gameOverArea = document.getElementById('everyScoreGameOver');
        const undoBtn = document.getElementById('undoScoreBtn');
        const endBtn = document.getElementById('endGameBtn');
        
        if (inputArea) inputArea.classList.toggle('hidden', gameEnded);
        if (gameOverArea) gameOverArea.classList.toggle('hidden', !gameEnded);
        if (undoBtn) { undoBtn.disabled = scoreEvents.length === 0 || gameEnded; }
        
        // Restore inputs from last score event so admin only changes what changed
        if (isGameAdmin && scoreEvents.length > 0) {
            const last = scoreEvents[scoreEvents.length - 1];
            const pEl = document.getElementById('evPats');
            const hEl = document.getElementById('evHawks');
            // Only restore if inputs still show the previous score (don't overwrite mid-edit)
            if (pEl && hEl) {
                const pCur = Number(pEl.value), hCur = Number(hEl.value);
                const prevEvent = scoreEvents.length >= 2 ? scoreEvents[scoreEvents.length - 2] : { patsFull: 0, hawksFull: 0 };
                if (pCur === prevEvent.patsFull && hCur === prevEvent.hawksFull) {
                    pEl.value = last.patsFull;
                    hEl.value = last.hawksFull;
                    const dp = document.getElementById('evDigitPreview');
                    if (dp) dp.textContent = `Grid: (${last.patsFull % 10}, ${last.hawksFull % 10})`;
                }
            }
        }
        if (endBtn) {
            if (gameEnded) {
                endBtn.textContent = '‚Ü© Reopen Game';
                endBtn.style.background = 'var(--bg-tertiary)';
                endBtn.style.color = 'var(--text-primary)';
                endBtn.onclick = reopenEveryScoreGame;
            } else {
                endBtn.textContent = 'üèÅ End Game';
                endBtn.style.background = 'var(--gold)';
                endBtn.style.color = '#000';
                endBtn.onclick = endEveryScoreGame;
            }
        }

        // Render score events list (admin view)
        const listEl = document.getElementById('scoreEventsList');
        if (listEl && scoreEvents.length > 0) {
            listEl.innerHTML = '<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:6px;font-weight:600;">SCORE LOG</div>' +
                scoreEvents.map((ev, i) => {
                    const isFirst = i === 0;
                    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:3px;font-size:0.78rem;">
                        <div><span style="color:var(--text-muted);">#${ev.seq}</span> <strong style="color:var(--text-primary);">${ev.patsFull}-${ev.hawksFull}</strong> <span style="color:var(--text-muted);">(${ev.pats},${ev.hawks})</span></div>
                        <div style="color:var(--gold);font-weight:600;">${ev.winnerUid ? `üèÜ ${esc(ev.winnerInitials)}` : '‚Äî'}</div>
                    </div>`;
                }).join('');
        } else if (listEl) {
            listEl.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.78rem;padding:12px 0;">No scores yet ‚Äî game starts with kickoff (0-0)</div>';
        }

        // Render results view (visible to all)
        const resultsEl = document.getElementById('everyScoreResults');
        const payoutsEl = document.getElementById('everyScorePayouts');
        if (!resultsEl) return;

        if (scoreEvents.length === 0) {
            resultsEl.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.82rem;padding:16px 0;">Waiting for scores...</div>';
            if (payoutsEl) payoutsEl.innerHTML = '';
            return;
        }

        // Winners table
        resultsEl.innerHTML = '<table style="width:100%;font-size:0.78rem;border-collapse:collapse;">' +
            '<tr style="color:var(--text-muted);font-size:0.68rem;text-transform:uppercase;letter-spacing:1px;">' +
            '<th style="text-align:left;padding:4px 6px;">#</th>' +
            '<th style="text-align:left;padding:4px 6px;">Score</th>' +
            '<th style="text-align:left;padding:4px 6px;">Grid</th>' +
            '<th style="text-align:right;padding:4px 6px;">Winner</th></tr>' +
            scoreEvents.map(ev => 
                `<tr style="border-top:1px solid rgba(255,255,255,0.05);">
                    <td style="padding:5px 6px;color:var(--text-muted);">${ev.seq}</td>
                    <td style="padding:5px 6px;font-weight:600;">${ev.patsFull}-${ev.hawksFull}</td>
                    <td style="padding:5px 6px;color:var(--text-muted);">(${ev.pats},${ev.hawks})</td>
                    <td style="padding:5px 6px;text-align:right;color:${ev.winnerUid ? 'var(--gold)' : 'var(--text-muted)'};font-weight:600;">${ev.winnerUid ? `üèÜ ${esc(ev.winnerInitials)} ‚Äî ${esc(ev.winnerName.split(' ')[0])}` : 'Empty'}</td>
                </tr>`
            ).join('') + '</table>';

        // Payout summary
        if (!payoutsEl) return;
        const cost = currentGameConfig?.costPerSquare || 0;
        const pot = cost * 100;
        const totalEvents = scoreEvents.length;
        const perEvent = pot > 0 ? pot / totalEvents : 0;

        if (!gameEnded) {
            payoutsEl.innerHTML = `<div style="text-align:center;padding:10px;background:var(--bg-tertiary);border-radius:8px;font-size:0.78rem;">
                <div style="color:var(--text-muted);">${totalEvents} score${totalEvents > 1 ? 's' : ''} so far</div>
                ${pot > 0 ? `<div style="color:var(--text-secondary);margin-top:4px;">Current rate: <strong style="color:var(--gold);">$${perEvent.toFixed(2)}</strong> per score change</div>
                <div style="color:var(--text-muted);font-size:0.7rem;margin-top:2px;">($${pot} pot √∑ ${totalEvents} events)</div>` : ''}
            </div>`;
            return;
        }

        // Game over ‚Äî calculate final payouts
        const winnerTally = {};
        scoreEvents.forEach(ev => {
            if (ev.winnerUid) {
                if (!winnerTally[ev.winnerUid]) winnerTally[ev.winnerUid] = { name: ev.winnerName, initials: ev.winnerInitials, count: 0 };
                winnerTally[ev.winnerUid].count++;
            }
        });

        const unclaimed = scoreEvents.filter(ev => !ev.winnerUid).length;
        const sorted = Object.values(winnerTally).sort((a, b) => b.count - a.count);
        
        // Verification
        const totalPaidOut = sorted.reduce((s, w) => s + w.count * perEvent, 0);
        const unclaimedAmount = unclaimed * perEvent;

        payoutsEl.innerHTML = `<div style="background:var(--bg-tertiary);border-radius:8px;padding:12px;">
            <div style="font-size:0.72rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:600;">üèÜ Final Payouts</div>
            <div style="display:flex;justify-content:space-between;font-size:0.78rem;color:var(--text-secondary);margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.05);">
                <span>${totalEvents} score events √ó $${perEvent.toFixed(2)} each</span>
                <span style="color:var(--gold);font-weight:600;">$${pot} pot</span>
            </div>
            ${sorted.map(w => 
                `<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:0.82rem;">
                    <div><strong style="color:var(--text-primary);">${esc(w.initials)}</strong> <span style="color:var(--text-muted);">‚Äî ${esc(w.name.split(' ')[0])}</span> <span style="color:var(--text-secondary);">(${w.count}√ó)</span></div>
                    <div style="color:var(--gold);font-weight:700;font-size:0.9rem;">$${(w.count * perEvent).toFixed(2)}</div>
                </div>`
            ).join('')}
            ${unclaimed > 0 ? `<div style="display:flex;justify-content:space-between;padding:5px 0;font-size:0.78rem;color:var(--text-muted);border-top:1px solid rgba(255,255,255,0.05);margin-top:4px;">
                <span>Unclaimed boxes (${unclaimed}√ó)</span><span>$${unclaimedAmount.toFixed(2)}</span></div>` : ''}
            <div style="display:flex;justify-content:space-between;padding:8px 0 0;font-size:0.78rem;border-top:1px solid rgba(255,255,255,0.08);margin-top:6px;">
                <span style="color:var(--text-secondary);font-weight:600;">Total paid out</span>
                <span style="color:${Math.abs(totalPaidOut + unclaimedAmount - pot) < 0.01 ? 'var(--success)' : 'var(--danger)'};font-weight:600;">$${(totalPaidOut + unclaimedAmount).toFixed(2)} ${Math.abs(totalPaidOut + unclaimedAmount - pot) < 0.01 ? '‚úì' : '‚ö†Ô∏è'}</span>
            </div>
        </div>`;
    }

    // Also add initial 0-0 score event when numbers are assigned (if everyScore mode and no events yet)
    function checkKickoffEvent() {
        if (!currentGameId || !isGameAdmin || !numbersAssigned) return;
        const mode = currentGameConfig?.scoringMode || 'quarters';
        if (mode !== 'everyScore' || scoreEvents.length > 0 || gameEnded) return;
        // Auto-prompt for kickoff
        const ci = colNumbers.indexOf(0), ri = rowNumbers.indexOf(0);
        let winnerName = 'Empty box', winnerInitials = '', winnerUid = null;
        if (ci !== -1 && ri !== -1) {
            const cd = gridData[`${ri}_${ci}`];
            if (cd) { winnerName = cd.name; winnerInitials = cd.initials; winnerUid = cd.uid; }
        }
        const kickoff = { seq: 1, pats: 0, hawks: 0, patsFull: 0, hawksFull: 0, winnerName, winnerInitials, winnerUid, timestamp: Date.now() };
        showConfirm('Add kickoff score (0-0) as first winner?').then(ok => {
            if (ok) db.ref(gRef('scoreEvents')).set([kickoff]).then(() => showToast('Kickoff 0-0 recorded! üèà'));
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  EVERY SCORE: getWinnerCells override
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const _origGetWinnerCells = getWinnerCells;
    getWinnerCells = function() {
        const mode = currentGameConfig?.scoringMode || 'quarters';
        if (mode === 'everyScore') {
            if (!numbersAssigned || scoreEvents.length === 0) return [];
            return scoreEvents.map(ev => {
                const ci = colNumbers.indexOf(ev.pats), ri = rowNumbers.indexOf(ev.hawks);
                if (ci !== -1 && ri !== -1) return `${ri}_${ci}`;
                return null;
            }).filter(Boolean);
        }
        return _origGetWinnerCells();
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  PLAYERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderPlayers() {
        const entries = Object.entries(playersData);
        const noMsg = document.getElementById('noPlayersMsg');
        const wrap = document.getElementById('playerTableWrap');
        if (noMsg) noMsg.classList.toggle('hidden', entries.length > 0);
        if (wrap) wrap.classList.toggle('hidden', entries.length === 0);
        if (!entries.length) return;

        const cost = currentGameConfig?.costPerSquare || 0;
        const pot = cost * 100;
        const payouts = currentGameConfig?.payouts || { q1: 0, q2: 0, q3: 0, q4: 0 };

        document.getElementById('playerTableBody').innerHTML = entries
            .map(([uid, d]) => ({ uid, name: d.name||'?', initials: d.initials, cnt: d.boxCount||0, win: calcWin(uid, pot, payouts) }))
            .sort((a,b) => b.cnt - a.cnt)
            .map(p => {
                const me = currentUser && p.uid === currentUser.uid;
                const costStr = cost > 0 ? `$${p.cnt * cost}` : '‚Äî';
                const winFmt = Number.isInteger(p.win) ? `$${p.win}` : `$${p.win.toFixed(2)}`;
                const winStr = p.win > 0 ? winFmt : (cost > 0 ? '$0' : '‚Äî');
                return `<tr class="${me?'is-me':''}"><td>${esc(p.name.split(' ')[0])}${me?' (you)':''}</td><td><span class="initials-badge">${esc(p.initials)}</span></td><td>${p.cnt}</td><td>${costStr}</td><td class="winnings ${p.win?'':'zero'}">${winStr}</td></tr>`;
            }).join('');

        if (isGameAdmin) buildManagePlayerSelect();
    }

    function calcWin(uid, pot, payouts) {
        if (!numbersAssigned || !pot) return 0;
        const mode = currentGameConfig?.scoringMode || 'quarters';
        if (mode === 'everyScore') {
            if (scoreEvents.length === 0) return 0;
            const perEvent = pot / scoreEvents.length;
            return scoreEvents.filter(ev => ev.winnerUid === uid).length * perEvent;
        }
        let t = 0;
        ['q1','q2','q3','q4'].forEach(q => {
            const s = scores[q];
            if (s?.pats !== undefined) {
                const d = gridData[`${rowNumbers.indexOf(+s.hawks)}_${colNumbers.indexOf(+s.pats)}`];
                if (d?.uid === uid) t += (payouts[q] || 0);
            }
        });
        return t;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ADMIN: MANAGE PLAYERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function buildManagePlayerSelect() {
        const sel = document.getElementById('managePlayerSelect');
        if (!sel) return;
        const curVal = sel.value;
        sel.innerHTML = '<option value="">‚Äî Select player ‚Äî</option>';
        Object.entries(playersData)
            .sort((a, b) => (a[1].name || '').localeCompare(b[1].name || ''))
            .forEach(([uid, d]) => {
                const o = document.createElement('option');
                o.value = uid;
                o.textContent = `${d.name || '?'} (${d.initials}) ‚Äî ${d.boxCount} boxes`;
                sel.appendChild(o);
            });
        if (curVal && playersData[curVal]) sel.value = curVal;
        buildManageAddCountSelect();
        updateManagePlayerInfo();
    }

    function buildManageAddCountSelect() {
        const gridUsed = Object.keys(gridData).length;
        const avail = Math.min(10, 100 - gridUsed);
        const sel = document.getElementById('manageAddCount');
        if (!sel) return;
        const curVal = parseInt(sel.value) || 1;
        sel.innerHTML = '';
        for (let i = 1; i <= Math.max(avail, 1); i++) {
            const o = document.createElement('option');
            o.value = i; o.textContent = i;
            sel.appendChild(o);
        }
        sel.value = Math.min(curVal, avail || 1);
        sel.disabled = avail <= 0;
    }

    function updateManagePlayerInfo() {
        const uid = document.getElementById('managePlayerSelect')?.value;
        const info = document.getElementById('managePlayerInfo');
        const btn = document.getElementById('adminAddBoxesBtn');
        if (!uid || !playersData[uid]) { if(info) info.textContent = ''; if(btn) btn.disabled = true; return; }
        const p = playersData[uid];
        const addCount = parseInt(document.getElementById('manageAddCount')?.value) || 1;
        const avail = 100 - Object.keys(gridData).length;
        if (avail <= 0) {
            info.innerHTML = `<strong>${esc(p.name)}</strong> has ${p.boxCount} boxes. <span style="color:var(--danger);">Grid is full.</span>`;
            btn.disabled = true;
        } else {
            info.innerHTML = `<strong>${esc(p.name)}</strong> has ${p.boxCount} ‚Üí will have <strong>${p.boxCount + addCount}</strong>. (${avail} open)`;
            btn.disabled = false;
        }
    }

    function adminAddBoxes() {
        const uid = document.getElementById('managePlayerSelect').value;
        const errEl = document.getElementById('managePlayerError');
        errEl.style.display = 'none';
        if (!uid || !playersData[uid]) { errEl.textContent = 'Select a player first'; errEl.style.display = 'block'; return; }
        const p = playersData[uid];
        const addCount = parseInt(document.getElementById('manageAddCount').value) || 1;
        const avail = 100 - Object.keys(gridData).length;
        if (addCount > avail) { errEl.textContent = `Only ${avail} box${avail !== 1 ? 'es' : ''} available`; errEl.style.display = 'block'; return; }

        isAddMoreMode = true; addMoreOriginalCount = p.boxCount;
        adminActingAsUid = uid; adminActingAsData = p;
        manualSelectMode = true; manualInitials = p.initials; manualBoxTarget = addCount; manualPicks = [];

        switchTab('grid');
        updateSelectBanner();
        document.getElementById('selectBanner').classList.remove('hidden');
        renderGrid();
        document.getElementById('selectBanner').scrollIntoView({ behavior: 'smooth', block: 'start' });
        showToast(`Admin: pick ${addCount} box${addCount > 1 ? 'es' : ''} for ${p.name}`);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ADMIN RESET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    async function resetGrid() {
        if (!await showConfirm('Delete ALL data for this grid? Squares, players, numbers, scores?')) return;
        if (!await showConfirm('REALLY sure? Cannot be undone.')) return;
        await db.ref(`${GAME_REF}/games/${currentGameId}/grid`).remove();
        await db.ref(`${GAME_REF}/games/${currentGameId}/players`).remove();
        await db.ref(`${GAME_REF}/games/${currentGameId}/numbers`).remove();
        await db.ref(`${GAME_REF}/games/${currentGameId}/scores`).remove();
        showToast('Grid reset');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  CELEBRATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function showNextCelebration() {
        if (celebrationQueue.length === 0) { dismissCelebration(); return; }
        const w = celebrationQueue.shift();
        document.getElementById('winQuarter').textContent = w.quarter + ' WINNER';
        document.getElementById('winName').textContent = w.name.split(' ')[0];
        document.getElementById('winInitials').textContent = w.initials;
        document.getElementById('winScore').textContent = `PAT: ${w.pats}  ‚Ä¢  SEA: ${w.hawks}`;
        // Calculate prize
        const payouts = currentGameConfig?.payouts || { q1: 0, q2: 0, q3: 0, q4: 0 };
        const qKey = w.quarter.toLowerCase();
        const qPay = payouts[qKey] || 0;
        const prize = qPay > 0 ? `$${qPay}` : 'üèÜ';
        document.getElementById('winPrize').textContent = prize;
        document.getElementById('winnerOverlay').classList.remove('hidden');
        startConfetti(); playVictorySound();
    }

    function dismissCelebration() {
        document.getElementById('winnerOverlay').classList.add('hidden');
        stopConfetti();
        if (celebrationQueue.length > 0) setTimeout(showNextCelebration, 400);
    }

    // ‚îÄ‚îÄ Confetti ‚îÄ‚îÄ
    function startConfetti() {
        const canvas = document.getElementById('confettiCanvas');
        canvas.classList.remove('hidden');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const ctx = canvas.getContext('2d');
        confettiPieces = [];
        const colors = ['#FFB612', '#C60C30', '#002244', '#69BE28', '#B0B7BC', '#ffffff', '#ff6b6b', '#4ecdc4', '#f39c12', '#9b59b6'];
        for (let i = 0; i < 200; i++) {
            confettiPieces.push({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                w: Math.random() * 10 + 5, h: Math.random() * 6 + 3,
                color: colors[Math.floor(Math.random() * colors.length)],
                vx: (Math.random() - 0.5) * 4, vy: Math.random() * 3 + 2,
                rot: Math.random() * 360, rotSpeed: (Math.random() - 0.5) * 12,
                wobble: Math.random() * Math.PI * 2, wobbleSpeed: Math.random() * 0.1 + 0.02,
            });
        }
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let alive = false;
            confettiPieces.forEach(p => {
                p.x += p.vx + Math.sin(p.wobble) * 0.8; p.y += p.vy;
                p.rot += p.rotSpeed; p.wobble += p.wobbleSpeed; p.vy += 0.02;
                if (p.y < canvas.height + 20) alive = true;
                ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = Math.min(1, Math.max(0, (canvas.height - p.y + 100) / 200));
                ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h); ctx.restore();
            });
            if (alive) confettiAnimId = requestAnimationFrame(animate);
            else stopConfetti();
        }
        confettiAnimId = requestAnimationFrame(animate);
        setTimeout(stopConfetti, 5000);
    }

    function stopConfetti() {
        if (confettiAnimId) { cancelAnimationFrame(confettiAnimId); confettiAnimId = null; }
        const canvas = document.getElementById('confettiCanvas');
        canvas.classList.add('hidden');
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        confettiPieces = [];
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TABS & UTILS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SUPER ADMIN
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let saAllGames = {}; // { gameId: { config, players, gridCount } }
    let saSelectedGameId = null;

    async function openSuperAdmin() {
        if (!currentUser || currentUser.email !== SUPER_ADMIN_EMAIL) return;
        document.getElementById('superAdminOverlay').classList.remove('hidden');
        document.getElementById('saGridInfo').classList.add('hidden');
        document.getElementById('saGridSelect').innerHTML = '<option value="">‚Äî Loading... ‚Äî</option>';
        saSelectedGameId = null;

        // Load ALL games
        const gamesSnap = await db.ref(`${GAME_REF}/games`).once('value');
        const allGames = gamesSnap.val() || {};
        saAllGames = {};

        const sel = document.getElementById('saGridSelect');
        sel.innerHTML = '<option value="">‚Äî Select a grid ‚Äî</option>';

        for (const [gid, data] of Object.entries(allGames)) {
            const conf = data.config;
            if (!conf) continue;
            const playerCount = data.players ? Object.keys(data.players).length : 0;
            const gridCount = data.grid ? Object.keys(data.grid).length : 0;
            saAllGames[gid] = { config: conf, players: data.players || {}, grid: data.grid || {}, gridCount, playerCount };

            const opt = document.createElement('option');
            opt.value = gid;
            opt.textContent = `${conf.gameName || 'Unnamed'} [${conf.code}] ‚Äî ${playerCount} players, ${gridCount}/100 ‚Äî by ${conf.createdByName || '?'}`;
            sel.appendChild(opt);
        }

        if (Object.keys(saAllGames).length === 0) {
            sel.innerHTML = '<option value="">‚Äî No grids exist ‚Äî</option>';
        }
    }

    function saLoadGrid() {
        const gid = document.getElementById('saGridSelect').value;
        const infoEl = document.getElementById('saGridInfo');
        if (!gid || !saAllGames[gid]) { infoEl.classList.add('hidden'); saSelectedGameId = null; return; }

        saSelectedGameId = gid;
        const g = saAllGames[gid];
        infoEl.classList.remove('hidden');

        document.getElementById('saGridName').textContent = g.config.gameName || 'Unnamed';
        const cost = g.config.costPerSquare || 0;
        const adminUid = g.config.createdBy;
        const adminPlayer = g.players[adminUid];
        const adminEmail = adminPlayer?.email || adminUid || '?';
        const modeLabel = (g.config.scoringMode || 'quarters') === 'everyScore' ? 'üèà Every Score' : 'üìä Quarters';
        document.getElementById('saGridMeta').textContent = `Admin: ${g.config.createdByName || '?'} (${adminEmail}) ‚Ä¢ ${modeLabel} ‚Ä¢ ${g.playerCount} players ‚Ä¢ ${g.gridCount}/100 ‚Ä¢ ${cost > 0 ? '$' + cost + '/sq' : 'Free'}`;
        document.getElementById('saGridCode').textContent = g.config.code;

        // Render players
        saRenderPlayers(gid);
    }

    function saRenderPlayers(gid) {
        const g = saAllGames[gid];
        const listEl = document.getElementById('saPlayersList');
        const entries = Object.entries(g.players);

        if (entries.length === 0) {
            listEl.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:0.82rem;text-align:center;">No players</div>';
            return;
        }

        listEl.innerHTML = entries
            .sort((a, b) => (a[1].name || '').localeCompare(b[1].name || ''))
            .map(([uid, p]) => {
                const isCreator = uid === g.config.createdBy;
                return `<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--bg-tertiary);border-radius:8px;margin-bottom:4px;">
                    <span style="background:rgba(102,126,234,0.15);border-radius:4px;padding:2px 8px;font-weight:700;font-size:0.78rem;letter-spacing:1px;color:var(--accent);min-width:36px;text-align:center;">${esc(p.initials)}</span>
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:0.85rem;font-weight:500;">${esc(p.name || '?')}${isCreator ? ' <span style="font-size:0.65rem;color:var(--gold);background:rgba(255,182,18,0.15);padding:1px 5px;border-radius:3px;">CREATOR</span>' : ''}</div>
                        <div style="font-size:0.68rem;color:var(--text-muted);">${esc(p.email || uid)} ‚Ä¢ ${p.boxCount || 0} boxes</div>
                    </div>
                    <button onclick="saKickPlayer('${gid}','${uid}')" style="background:none;border:1px solid rgba(239,68,68,0.3);color:var(--danger);padding:5px 10px;border-radius:6px;font-size:0.7rem;font-weight:600;cursor:pointer;font-family:'Outfit',sans-serif;white-space:nowrap;" title="Remove player and their boxes">Kick</button>
                </div>`;
            }).join('');
    }

    async function saKickPlayer(gid, uid) {
        const g = saAllGames[gid];
        const player = g.players[uid];
        if (!player) return;
        if (!await showConfirm(`Remove ${player.name || uid} (${player.initials}) and all their ${player.boxCount || 0} boxes from "${g.config.gameName}"?`)) return;

        const update = {};
        // Remove player
        update[`${GAME_REF}/games/${gid}/players/${uid}`] = null;
        // Remove their grid cells
        for (const [key, cell] of Object.entries(g.grid)) {
            if (cell.uid === uid) update[`${GAME_REF}/games/${gid}/grid/${key}`] = null;
        }
        // Remove from their game list
        update[`${GAME_REF}/users/${uid}/games/${gid}`] = null;

        await db.ref().update(update);

        // Update local cache
        delete g.players[uid];
        const removedCells = Object.entries(g.grid).filter(([k, c]) => c.uid === uid);
        removedCells.forEach(([k]) => delete g.grid[k]);
        g.playerCount = Object.keys(g.players).length;
        g.gridCount = Object.keys(g.grid).length;

        showToast(`Kicked ${player.name} ‚Äî ${removedCells.length} boxes freed`);
        saRenderPlayers(gid);
        // Update the select option text
        const sel = document.getElementById('saGridSelect');
        const opt = sel.querySelector(`option[value="${gid}"]`);
        if (opt) opt.textContent = `${g.config.gameName || 'Unnamed'} [${g.config.code}] ‚Äî ${g.playerCount} players, ${g.gridCount}/100`;
        // Update meta
        const adminUid2 = g.config.createdBy;
        const adminPlayer2 = g.players[adminUid2];
        const adminEmail2 = adminPlayer2?.email || adminUid2 || '?';
        document.getElementById('saGridMeta').textContent = `Admin: ${g.config.createdByName || '?'} (${adminEmail2}) ‚Ä¢ ${g.playerCount} players ‚Ä¢ ${g.gridCount}/100 filled ‚Ä¢ ${(g.config.costPerSquare || 0) > 0 ? '$' + g.config.costPerSquare + '/sq' : 'Free'}`;
    }

    async function saDeleteGrid() {
        const gid = saSelectedGameId;
        if (!gid || !saAllGames[gid]) return;
        const g = saAllGames[gid];
        if (!await showConfirm(`DELETE "${g.config.gameName}" [${g.config.code}]?\n\nThis removes all players, boxes, numbers, scores. Cannot be undone.`)) return;
        if (!await showConfirm(`REALLY delete "${g.config.gameName}"? Last chance.`)) return;

        const update = {};
        // Remove game data
        update[`${GAME_REF}/games/${gid}`] = null;
        // Remove code lookup
        update[`${GAME_REF}/codes/${g.config.code}`] = null;
        // Remove from all players' game lists
        for (const uid of Object.keys(g.players)) {
            update[`${GAME_REF}/users/${uid}/games/${gid}`] = null;
        }

        await db.ref().update(update);

        showToast(`Deleted "${g.config.gameName}"`);
        delete saAllGames[gid];
        saSelectedGameId = null;
        document.getElementById('saGridInfo').classList.add('hidden');

        // Rebuild select
        const sel = document.getElementById('saGridSelect');
        const opt = sel.querySelector(`option[value="${gid}"]`);
        if (opt) opt.remove();
        sel.value = '';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SUPER ADMIN: TEST MODE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const TEST_PLAYERS = [
        { name: 'Alice Johnson', initials: 'AJ' }, { name: 'Bob Smith', initials: 'BS' },
        { name: 'Carol Davis', initials: 'CD' }, { name: 'Dan Wilson', initials: 'DW' },
        { name: 'Eve Martinez', initials: 'EM' }, { name: 'Frank Lee', initials: 'FL' },
        { name: 'Grace Kim', initials: 'GK' }, { name: 'Hank Brown', initials: 'HB' },
        { name: 'Ivy Chen', initials: 'IC' }, { name: 'Jack Taylor', initials: 'JT' }
    ];

    function saTestStatus(msg) {
        const el = document.getElementById('saTestStatus');
        if (el) el.textContent = msg;
    }

    async function saFillTestPlayers() {
        const gid = saSelectedGameId;
        if (!gid) { showToast('Select a grid first'); return; }
        const g = saAllGames[gid];
        const existingCells = Object.keys(g.grid || {}).length;
        if (existingCells >= 100) { showToast('Grid already full'); return; }
        if (!await showConfirm(`Fill ${100 - existingCells} empty boxes with test players?`)) return;

        saTestStatus('Filling grid...');
        const update = {};
        const emptyCells = [];
        for (let r = 0; r < 10; r++) for (let c = 0; c < 10; c++) {
            const key = `${r}_${c}`;
            if (!g.grid[key]) emptyCells.push(key);
        }

        const shuffleArr = arr => { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; };
        const shuffled = shuffleArr(emptyCells);
        const playerBoxes = {};

        shuffled.forEach((key, i) => {
            const tp = TEST_PLAYERS[i % TEST_PLAYERS.length];
            const uid = `test_${tp.initials.toLowerCase()}`;
            update[`${GAME_REF}/games/${gid}/grid/${key}`] = { uid, initials: tp.initials, name: tp.name };
            if (!playerBoxes[uid]) playerBoxes[uid] = { ...tp, count: 0 };
            playerBoxes[uid].count++;
        });

        for (const [uid, p] of Object.entries(playerBoxes)) {
            const existing = g.players[uid];
            const newCount = (existing?.boxCount || 0) + p.count;
            update[`${GAME_REF}/games/${gid}/players/${uid}`] = { name: p.name, initials: p.initials, boxCount: newCount, email: `${uid}@test.local`, isTest: true };
        }

        await db.ref().update(update);
        const gridSnap = await db.ref(`${GAME_REF}/games/${gid}/grid`).once('value');
        const playSnap = await db.ref(`${GAME_REF}/games/${gid}/players`).once('value');
        g.grid = gridSnap.val() || {};
        g.players = playSnap.val() || {};
        g.gridCount = Object.keys(g.grid).length;
        g.playerCount = Object.keys(g.players).length;

        saTestStatus(`Filled ${shuffled.length} boxes with ${Object.keys(playerBoxes).length} test players`);
        saRenderPlayers(gid);
        saLoadGrid();
    }

    async function saAssignTestNumbers() {
        const gid = saSelectedGameId;
        if (!gid) { showToast('Select a grid first'); return; }
        const shuffleArr = arr => { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; };
        await db.ref(`${GAME_REF}/games/${gid}/numbers`).set({ cols: shuffleArr([0,1,2,3,4,5,6,7,8,9]), rows: shuffleArr([0,1,2,3,4,5,6,7,8,9]) });
        saTestStatus('Numbers assigned!');
        showToast('Test numbers assigned');
    }

    async function saSimulateScore() {
        const gid = saSelectedGameId;
        if (!gid) { showToast('Select a grid first'); return; }
        const g = saAllGames[gid];
        const mode = g.config.scoringMode || 'quarters';

        const numSnap = await db.ref(`${GAME_REF}/games/${gid}/numbers`).once('value');
        const numData = numSnap.val();
        if (!numData?.cols || !numData?.rows) { showToast('Assign numbers first'); return; }

        const gridSnap = await db.ref(`${GAME_REF}/games/${gid}/grid`).once('value');
        const liveGrid = gridSnap.val() || {};

        if (mode === 'everyScore') {
            const evSnap = await db.ref(`${GAME_REF}/games/${gid}/scoreEvents`).once('value');
            const events = evSnap.val() || [];
            const geSnap = await db.ref(`${GAME_REF}/games/${gid}/gameEnded`).once('value');
            if (geSnap.val()) { showToast('Game already ended ‚Äî reopen first'); return; }

            const last = events.length > 0 ? events[events.length - 1] : { patsFull: 0, hawksFull: 0 };
            const scoringPlays = [3, 7, 6, 3, 2, 1, 8];
            const addPts = scoringPlays[Math.floor(Math.random() * scoringPlays.length)];
            const team = Math.random() > 0.5 ? 'pats' : 'hawks';
            const patsFull = team === 'pats' ? last.patsFull + addPts : last.patsFull;
            const hawksFull = team === 'hawks' ? last.hawksFull + addPts : last.hawksFull;
            const pats = patsFull % 10, hawks = hawksFull % 10;
            const seq = events.length + 1;

            const ci = numData.cols.indexOf(pats), ri = numData.rows.indexOf(hawks);
            let winnerName = 'Empty box', winnerInitials = '', winnerUid = null;
            if (ci !== -1 && ri !== -1) {
                const cd = liveGrid[`${ri}_${ci}`];
                if (cd) { winnerName = cd.name; winnerInitials = cd.initials; winnerUid = cd.uid; }
            }

            events.push({ seq, pats, hawks, patsFull, hawksFull, winnerName, winnerInitials, winnerUid, timestamp: Date.now() });
            await db.ref(`${GAME_REF}/games/${gid}/scoreEvents`).set(events);
            saTestStatus(`#${seq}: ${patsFull}-${hawksFull} (${pats},${hawks}) ‚Üí ${winnerUid ? winnerInitials : 'empty'}`);
        } else {
            const scoresSnap = await db.ref(`${GAME_REF}/games/${gid}/scores`).once('value');
            const sc = scoresSnap.val() || { q1: null, q2: null, q3: null, q4: null };
            const next = ['q1','q2','q3','q4'].find(q => !sc[q]);
            if (!next) { showToast('All quarters already scored'); return; }

            const pats = Math.floor(Math.random() * 10);
            const hawks = Math.floor(Math.random() * 10);
            sc[next] = { pats, hawks };
            await db.ref(`${GAME_REF}/games/${gid}/scores`).set(sc);
            saTestStatus(`${next.toUpperCase()}: PAT ${pats}, SEA ${hawks}`);
        }
    }

    async function saSimulateFullGame() {
        const gid = saSelectedGameId;
        if (!gid) { showToast('Select a grid first'); return; }
        const g = saAllGames[gid];
        const mode = g.config.scoringMode || 'quarters';

        if (!await showConfirm(`Simulate full game (${mode === 'everyScore' ? '8-12 score events' : '4 quarters'})? Overwrites existing scores.`)) return;

        const numSnap = await db.ref(`${GAME_REF}/games/${gid}/numbers`).once('value');
        if (!numSnap.val()?.cols) {
            await saAssignTestNumbers();
            await new Promise(r => setTimeout(r, 500));
        }

        const numSnap2 = await db.ref(`${GAME_REF}/games/${gid}/numbers`).once('value');
        const numData = numSnap2.val();
        const gridSnap = await db.ref(`${GAME_REF}/games/${gid}/grid`).once('value');
        const liveGrid = gridSnap.val() || {};

        if (mode === 'everyScore') {
            await db.ref(`${GAME_REF}/games/${gid}/scoreEvents`).remove();
            await db.ref(`${GAME_REF}/games/${gid}/gameEnded`).remove();

            const scoringPlays = [3, 7, 6, 3, 7, 3, 2, 7, 3, 6, 7, 3];
            const numEvents = 8 + Math.floor(Math.random() * 5);
            let patsFull = 0, hawksFull = 0;
            const events = [];

            // Kickoff 0-0
            const ci0 = numData.cols.indexOf(0), ri0 = numData.rows.indexOf(0);
            let w0Name = 'Empty box', w0Init = '', w0Uid = null;
            if (ci0 !== -1 && ri0 !== -1) { const cd = liveGrid[`${ri0}_${ci0}`]; if (cd) { w0Name = cd.name; w0Init = cd.initials; w0Uid = cd.uid; } }
            events.push({ seq: 1, pats: 0, hawks: 0, patsFull: 0, hawksFull: 0, winnerName: w0Name, winnerInitials: w0Init, winnerUid: w0Uid, timestamp: Date.now() });

            for (let i = 1; i < numEvents; i++) {
                const addPts = scoringPlays[Math.floor(Math.random() * scoringPlays.length)];
                if (Math.random() > 0.5) patsFull += addPts; else hawksFull += addPts;
                const pats = patsFull % 10, hawks = hawksFull % 10;
                const ci = numData.cols.indexOf(pats), ri = numData.rows.indexOf(hawks);
                let wName = 'Empty box', wInit = '', wUid = null;
                if (ci !== -1 && ri !== -1) { const cd = liveGrid[`${ri}_${ci}`]; if (cd) { wName = cd.name; wInit = cd.initials; wUid = cd.uid; } }
                events.push({ seq: i + 1, pats, hawks, patsFull, hawksFull, winnerName: wName, winnerInitials: wInit, winnerUid: wUid, timestamp: Date.now() + i * 1000 });
            }

            await db.ref(`${GAME_REF}/games/${gid}/scoreEvents`).set(events);
            await db.ref(`${GAME_REF}/games/${gid}/gameEnded`).set(true);
            saTestStatus(`Simulated ${events.length} events. Final: ${patsFull}-${hawksFull}. Game ended.`);
        } else {
            const sc = {};
            let patsFull = 0, hawksFull = 0;
            ['q1','q2','q3','q4'].forEach(q => {
                const addP = [0, 3, 7, 6, 3, 7][Math.floor(Math.random() * 6)];
                const addH = [0, 3, 7, 6, 3, 7][Math.floor(Math.random() * 6)];
                patsFull += addP; hawksFull += addH;
                sc[q] = { pats: patsFull % 10, hawks: hawksFull % 10 };
            });
            await db.ref(`${GAME_REF}/games/${gid}/scores`).set(sc);
            saTestStatus(`4 quarters done. ${['q1','q2','q3','q4'].map(q => `${q.toUpperCase()}(${sc[q].pats},${sc[q].hawks})`).join(' ')}`);
        }
        showToast('Full game simulated!');
    }

    async function saClearTestData() {
        const gid = saSelectedGameId;
        if (!gid) { showToast('Select a grid first'); return; }
        if (!await showConfirm('Clear ALL test data? Removes test players, their boxes, scores, numbers, and score events.')) return;

        const g = saAllGames[gid];
        const update = {};

        for (const [key, cell] of Object.entries(g.grid || {})) {
            if (cell.uid?.startsWith('test_')) update[`${GAME_REF}/games/${gid}/grid/${key}`] = null;
        }
        for (const uid of Object.keys(g.players || {})) {
            if (uid.startsWith('test_')) {
                update[`${GAME_REF}/games/${gid}/players/${uid}`] = null;
                update[`${GAME_REF}/users/${uid}/games/${gid}`] = null;
            }
        }

        update[`${GAME_REF}/games/${gid}/scores`] = null;
        update[`${GAME_REF}/games/${gid}/numbers`] = null;
        update[`${GAME_REF}/games/${gid}/scoreEvents`] = null;
        update[`${GAME_REF}/games/${gid}/gameEnded`] = null;

        await db.ref().update(update);

        const gridSnap = await db.ref(`${GAME_REF}/games/${gid}/grid`).once('value');
        const playSnap = await db.ref(`${GAME_REF}/games/${gid}/players`).once('value');
        g.grid = gridSnap.val() || {};
        g.players = playSnap.val() || {};
        g.gridCount = Object.keys(g.grid).length;
        g.playerCount = Object.keys(g.players).length;

        saTestStatus('Test data cleared');
        showToast('All test data cleared');
        saRenderPlayers(gid);
        saLoadGrid();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TABS & UTILS (2)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const btn = document.querySelector(`[onclick="switchTab('${t}')"]`);
        if (btn) btn.classList.add('active');
        const tab = document.getElementById(`tab-${t}`);
        if (tab) tab.classList.add('active');
    }

    function esc(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

    function closeOverlay(id) { document.getElementById(id).classList.add('hidden'); }

    function showValidationError(msg) {
        const err = document.getElementById('initialsError');
        const input = document.getElementById('initialsInput');
        err.textContent = msg; err.style.display = 'block';
        input.classList.remove('shake'); void input.offsetWidth; input.classList.add('shake');
        input.focus();
        showToast('‚ö†Ô∏è ' + msg);
    }

    function showToast(msg, dur = 3000, extraClass = '') {
        document.querySelectorAll('.toast').forEach(t => t.remove());
        const t = document.createElement('div');
        t.className = 'toast' + (extraClass ? ' ' + extraClass : '');
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, dur);
    }

    function showConfirm(msg) {
        return new Promise(res => {
            const o = document.createElement('div'); o.className = 'overlay';
            o.innerHTML = `<div class="overlay-card" onclick="event.stopPropagation()" style="max-width:360px">
                <h2 style="color:var(--danger)">Confirm</h2>
                <p style="color:var(--text-secondary);margin:12px 0 20px;font-size:0.9rem">${msg}</p>
                <div style="display:flex;gap:10px">
                    <button class="btn-gold" style="background:var(--bg-tertiary);color:var(--text-secondary);flex:1" id="_cn">Cancel</button>
                    <button class="btn-gold" style="flex:1" id="_cy">Confirm</button>
                </div></div>`;
            document.body.appendChild(o);
            o.querySelector('#_cn').onclick = () => { o.remove(); res(false); };
            o.querySelector('#_cy').onclick = () => { o.remove(); res(true); };
            o.onclick = () => { o.remove(); res(false); };
        });
    }

    </script>
</body>
</html>
